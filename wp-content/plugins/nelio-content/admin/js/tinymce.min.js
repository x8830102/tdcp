var NCTinyMce=NCTinyMce||{};NCTinyMce.shareButtons={},function(){"use strict";NelioContent.helpers.extractShareBlockIds=function(e){return _.uniq(_.flatten(_.map(e,function(e){var n=NelioContent.helpers.getShareBlockId(e);return n.length||(n=NelioContent.helpers.generateUniqueId(),e.className+=" "+n),n})))},NelioContent.helpers.getShareBlockId=function(e){var n=e.className.match(/ncid[0-9a-f]{8}/g);return n=n||[]},NelioContent.helpers.generateUniqueId=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return"ncid"+e()+e()}}(jQuery),tinymce.PluginManager.add("nelio_content",function(e){NCTinyMce.addShareButtons(e),NCTinyMce.addShareBlockLengthCount(e),NCTinyMce.listenToEditorEvents(e)}),NCTinyMce.addShareButtons=function(e){e.addButton("nelio_content",{title:NelioContent.i18n.titles.socialAutomations,type:"menubutton",icon:"nc-share-selection",disabled:!1,onclick:function(){NCTinyMce.fixShareButtons(e)},menu:[NCTinyMce.addButtonForCreatingSocialMessage(e),NCTinyMce.addButtonForCreatingShareBlock(e),NCTinyMce.addButtonForRemovingShareBlocks(e)]})},NCTinyMce.addShareBlockLengthCount=function(n){n.on("init",function(){var e=n.theme.panel&&n.theme.panel.find("#statusbar")[0];e&&e.insert({type:"label",name:"ncsharelength",text:"",classes:"ncshare-length",disabled:n.settings.readonly},0)})},NCTinyMce.addButtonForCreatingSocialMessage=function(t){return{text:NelioContent.i18n.actions.createSocialMessage,disabled:!0,onclick:function(){var e=t.selection.getContent({format:"html"}),n=t.selection.getContent({format:"text"});NCTinyMce.createSocialMessage(n,e)},onPostRender:function(){NCTinyMce.initButton(t,"createSocialMessage",this)}}},NCTinyMce.addButtonForCreatingShareBlock=function(e){return{text:NelioContent.i18n.actions.addShareBlock,disabled:!1,onclick:function(){NCTinyMce.addShareBlock(e)},onPostRender:function(){NCTinyMce.initButton(e,"addShareBlock",this)}}},NCTinyMce.addButtonForRemovingShareBlocks=function(e){return{text:NelioContent.i18n.actions.removeShareBlock,disabled:!1,onclick:function(){NCTinyMce.removeShareBlocks(e)},onPostRender:function(){NCTinyMce.initButton(e,"removeShareBlock",this)}}},NCTinyMce.listenToEditorEvents=function(e){e.on("Change NodeChange KeyUp",_.debounce(function(){NCTinyMce.removeHighlightFromShareBlocks(e),NCTinyMce.maybeHighlightShareBlock(e),NCTinyMce.maybeShowShareBlockLengthCount(e)},100)),e.on("Blur",_.debounce(function(){NCTinyMce.removeHighlightFromShareBlocks(e)}),100),e.on("PastePreProcess",function(){NCTinyMce.changeShareBlockIdsOnPaste(e)})},NCTinyMce.createSocialMessage=function(e,n){if(0!==(e=NelioContent.helpers.trim(e)).length){var t=new NelioContent.models.SocialMessage;t.setPost(NCTinyMce.timelineView.collection.post),t.set("profileId",NelioContent.profiles.at(0).get("id"));var o=NCTinyMce.searchTwitterHandleToMention(n);if(o){var i=o.get("twitter").replace("@","");e=e+" /cc @[twitter:"+i+"]",t.set("mentions",[{network:"twitter",kind:"single",displayName:o.get("author")||"@"+i,displayMentionEscaped:_.escape("@"+i),username:i,link:"https://twitter.com/"+i}])}t.set("text",e+" {permalink}");var c=new NelioContent.views.SocialMessageEditor({model:t});c.disableProfiles(NCTinyMce.timelineView.collection.getDisabledProfileIds()),Backbone.listenToOnce(c,"nc:add:messages",function(e){NCTinyMce.timelineView.collection.add(e)}),c.render()}},NCTinyMce.searchTwitterHandleToMention=function(e){if(!_.contains(NelioContent.profiles.pluck("network"),"twitter"))return!1;for(var n=NelioContent.helpers.extractReferences(e),t=0;t<n.length;++t){var o,i=n[t];if((o=NCTinyMce.suggestedReferences.get(i))&&o.get("twitter"))return o;if((o=NCTinyMce.externalReferences.get(i))&&o.get("twitter"))return o}return!1},NCTinyMce.initButton=function(e,n,t){void 0===NCTinyMce.shareButtons[e.id]&&(NCTinyMce.shareButtons[e.id]={}),NCTinyMce.shareButtons[e.id][n]=t,NCTinyMce.fixShareButtons(e)},NCTinyMce.fixShareButtons=function(e){var n=e.selection.getContent({format:"text"}),t=0<NelioContent.helpers.trim(n.length),o=NCTinyMce.shareButtons[e.id];if(o.createSocialMessage&&o.createSocialMessage.disabled(!t),o.addShareBlock&&o.addShareBlock.disabled(!t),o.removeShareBlock){var i=0<NCTinyMce.getSelectedShareBlocks(e).length;o.removeShareBlock.disabled(!i)}},NCTinyMce.addShareBlock=function(e){var n=NelioContent.helpers.generateUniqueId();e.formatter.register("ncshare",{inline:"ncshare",classes:n}),e.formatter.apply("ncshare"),e.formatter.unregister("ncshare"),e.selection.collapse()},NCTinyMce.removeShareBlocks=function(e){var n=NCTinyMce.getSelectedShareBlocks(e);if(n.length){0===e.selection.getContent({format:"text"}).length&&(n=[n[0]]),n=_.map(n,function(e){return"ncshare."+e});var t=e.dom.select(n.join(","));e.dom.remove(t,!0),e.selection.collapse()}},NCTinyMce.getSelectedShareBlocks=function(e){var n=document.createElement("div");n.innerHTML=e.selection.getContent();var t=_.union(_.map(n.querySelectorAll("ncshare")),NCTinyMce.findAncestorShareBlocks(e.selection.getNode()));return NelioContent.helpers.extractShareBlockIds(t)},NCTinyMce.findAncestorShareBlocks=function(e){for(var n=[];e;)"ncshare"===e.nodeName.toLowerCase()&&n.push(e),e=e.parentNode;return n},NCTinyMce.maybeHighlightShareBlock=function(e){if(!(0<e.selection.getContent({format:"text"}).length)){var n=NCTinyMce.getSelectedShareBlocks(e);if((n=_.map(n,function(e){return"ncshare."+e})).length){e.dom.select(n[0]).forEach(function(e){e.className+=" nc-has-caret nc-first"});for(var t=1;t<n.length;++t){e.dom.select(n[t]).forEach(function(e){e.className+=" nc-has-caret"})}}}},NCTinyMce.removeHighlightFromShareBlocks=function(e){e.dom.select("ncshare.nc-has-caret").forEach(function(e){var n=e.className;n=(n=n.replace(/nc-has-caret/g,"")).replace(/nc-first/g,""),e.className=NelioContent.helpers.trim(n)})},NCTinyMce.changeShareBlockIdsOnPaste=function(e){var n=document.createElement("div");n.innerHTML=e.content;var t=_.map(n.querySelectorAll("ncshare")),o=NelioContent.helpers.extractShareBlockIds(t),i=_.map(o,function(){return NelioContent.helpers.generateUniqueId()});t.forEach(function(e){for(var n=e.className,t=0;t<o.length;++t)n=n.replace(o[t],i[t]);e.className=n}),e.content=n.innerHTML},NCTinyMce.maybeShowShareBlockLengthCount=function(e){var n=e.theme.panel.find("#ncsharelength");if(n){var t=e.selection.getContent({format:"text"});if(t.length)return n.text([NelioContent.i18n.feedback.selectionLength,t.length]),void n.show();var o=NCTinyMce.getSelectedShareBlocks(e);if(o.length){var i=e.dom.select("ncshare."+o[0]),c=_.reduce(i,function(e,n){return e+=n.textContent||n.innerText},"");return c+=" https://example.com",n.text([NelioContent.i18n.feedback.shareBlockLength,NelioContent.helpers.getTweetLength(c)]),void n.show()}n.hide()}};