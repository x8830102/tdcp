!function(n){"use strict";NelioContent.models.FeaturedImage=Backbone.Model.extend({_img:void 0,defaults:{alt:"",thumbnailId:0,url:"",temporalUrl:"",checkingUrl:!1,isUrlValid:!1,mode:"none"},initialize:function(){this._checkTemporalUrl=_.bind(this._checkTemporalUrl,this),this._commitTemporalUrl=_.bind(this._commitTemporalUrl,this),this._discardTemporalUrl=_.bind(this._discardTemporalUrl,this),this.set("temporalUrl",this.get("url")),this.listenTo(this,"change:temporalUrl",_.debounce(this._checkTemporalUrl,200)),this._checkTemporalUrl()},_checkTemporalUrl:function(){void 0!==this._img&&(this._img.onload=!1,this._img.onerror=!1),this.set("checkingUrl",!0),this._img=new Image,this._img.onload=this._commitTemporalUrl,this._img.onerror=this._discardTemporalUrl,this._img.src=this.get("temporalUrl")},_commitTemporalUrl:function(){this.set("checkingUrl",!1),this.set("url",this.get("temporalUrl")),this.set("isUrlValid",!0)},_discardTemporalUrl:function(){this.set("checkingUrl",!1),this.set("url",this.get("temporalUrl")),this.set("isUrlValid",!1)}}),NelioContent.views.ExternalFeaturedImageDialog=Backbone.View.extend({_buttons:void 0,_regex:{url:/^(https?:\/\/)?([\da-z\.-]+)\.([a-z]{2,6})(\/[^\/\s]+)*\/?$/i,date:/[12][0-9][0-9][0-9]-[01][0-9]-[0-3][0-9]/,time:/[012][0-9]:[0-5][0-9]/},_originalModel:void 0,template:NelioContent.helpers.getTemplate("_nc-external-featured-image-dialog"),events:{"change .nc-url input":"_onUrlChange","keyup .nc-url input":"_onUrlChange","change .nc-alt input":"_onAltChange","keyup .nc-alt input":"_onAltChange"},initialize:function(){this.render=_.bind(this.render,this),this._onDialogSave=_.bind(this._onDialogSave,this),this._onDialogCancel=_.bind(this._onDialogCancel,this),this.listenTo(this,"nc:render",this.render),this._originalModel=this.model,"efi"===this.model.get("mode")?this.model=new NelioContent.models.FeaturedImage(this.model.toJSON()):(this.model=new NelioContent.models.FeaturedImage,this.model.set("mode","efi")),this.listenTo(this.model,"change:url",this._maybeEnableSaveButton),this.listenTo(this.model,"change:alt",this._maybeEnableSaveButton),this.listenTo(this.model,"change:checkingUrl",this._maybeShowSpinner),this.listenTo(this.model,"change:url",this._maybeShowPreview),this.listenTo(this.model,"change:isUrlValid",this._maybeShowPreview),this.listenTo(this.model,"change:isUrlValid",this._maybeEnableSaveButton),this._convertToDialog()},render:function(){return this.el.innerHTML=this.template(this.model.toJSON()),n("body").addClass("modal-open"),this.$el.dialogS2("open"),this._maybeShowSpinner(),this._maybeShowPreview(),this._maybeEnableSaveButton(),this},_lock:function(){this.$("*").attr("disabled","disabled"),this.$el.addClass("nc-locked")},_unlock:function(){this.$("*").removeAttr("disabled"),this.$el.removeClass("nc-locked")},_convertToDialog:function(){var e=[];e.push(NelioContent.helpers.makeDialogCancelButton(this,NelioContent.i18n.actions.cancel)),e.push(NelioContent.helpers.makeDialogSaveButton(this,NelioContent.i18n.actions.save));var i=this;this.$el.dialogS2({title:NelioContent.i18n.titles.externalFeaturedImage,autoOpen:!1,buttons:e,dialogClass:"nc-dialog nc-external-featured-dialog",draggable:!1,modal:!0,resizable:!1,width:n(window).width()-40,height:n(window).height()-60,open:function(){i.listenTo(i,"nc:click:dialog:save",i._onDialogSave),i.listenTo(i,"nc:click:dialog:cancel",i._onDialogCancel),i.listenTo(i,"nc:click:dialog:close",i._onDialogCancel),i._buttons=i._buttons||{},i._buttons.close=i.$el.parent().find("button.nc-close-button"),i._buttons.cancel=i.$el.parent().find("button.nc-cancel-button"),i._buttons.save=i.$el.parent().find("button.nc-save-button"),NelioContent.helpers.makeWarningTooltip(i._buttons.save)},close:function(e,t){i.stopListening(i,"nc:click:dialog:save",i._onDialogSave),i.stopListening(i,"nc:click:dialog:cancel",i._onDialogCancel),i.stopListening(i,"nc:click:dialog:close",i._onDialogDelete),i._buttons.save.tooltip("destroy"),n("body").removeClass("modal-open"),i.$el.dialogS2("destroy"),i.trigger("nc:close:dialog")}})},_maybeShowSpinner:function(){this.model.get("checkingUrl")?this.$(".spinner").addClass("is-active"):this.$(".spinner").removeClass("is-active")},_maybeShowPreview:function(){this.model.get("isUrlValid")?(this.$(".nc-image img").attr("src",this.model.get("url")),this.$(".nc-image").show()):this.$(".nc-image").hide()},_maybeEnableSaveButton:function(){if(void 0!==this._buttons.save){if(this._buttons.save.tooltip("close"),0===this.model.get("url").length&&!this._regex.url.test(this._suggestedReference))return this._buttons.save.addClass("button-disabled"),void this._buttons.save.attr("title",NelioContent.i18n.errors.featuredImage.emptyUrl);if(!this._regex.url.test(this.model.get("url")))return this._buttons.save.addClass("button-disabled"),void this._buttons.save.attr("title",NelioContent.i18n.errors.featuredImage.invalidUrl);if(!this.model.get("isUrlValid"))return this._buttons.save.addClass("button-disabled"),void this._buttons.save.attr("title",NelioContent.i18n.errors.featuredImage.unableToLoadUrl);this._buttons.save.removeClass("button-disabled"),this._buttons.save.attr("title","")}},_onUrlChange:function(e){var t=e.target||e.srcElement,i=n(t);this.model.set("temporalUrl",NelioContent.helpers.trim(i.val()))},_onAltChange:function(e){var t=e.target||e.srcElement,i=n(t);this.model.set("alt",i.val())},_onDialogSave:function(){var e=this.$el.parent(),t=e.find(".ui-dialog-buttonpane button.nc-save-button");e.find(".ui-dialog-titlebar button, .ui-dialog-buttonpane button:not( .nc-save-button )");t.hasClass("button-disabled")||(this._originalModel.set(this.model.toJSON()),this.$el.dialogS2("close"))},_onDialogCancel:function(){this.$el.dialogS2("close")},close:function(){this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.FeaturedImage=Backbone.View.extend({template:NelioContent.helpers.getTemplate("_nc-featured-image"),events:{"click .nc-set-wp":"_openMediaLibrarySelector","click .nc-set-efi":"_openExternalImageDialog","click .nc-edit-wp":"_openMediaLibrarySelector","click .nc-edit-efi":"_openExternalImageDialog","click .nc-remove-featured-image":"_removeFeaturedImage"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this.model,"change",this.render)},render:function(){return this.el.innerHTML=this.template(this.model.toJSON()),this},_removeFeaturedImage:function(e){e.preventDefault(),this.model.set({thumbnailId:0,url:"",alt:"",mode:"none"})},_openMediaLibrarySelector:function(e){var t;e.preventDefault(),"wp"===this.model.get("mode")&&this.model.get("thumbnailId")&&(t=this.model.get("thumbnailId"));var i=this.model;NelioContent.helpers.selectImage({image:t,onSelection:function(e){i.set("url",e.url),i.set("alt",e.alt),i.set("thumbnailId",e.id),i.set("mode","wp")}})},_openExternalImageDialog:function(e){e.preventDefault(),new NelioContent.views.ExternalFeaturedImageDialog({model:this.model}).render()},close:function(){0<this._discardPendingTimeout&&(clearTimeout(this._discardPendingTimeout),this._discardPendingTimeout=0),this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}});var e=new NelioContent.models.FeaturedImage({mode:n("#nc-feat-image-mode").val(),url:n("#nc-feat-image-url").val(),alt:n("#nc-feat-image-alt").val(),thumbnailId:n("#nc-feat-image-thumbnail-id").val()}),t=new NelioContent.views.FeaturedImage({model:e});n("#nc-featured-image-container").html(t.render().el),e.listenTo(e,"change:url",function(){Backbone.trigger("nc:change:featuredImage",e)})}(jQuery);