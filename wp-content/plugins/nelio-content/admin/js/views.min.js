!function(l){"use strict";NelioContent.views.SocialMessageEditor=Backbone.View.extend({_rendered:!1,_views:{actualEditor:void 0,profileSelector:void 0,dateSelector:void 0,timeSelector:void 0,preview:void 0},_isPreviewVisible:!0,_$window:void 0,_$saveButton:void 0,_closeAndDestroy:!0,template:NelioContent.helpers.getTemplate("_nc-social-message-editor"),initialize:function(){this._$window=l(window),this.render=_.bind(this.render,this),this._onDialogSave=_.bind(this._onDialogSave,this),this._onDialogCancel=_.bind(this._onDialogCancel,this),this._onDialogDelete=_.bind(this._onDialogDelete,this),this._views.actualEditor=new NelioContent.views.SocialMessageActualEditor({model:this.model}),this.listenTo(this._views.actualEditor,"nc:click:preview",this._togglePreviewVisibility),this.listenTo(this._views.actualEditor,"nc:click:addImage",this._addImage),this.listenTo(this._views.actualEditor,"nc:click:useOldMessage",this._useOldMessage),this._views.actualEditor.isPreviewVisible(this._isPreviewVisible),this._views.dateSelector=new NelioContent.views.DateSelector({model:this.model}),this._views.timeSelector=new NelioContent.views.TimeSelector({model:this.model}),this.model.isNew()?1<NelioContent.profiles.length?this._views.profileSelector=new NelioContent.views.MultipleProfileSelector({model:this.model}):NelioContent.profiles.at(0).allowsMultiTargets()?this._views.profileSelector=new NelioContent.views.MultipleProfileSelector({model:this.model}):this._views.profileSelector=new NelioContent.views.SingleProfileSelector({model:this.model}):this._views.profileSelector=new NelioContent.views.SingleProfileSelector({model:this.model}),this._isPreviewVisible="visible"===ncstore.get("nc-preview["+NelioContent.wpBlogId+"]","visible"),this._isPreviewVisible&&this._selectAppropriatePreviewView(),this._convertToDialog(),this.listenTo(this.model,"change:network",this._selectAppropriatePreviewView),this.listenTo(this.model,"change",this._maybeEnableSaveButton),this.listenTo(this.model,"nc:load:post",this.render),this.listenTo(this.model,"nc:error:post",this._unableToLoadPost)},render:function(){if(0<this.model.get("postId")&&0===this.model.post.get("id"))return this.model.loadPost(),this.el.innerHTML='<div class="nc-social-message-editor"><div class="nc-loading-container"><span class="spinner is-active"></span><div class="nc-loading">'+NelioContent.i18n.feedback.loadingNoSpinner+"</div></div></div>",this.$el.parent().find("button.nc-save-button").addClass("button-disabled"),this;if(this._rendered)return this;this._rendered=!0;var e=this.model.toJSON();return this.el.innerHTML=this.template(e),this.$(".nc-editor").html(this._views.actualEditor.render().$el),void 0!==this._views.profileSelector&&this.$(".nc-profile-selector").html(this._views.profileSelector.render().$el),this.$(".nc-date").html(this._views.dateSelector.render().$el),this.$(".nc-time").html(this._views.timeSelector.render().$el),NelioContent.helpers.isSubscribed()||(this._views.dateSelector.lock(),this._views.timeSelector.lock()),this.model.isNew()?1<NelioContent.profiles.length?this.$(".nc-profile-selector").addClass("nc-multiple"):NelioContent.profiles.at(0).allowsMultiTargets()?this.$(".nc-profile-selector").addClass("nc-multiple"):(this.$(".nc-profile-selector").addClass("nc-single"),this.$(".nc-profile-selector").addClass("nc-profile-hidden")):1!==NelioContent.profiles.length&&NelioContent.helpers.isSubscribed()?this.$(".nc-profile-selector").addClass("nc-single"):(this.$(".nc-profile-selector").addClass("nc-single"),this.$(".nc-profile-selector").addClass("nc-profile-hidden")),this._isPreviewVisible&&this._addPreview(),this._maybeEnableSaveButton(),this},disableProfiles:function(e){"function"==typeof this._views.profileSelector.disableProfiles&&this._views.profileSelector.disableProfiles(e)},_lock:function(){this.$el.addClass("nc-locked"),this._views.actualEditor.lock(),this._views.profileSelector.lock(),this._views.dateSelector.lock(),this._views.timeSelector.lock()},_selectAppropriatePreviewView:function(){if(this._isPreviewVisible){var e=NelioContent.profiles.get(this.model.get("profileId"));void 0===e&&(e=NelioContent.profiles.at(0),this.model.set("profileId",e.get("id")));var t=_.findWhere(NelioContent.networkMetas,{id:e.get("network")});void 0===t&&(t=NelioContent.networkMetas[0]);var i=NelioContent.views[t.previewClassName];this._removePreview(),this._views.preview=new i({model:this.model}),this._addPreview()}},_addPreview:function(){this.$(".nc-social-preview").html(this._views.preview.render().$el)},_removePreview:function(){"object"==typeof this._views.preview&&(this._views.preview.close(),this._views.preview=!1)},_togglePreviewVisibility:function(){this._isPreviewVisible=!this._isPreviewVisible,this._isPreviewVisible?ncstore.set("nc-preview["+NelioContent.wpBlogId+"]","visible"):ncstore.set("nc-preview["+NelioContent.wpBlogId+"]","hidden"),this._views.actualEditor.isPreviewVisible(this._isPreviewVisible),this._views.actualEditor.render(),this._isPreviewVisible?(this._selectAppropriatePreviewView(),this._addPreview()):this._removePreview()},_convertToDialog:function(){var e=[];e.push(NelioContent.helpers.makeDialogCancelButton(this,NelioContent.i18n.actions.cancel)),e.push(NelioContent.helpers.makeDialogSaveButton(this,NelioContent.i18n.actions.save)),this.model.isNew()||e.push(NelioContent.helpers.makeDialogDeleteButton(this,NelioContent.i18n.actions.delLabel));var t=this;this.$el.dialogS2({title:t.model.isNew()?NelioContent.i18n.titles.newMessage:NelioContent.i18n.titles.editMessage,buttons:e,draggable:!1,modal:!0,resizable:!1,width:Math.min(600,t._$window.width()-40),dialogClass:"nc-dialog",position:{my:"center top",at:"center top+60"},open:function(){t.listenTo(t,"nc:click:dialog:save",t._onDialogSave),t.listenTo(t,"nc:click:dialog:cancel",t._onDialogCancel),t.listenTo(t,"nc:click:dialog:delete",t._onDialogDelete),t._$saveButton=t.$el.parent().find("button.nc-save-button"),NelioContent.helpers.makeWarningTooltip(t._$saveButton);var e=t.$el.parent().find("button.nc-delete-button");0<e.length&&e.blur()},close:function(){t.stopListening(t,"nc:click:dialog:save",t._onDialogSave),t.stopListening(t,"nc:click:dialog:cancel",t._onDialogCancel),t.stopListening(t,"nc:click:dialog:delete",t._onDialogDelete),t._$saveButton.tooltip("destroy"),t._$saveButton=void 0,t._closeAndDestroy&&(t.$el.dialogS2("destroy"),t.trigger("nc:close:dialog"))}})},_maybeEnableSaveButton:function(){if(void 0!==this._$saveButton){this._$saveButton.tooltip("close");var e=this.model.isSomethingMissing();e?(this._$saveButton.addClass("button-disabled",!0),this._$saveButton.attr("title",e)):(this._$saveButton.removeClass("button-disabled",!1),this._$saveButton.attr("title",""))}},_addImage:function(){var e;this._closeAndDestroy=!1,this.$el.dialogS2("close"),0<this.model.get("imageId")?e=this.model.get("imageId"):0<this.model.post.get("imageId")&&(e=this.model.post.get("imageId"));var s=this;NelioContent.helpers.selectImage({image:e,onSelection:function(e){var t=(e=e||{}).url||"",i=e.id||0;0<i&&0<t.length?(s.model.set("type","image"),s.model.set("image",t),s.model.set("imageId",i)):(s.model.set("type","text"),s.model.set("image",""),s.model.set("imageId",0)),this.onClose()},onClose:function(){setTimeout(function(){s.$el.dialogS2("open"),s._closeAndDestroy=!0,s._maybeEnableSaveButton()},0)}})},_useOldMessage:function(){var s=this,o=l("<div>"+NelioContent.i18n.feedback.loading+"</div>"),e={title:NelioContent.i18n.titles.reusePreviousMessage,modal:!0,width:Math.min(500,l(window).width()-20),dialogClass:"nc-dialog",closeOnEscape:!1,resizable:!1,buttons:[NelioContent.helpers.makeDialogButton(s,"select","OK",!0)],position:{my:"center top",at:"center top+70"}};e.buttons[0].class="button button-primary button-disabled",o.dialog(e),l.ajax({url:NelioContent.apiUri+"/post/"+s.model.post.get("id")+"/items",method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},success:function(e){var i=_.map(e.social,function(t){return _.each(t.mentions,function(e){"facebook"===e.network&&(t.textComputed=t.textComputed.replace(new RegExp("@\\["+e.networkId+"\\]","g"),e.displayName))}),t}),t=_.uniq(_.pluck(i,"textComputed"));i=_.map(t,function(t){return _.filter(i,function(e){return e.textComputed===t})[0]}),s._selectOldMessage(i),o.dialog("close")},error:function(){s._selectOldMessage([])}})},_selectOldMessage:function(i){var s=this,e={title:NelioContent.i18n.titles.reusePreviousMessage,modal:!0,width:Math.min(500,l(window).width()-20),closeOnEscape:!1,resizable:!1,buttons:[NelioContent.helpers.makeDialogButton(s,"select",NelioContent.i18n.actions.ok,!0)],position:{my:"center top",at:"center top+70"}};if(i.length){var t="<div>";t+="<p><strong>"+NelioContent.i18n.dialogs.reusePreviousMessage+"</strong></p>",t+='<p><input type="radio" name="message" value="0" checked="checked">'+_.escape(i[0].textComputed)+"</p>";for(var o=1;o<i.length;++o)t+='<p><input type="radio" name="message" value="'+o+'">'+_.escape(i[o].textComputed)+"</p>";var n=l(t+="</div>");e.dialogClass="nc-dialog nc-use-old-message",e.buttons[0].click=function(){var e=n.find('input[type="radio"][name="message"]:checked').val(),t=i[e]||{text:"{title} {permalink}",mentions:[]};s.model.set("text",t.text),s.model.set("mentions",t.mentions),s._views.actualEditor.render(),n.dialog("close")},n.dialog(e)}else{var a=l("<div>"+NelioContent.i18n.feedback.noOldMessages+"</div>");e.dialogClass="nc-dialog",e.buttons[0].click=function(){a.dialog("close")},a.dialog(e)}},_onDialogSave:function(){if(!this.model.isSomethingMissing()){var e=this.$el.parent(),t=e.find(".ui-dialog-buttonpane button.button-primary"),i=e.find(".ui-dialog-titlebar button, .ui-dialog-buttonpane button:not( .button-primary )");this._lock(),this.$el.dialogS2("option","closeOnEscape",!1),t.prop("disabled",!0),i.prop("disabled",!0),t.html(NelioContent.i18n.feedback.saving);var s=this;this.model.save(void 0,{success:function(e,t){s.model.isNew()?(t.forEach(function(e){e.source=e.source||void 0}),s.trigger("nc:add:messages",t)):(t.source=t.source||void 0,s.trigger("nc:update:message",t)),s.$el.dialogS2("close")},error:function(e){s.$el.dialogS2("close")}})}},_onDialogCancel:function(){this.$el.dialogS2("close")},_onDialogDelete:function(){var i=this,s=NelioContent.helpers.openDeletionConfirmationDialog(NelioContent.i18n.titles.delSocialMessage,NelioContent.i18n.dialogs.deleteSocialMessage,NelioContent.i18n.actions.doDeleteSocial,function(){var e=s.parent();e.find(".nc-super-delete-button").html(NelioContent.i18n.feedback.deleting),e.find("button").prop("disabled",!0),i.model.destroy({success:function(e,t){s.dialog("destroy"),i.trigger("nc:delete:message",i.model),i.$el.dialogS2("close")}})})},_unableToLoadPost:function(e){this.$el.dialogS2("close"),this.close();var t=NelioContent.i18n.errors.socialMessage.unableToLoadPost;t=t.replace("{error}",e),NelioContent.helpers.openErrorDialog(e)},close:function(){_.each(_.values(this._views),function(e){"object"==typeof e&&"function"==typeof e.close&&e.close()}),this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.SocialMessageActualEditor=Backbone.View.extend({_isLocked:!1,_isPreviewVisible:void 0,_awaitingImageDeletionConfirmation:!1,_relatedPostMode:"hide-related-post",_$postSelectorDiv:void 0,template:NelioContent.helpers.getTemplate("_nc-social-message-actual-editor"),events:{"click .nc-action.nc-preview":"_triggerPreviewEvent","click .nc-action.nc-add.nc-image":"_addImage","click .nc-action.nc-remove.nc-image":"_removeImage","click .nc-do-remove":"_doRemoveImage","click .nc-cancel-remove":"_hideRemoveConfirmation","click .nc-action.nc-use-old-message":"_useOldMessage","click .nc-post-selector a":"_createRelatedPostSelector","change .nc-social-message":"_changeText","keyup  .nc-social-message":"_changeText"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this._searchProfilesToMention=_.bind(_.debounce(this._searchProfilesToMention,500),this),this.listenTo(this.model,"change:text",this.render),this.listenTo(this.model,"change:type",this.render),this.listenTo(this.model,"change:postId",this.render),this.listenTo(this.model,"change:network",this._initAtWhoSearches),this.listenTo(this.model,"change:network",this._updateCharCount),this.listenTo(this.model,"change:profiles",this._updateCharCount),this.listenTo(this.model,"change:network",this._highlightMentions),this.model.isNew()?this.listenTo(this.model,"change:profiles",this._highlightMentions):this.listenTo(this.model,"change:profileId",this._highlightMentions),this.listenTo(this,"nc:use:profile",_.bind(this.model.addNewMention,this.model)),this._awaitingImageDeletionConfirmation=!1,this.model.isNew()?0===this.model.get("postId")&&void 0!==NelioContent.lastPublishedPost?this._relatedPostMode="show-post-selector-action":this._relatedPostMode="hide-related-post":0===this.model.get("postId")?this._relatedPostMode="no-related-post":this._relatedPostMode="show-related-post"},render:function(){void 0!==this._$postSelectorDiv&&this._$postSelectorDiv.detach();var e=this.model.toJSON();return e.isPreviewVisible=this._isPreviewVisible,e.awaitingDeletionConfirmation=this._awaitingImageDeletionConfirmation,e.relatedPostMode=this._relatedPostMode,e.postEditLink=this.model.post.get("editLink"),e.postTitleFormatted=this.model.post.get("titleFormatted"),e.hasPost=0!==this.model.post.get("id"),this.$(".nc-social-message").atwho("destroy"),this.el.innerHTML=this.template(e),this.$(".nc-social-message")[0].innerHTML=this.model.getEditableHtmlText(),this.$(".nc-social-message")[0].addEventListener("paste",this._clearFormatOnPaste),this.$(".nc-social-message")[0].addEventListener("keydown",function(e){e.stopPropagation()}),this._initAtWhoSearches(),this._highlightMentions(),this._updateCharCount(),"show-post-selector"===this._relatedPostMode&&this.$(".nc-post-selector-container").html(this._$postSelectorDiv),this},isPreviewVisible:function(e){this._isPreviewVisible=e},lock:function(){this._isLocked=!0,this.$("textarea").prop("disabled",!0),this.$(".nc-post-selector a").css("color","grey"),this._$postSelectorDiv&&this._$postSelectorDiv.find("select").attr("disabled","disabled")},_initAtWhoSearches:function(){var e,t=this.$(".nc-social-message");if(t.atwho("destroy"),"twitter"===this.model.get("network")){e=NelioContent.i18n.titles.searchMentionOnTwitter;var i=NelioContent.helpers.getTemplate("_nc-mention-in-editor")({network:this.model.get("network"),networkId:"${networkId}",username:"${username}",displayMentionEscaped:"${displayMentionEscaped}"});t.atwho({at:"@",acceptSpaceBar:!1,lookUpOnClick:!1,limit:20,maxLen:20,minLen:2,searchKey:"displayMentionEscaped",headerTpl:'<div class="atwho-header">'+e+"</div>",displayTpl:NelioContent.helpers.getTemplate("_nc-mention-search-result")(),insertTpl:i,editorView:this,callbacks:{remoteFilter:this._searchProfilesToMention,filter:null,sorter:null}})}},_highlightMentions:function(){var e=!1,t=!1,i=_.map(_.pluck(this.model.get("profiles"),"id"),function(e){var t=NelioContent.profiles.get(e);return t?t.toJSON():{}}),s=this.model.get("network");t=this.model.isNew()?(e="facebook"===s&&_.where(i,{network:"facebook",kind:"page"}).length,"twitter"===s&&_.where(i,{network:"twitter"}).length):(e="facebook"===s&&"page"===this.model.get("networkKind"),"twitter"===s);var o=this.$(".nc-social-message");o[0].className=t?"nc-social-message nc-twitter-selected":e?"nc-social-message nc-facebook-page-selected":"nc-social-message"},_triggerPreviewEvent:function(){this._isLocked||this.trigger("nc:click:preview")},_changeText:function(e){if(!this._isLocked){var t=e.target.cloneNode(!0)||e.srcElement.cloneNode(!0);_.each([].slice.call(t.querySelectorAll(".nc-mention")),function(e){e.innerHTML=e.getAttribute("data-mention")}),this.el.appendChild(t);var i=t.innerText;this.el.removeChild(t),this.stopListening(this.model,"change:text",this.render),this.model.set("text",NelioContent.helpers.trim(i)),this.listenTo(this.model,"change:text",this.render),this._updateCharCount()}},_updateCharCount:function(){if(!this._isLocked){var e=this.$(".nc-message-length"),t=this.$(".nc-char-count"),i=this.$(".nc-circle-arc"),s=this.model.getMaxTextLength()-this.model.getTextLength(),o=Math.min(1,this.model.getTextLength()/this.model.getMaxTextLength());t.text(Math.min(99,Math.abs(s))),i.css("stroke-dashoffset",50.2655*(1-o)),e.removeClass("nc-warning"),e.removeClass("nc-danger"),s<=0?(e.addClass("nc-danger"),i.addClass("nc-pulse")):(s<=20&&e.addClass("nc-warning"),i.removeClass("nc-pulse"))}},_addImage:function(){this._isLocked||this.trigger("nc:click:addImage")},_useOldMessage:function(){this._isLocked||this.model.post.get("id")&&this.trigger("nc:click:useOldMessage")},_removeImage:function(){this._isLocked||(this._awaitingImageDeletionConfirmation=!0,this.trigger("nc:render"))},_doRemoveImage:function(){this._isLocked||(this.model.set("type","text"),this.model.set("image",""),this.model.set("imageId",0),this._hideRemoveConfirmation())},_hideRemoveConfirmation:function(){this._isLocked||(this._awaitingImageDeletionConfirmation=!1,this.trigger("nc:render"))},_createRelatedPostSelector:function(e){if(e.preventDefault(),!this._isLocked){var t=l("<select></select>");this._$postSelectorDiv=l("<div></div>"),this._$postSelectorDiv.html(t),this.$(".nc-post-selector-container").html(this._$postSelectorDiv);var i=NelioContent.lastPublishedPost.toJSON();i.text=i.titleFormatted;var s=this,o=NelioContent.helpers.getTemplate("_nc-post-result");return t.ncselect2({width:"70%",dropdownCssClass:"nc-ncselect2-above-jquery-dialog nc-post-selector-in-message-editor",data:[i],ajax:{url:ajaxurl,dataType:"json",delay:250,data:function(e){return{action:"nelio_content_get_posts",term:e.term,page:e.page,status:"publish"}},processResults:function(e,t){t.page=t.page||1;for(var i=0;i<e.items.length;++i)e.items[i].title=NelioContent.helpers.decodeHTMLEntities(e.items[i].titleFormatted),e.items[i].excerpt=NelioContent.helpers.decodeHTMLEntities(e.items[i].excerptFormatted),e.items[i].titleFormatted=_.escape(e.items[i].title),e.items[i].excerptFormatted=_.escape(e.items[i].excerpt),e.items[i].authorNameFormatted=_.escape(e.items[i].authorName),e.items[i].text=e.items[i].titleFormatted;return{results:e.items,pagination:{more:e.more}}},cache:!1},templateResult:function(e){return void 0===e.titleFormatted?e.text:l(o(e))},templateSelection:function(e){if(void 0!==e.titleFormatted){var t=new NelioContent.models.Post({id:e.id,author:e.author,date:e.date,excerptFormatted:e.excerptFormatted,image:e.image,imageId:e.imageId,permalink:e.permalink,editLink:e.editLink,status:e.status,titleFormatted:e.titleFormatted});s.stopListening(s.model,"change:postId",s.render),s.model.setPost(t);var i=s.model.get("text");-1===i.indexOf("{permalink}")&&s.model.set("text",i+" {permalink}"),s.listenTo(s.model,"change:postId",s.render)}return e.text}}),this._relatedPostMode="show-post-selector",this.trigger("nc:render"),!1}},_clearFormatOnPaste:function(e){e.preventDefault();var t=e.clipboardData.getData("text/html"),i=e.clipboardData.getData("text/plain");t&&t.length&&(t=t.replace(/\r?\n/g,""),i=NelioContent.helpers.htmlToText(t),i=NelioContent.helpers.trim(i)),i=i.replace(/\r?\n/g,"<br>\r\n"),document.execCommand("insertHTML",!1,i)},_searchProfilesToMention:function(e,t){if(this.__search&&(this.__search.abort(),this.__search=void 0),!("string"!=typeof e||e.length<2)){var i="nc-mentions-search["+NelioContent.wpBlogId+"]["+e+"]",s=ncstore.get(i);if(void 0!==s)return t(s);this.__search=l.ajax({method:"GET",url:NelioContent.apiUri+"/profile/"+this.model.get("profileId")+"/search",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},data:{q:e},success:function(e){ncstore.set(i,e,(new Date).getTime()+828e5),t(e)}})}},close:function(){this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.TargetSelector=Backbone.View.extend({_networkMeta:void 0,_targets:[],_originalSelection:void 0,_loadingTargets:!0,_$window:void 0,_targetTemplate:NelioContent.helpers.getTemplate("_nc-profile-target"),template:NelioContent.helpers.getTemplate("_nc-target-selector"),events:{"click .nc-profile-target.nc-selectable":"_toggleTargetSelection"},initialize:function(){this._$window=l(window),this.render=_.bind(this.render,this),this._onDialogSave=_.bind(this._onDialogSave,this),this._onDialogCancel=_.bind(this._onDialogCancel,this),this._networkMeta=_.findWhere(NelioContent.networkMetas,{id:this.model.get("network")}),this._originalSelection=[],this.listenTo(this,"nc:render",this.render),this.listenToOnce(this,"nc:load:targets",this._onTargetsLoaded),this.listenToOnce(this,"nc:load:targets",this.render)},render:function(){var e={loadingLabel:this._networkMeta.multiTargetLabels.loading,loadingTargets:this._loadingTargets,explanation:this._networkMeta.multiTargetLabels.explanation,noTargetsAvailable:0===this._targets.length,noTargetsExplanation:this._networkMeta.multiTargetLabels.noBoardsExplanation};this.el.innerHTML=this.template(e);var t=this.$(".nc-targets")[0];return _.each(this._targets,function(e){t.innerHTML+=this._targetTemplate(e)},this),this},setOriginalSelection:function(e){this._originalSelection=e},openDialog:function(){this.trigger("nc:render");var e=[];e.push(NelioContent.helpers.makeDialogCancelButton(this,NelioContent.i18n.actions.cancel)),e.push(NelioContent.helpers.makeDialogSaveButton(this,NelioContent.i18n.actions.save));var t=this;this.$el.dialogS2({title:t._networkMeta.multiTargetLabels.title,buttons:e,draggable:!1,modal:!0,resizable:!1,width:Math.min(560,t._$window.width()-80),dialogClass:"nc-dialog",position:{my:"center top",at:"center top+60"},open:function(){t.listenTo(t,"nc:click:dialog:save",t._onDialogSave),t.listenTo(t,"nc:click:dialog:cancel",t._onDialogCancel);var e=t.$el.parent().find("button.nc-delete-button");0<e.length&&e.blur()},close:function(){t.stopListening(t,"nc:click:dialog:save",t._onDialogSave),t.stopListening(t,"nc:click:dialog:cancel",t._onDialogCancel),t._closeAndDestroy&&(t.$el.dialogS2("destroy"),t.trigger("nc:close:dialog"))}}),this.$el.parent().find(".ui-dialog-titlebar button").prop("disabled",!0),this.$el.parent().find(".ui-dialog-buttonpane button").prop("disabled",!0),this._loadTargets()},_loadTargets:function(){var t=this;l.ajax({url:NelioContent.apiUri+"/profile/"+this.model.get("id")+"/targets",method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},timeout:3e4,success:function(e){t.trigger("nc:load:targets",e)},error:function(e){t.$el.dialogS2("close"),NelioContent.helpers.openErrorDialog(e.responseJSON)}})},_onTargetsLoaded:function(e){this._targets=e,_.each(this._targets,function(e){e.selected=_.contains(this._originalSelection,e.name)},this),this._loadingTargets=!1,this.$el.parent().find(".ui-dialog-titlebar button").prop("disabled",!1),this.$el.parent().find(".ui-dialog-buttonpane button").prop("disabled",!1)},_toggleTargetSelection:function(e){var t=e.target||e.srcElement,i=l(t).closest(".nc-selectable").data("target-name"),s=_.findWhere(this._targets,{name:i});"object"==typeof s&&(s.selected=!s.selected),NelioContent.helpers.isSubscribed()||_.each(this._targets,function(e){e.name!==i&&(e.selected=!1)}),this.trigger("nc:render")},_onDialogSave:function(){if(!this._loadingTargets){var e=this.$el.parent(),t=e.find(".ui-dialog-titlebar button, .ui-dialog-buttonpane button:not( .button-primary )"),i=e.find(".ui-dialog-buttonpane button.button-primary");i.prop("disabled",!0),t.prop("disabled",!0),i.html(NelioContent.i18n.feedback.saving);var s=_.filter(this._targets,function(e){return e.selected});this.trigger("nc:update:targets",s),this.$el.dialogS2("close")}},_onDialogCancel:function(){this._loadingTargets||this.$el.dialogS2("close")},close:function(){_.each(_.values(this._views),function(e){"object"==typeof e&&"function"==typeof e.close&&e.close()}),this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.UserSelector=Backbone.View.extend({_userOptionTemplate:NelioContent.helpers.getTemplate("_nc-user-selector-option"),_selectedUserTemplate:NelioContent.helpers.getTemplate("_nc-user-selector-selected-option"),_rendered:!1,_defaultValue:void 0,_single:!1,_$select:void 0,_dropdownCssClass:"nc-ncselect2-above-jquery-dialog",_width:"100%",events:{"change .nc-user-selector":"_onUserChange"},initialize:function(e){void 0===e&&(e={}),void 0!==e.defaultValue&&(this._defaultValue=e.defaultValue),"boolean"==typeof e.single&&(this._single=e.single),"object"==typeof e.$select?this._$select=e.$select:this._$select=jQuery('<select class="nc-user-selector"></select>'),"string"==typeof e.dropdownCssClass&&(this._dropdownCssClass=e.dropdownCssClass),"string"==typeof e.width&&(this._width=e.width),this.render=_.bind(this.render,this),this._getAjaxData=_.bind(this._getAjaxData,this),this._processResults=_.bind(this._processResults,this),this._templateResult=_.bind(this._templateResult,this),this._templateSelection=_.bind(this._templateSelection,this)},render:function(){if(this._rendered)return this;this._rendered=!0;var e=[];if("number"==typeof this._defaultValue){var t=NelioContent.users.getUser(this._defaultValue);if(t.isLoading())return this.listenToOnce(t,"nc:load",this.render),this.listenToOnce(t,"nc:load:error",this.render),this._rendered=!1,this;e=[t.toJSON()]}return this.$el.html(this._$select),this._$select.ncselect2({data:e,dropdownCssClass:this._dropdownCssClass,width:this._width,placeholder:NelioContent.i18n.actions.selectAUser,templateResult:this._templateResult,templateSelection:this._templateSelection,ajax:{url:ajaxurl,cache:!1,dataType:"json",delay:250,data:this._getAjaxData,processResults:this._processResults}}),this.setValue(this._defaultValue),this._single&&this._$select.prop("disabled",!0),this},setValue:function(e){if(this._rendered){if("number"==typeof e){var t=_.bind(function(){this.undelegateEvents(),this._$select.empty().html('<option value="'+e+'"></option>').trigger("change"),this.delegateEvents()},this),i=NelioContent.users.getUser(e);i.isLoading()?this.listenToOnce(i,"nc:load",t):t()}}else this._defaultValue=e},lock:function(){this._$select.prop("disabled",!0)},unlock:function(){this._$select.prop("disabled",!1)},clearSelection:function(){this._$select.val(void 0),this._$select.trigger("change")},_getAjaxData:function(e){return{action:"nelio_content_get_authors",term:e.term,page:e.page}},_processResults:function(e,t){t.page=t.page||1;for(var i=0;i<e.items.length;++i)NelioContent.users.add(e.items[i]),e.items[i]=NelioContent.users.get(e.items[i].id).toJSON();return{results:e.items,pagination:{more:e.more}}},_templateResult:function(e){return void 0===e.name?e.text:l(this._userOptionTemplate(e))},_templateSelection:function(e){return isNaN(parseInt(e.id))?e.text:(e=NelioContent.users.getUser(e.id).toJSON(),l(this._selectedUserTemplate(e)))},_onUserChange:function(e){var t=e.target||e.srcElement,i=l(t),s=NelioContent.helpers.trim(i.val());s=isNaN(parseInt(s))?s:parseInt(s),this.trigger("nc:change",s)},close:function(){this._rendered&&this._$select.ncselect2("destroy"),this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.UserFilter=NelioContent.views.UserSelector.extend({_actions:!1,_labels:!1,initialize:function(e){void 0===e.defaultValue&&(e.defaultValue="all"),NelioContent.views.UserSelector.prototype.initialize.call(this,e),this._actions=jQuery.extend({},{all:!0,none:!1},e.actions),this._labels=jQuery.extend({},{group:!1,all:!1,none:!1,single:!1},e.labels),this._getAjaxData=_.bind(this._getAjaxData,this),this._processResults=_.bind(this._processResults,this),this._templateResult=_.bind(this._templateResult,this),this._templateSelection=_.bind(this._templateSelection,this)},render:function(){if(this._rendered)return this;if("number"==typeof this._defaultValue&&0<this._defaultValue){var e=NelioContent.users.getUser(this._defaultValue);e.isLoading()||e.get("existsInWordPress")||(this._defaultValue="all")}return NelioContent.views.UserSelector.prototype.render.call(this),"all"===this._defaultValue?(this._$select.val("all"),this._$select.empty().append('<option value="all">'+_.escape(this._labels.all)+"</option>").trigger("change")):"none"===this._defaultValue&&(this._$select.val("none"),this._$select.empty().append('<option value="none">'+_.escape(this._labels.none)+"</option>").trigger("change")),this},_getAjaxData:function(e){return{action:"nelio_content_get_authors",term:e.term,page:e.page}},_processResults:function(e,t){var i=NelioContent.views.UserSelector.prototype._processResults.call(this,e,t);return this._labels.group&&1===t.page&&i.results.length&&i.results.unshift({text:this._labels.group,children:[]}),t.term=t.term||"",1!==t.page||t.term.length||(this._actions.none&&i.results.unshift({id:"none"}),this._actions.all&&i.results.unshift({id:"all"})),i},_templateResult:function(e){return"all"===e.id?this._actions.all:"none"===e.id?this._actions.none:NelioContent.views.UserSelector.prototype._templateResult.call(this,e)},_templateSelection:function(e){if("all"===e.id)return this._labels.all;if("none"!==e.id)return this._labels.single?"string"==typeof e.name?this._labels.single.replace("%s",e.name):e.text:NelioContent.views.UserSelector.prototype._templateSelection.call(this,e);return l('<span><span class="nc-dashicons nc-dashicons-hidden"></span> '+this._labels.none+"</span>")}}),NelioContent.views.SingleProfileSelector=Backbone.View.extend({_profileTemplate:{default:NelioContent.helpers.getTemplate("_nc-single-profile-selector-profile"),selected:NelioContent.helpers.getTemplate("_nc-single-profile-selector-selected-profile")},_targetTemplate:NelioContent.helpers.getTemplate("_nc-single-profile-selector-target"),_previousTargetName:"",_targetDataLoader:void 0,_rendered:!1,events:{"change select.nc-profile":"_changeProfile","change select.nc-target":"_changeTarget"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this.model,"change:profileId",this._changeSelectedProfile),this.listenTo(this.model,"change:profileId",this._fixTargetSelectorVisibility)},render:function(){if(this._rendered)return this;this._rendered=!0;var e=jQuery('<div class="nc-profile-container"></div>'),t=jQuery('<select class="nc-profile" name="profile"></select>');e.html(t),this.$el.html(e);var i=this;t.ncselect2({dropdownCssClass:"nc-ncselect2-above-jquery-dialog",data:NelioContent.profiles.toJSON(),width:"100%",matcher:function(e,t){return"object"!=typeof e||"string"!=typeof e.term?t:(e=e.term,-1!==(t.displayName+" "+t.username).toLowerCase().indexOf(e.toLowerCase())?((t=_(t).clone()).displayNameEscaped=NelioContent.helpers.strongify(_.escape(t.displayName),e),t.usernameEscaped=NelioContent.helpers.strongify(_.escape(t.username),e),t):null)},templateResult:function(e){return void 0===e.displayName?e.text:l(i._profileTemplate.default(e))},templateSelection:function(e){return l(i._profileTemplate.selected(e))}}),t.val(this.model.get("profileId")).trigger("change");var s=jQuery('<div class="nc-target-container"></div>'),o=jQuery('<select class="nc-target" name="target"></select>');return s.html(o),o.hide(),this.$el.append(s),this._fixTargetSelectorVisibility(),this},lock:function(){this._isLocked=!0,this.$("select.nc-profile").prop("disabled",!0),this.$("select.nc-target").prop("disabled",!0)},_changeProfile:function(){this.stopListening(this.model,"change:profileId",this._changeSelectedProfile);var e=NelioContent.profiles.get(NelioContent.helpers.trim(this.$("select.nc-profile").val()));void 0!==e&&this.model.set("profileId",e.get("id")),this.listenTo(this.model,"change:profileId",this._changeSelectedProfile),this._maybeFixNewMessageInfo()},_changeTarget:function(){var e=this.$("select.nc-target"),t=e.val(),i=e.ncselect2("data"),s=_.findWhere(i,{id:t});void 0!==s?(this.model.set("targetName",s.name),this.model.set("targetDisplayName",s.displayName)):(this.model.set("targetName","default"),this.model.set("targetDisplayName","")),this._maybeFixNewMessageInfo()},_changeSelectedProfile:function(){this.stopListening(this.model,"change:profileId",this._changeSelectedProfile),this.$("select").val(this.model.get("profileId")).trigger("change"),this.listenTo(this.model,"change:profileId",this._changeSelectedProfile)},_fixTargetSelectorVisibility:function(){if(this._rendered){var e=this.$(".nc-target");e.ncselect2(),e.ncselect2("destroy"),void 0!==this._targetDataLoader&&("function"==typeof this._targetDataLoader.abort&&this._targetDataLoader.abort(),this._targetDataLoader=void 0);var t=NelioContent.profiles.get(this.model.get("profileId"));if(t.allowsMultiTargets()){var i=_.findWhere(NelioContent.networkMetas,{id:this.model.get("network")}),s=this;e.val(""),e.ncselect2({placeholder:i.multiTargetLabels.loading,width:"100%"}),this._targetDataLoader=l.ajax({url:NelioContent.apiUri+"/profile/"+t.get("id")+"/targets",method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},success:function(e){s._buildTargetSelector(e),s._targetDataLoader=void 0},error:function(){s._targetDataLoader=void 0}}),this._previousTargetName=this.model.get("targetName"),this.model.set("targetName",""),this.model.set("targetDisplayName","")}else this.model.set("targetName","default"),this.model.set("targetDisplayName","")}},_buildTargetSelector:function(e){var t=this.$(".nc-target"),i=this;if(t.ncselect2({dropdownCssClass:"nc-ncselect2-above-jquery-dialog",width:"100%",data:e,matcher:function(e,t){return"object"!=typeof e||"string"!=typeof e.term?t:(e=e.term,-1!==t.displayName.toLowerCase().indexOf(e.toLowerCase())?((t=_(t).clone()).displayNameEscaped=NelioContent.helpers.strongify(t.displayName,e),t):null)},templateResult:function(e){return void 0===e.displayName?e.text:(void 0===e.displayNameEscaped&&(e.displayNameEscaped=_.escape(e.displayName)),l(i._targetTemplate(e)))},templateSelection:function(e){return void 0!==e.displayName&&void 0===e.displayNamedEscaped&&(e.displayNameEscaped=_.escape(e.displayName)),l(i._targetTemplate(e))}}),!(e.length<=0)){var s=e[0],o=_.findWhere(e,{name:this._previousTargetName});void 0!==o&&(s=o),t.val(s.id).trigger("change"),this._previousTargetName=""}},_maybeFixNewMessageInfo:function(){this.model.isNew()&&this.model.set("profiles",[{id:this.model.get("profileId"),targetName:this.model.get("targetName"),targetDisplayName:this.model.get("targetDisplayName")}])},close:function(){this._rendered&&(this.$("select.nc-profile").ncselect2("destroy"),this.$("select.nc-target").ncselect2(),this.$("select.nc-target").ncselect2("destroy")),this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.SingleProfileSelector=Backbone.View.extend({_profileTemplate:{default:NelioContent.helpers.getTemplate("_nc-single-profile-selector-profile"),selected:NelioContent.helpers.getTemplate("_nc-single-profile-selector-selected-profile")},_targetTemplate:NelioContent.helpers.getTemplate("_nc-single-profile-selector-target"),_previousTargetName:"",_targetDataLoader:void 0,_rendered:!1,events:{"change select.nc-profile":"_changeProfile","change select.nc-target":"_changeTarget"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this.model,"change:profileId",this._changeSelectedProfile),this.listenTo(this.model,"change:profileId",this._fixTargetSelectorVisibility)},render:function(){if(this._rendered)return this;this._rendered=!0;var e=jQuery('<div class="nc-profile-container"></div>'),t=jQuery('<select class="nc-profile" name="profile"></select>');e.html(t),this.$el.html(e);var i=this;t.ncselect2({dropdownCssClass:"nc-ncselect2-above-jquery-dialog",data:NelioContent.profiles.toJSON(),width:"100%",matcher:function(e,t){return"object"!=typeof e||"string"!=typeof e.term?t:(e=e.term,-1!==(t.displayName+" "+t.username).toLowerCase().indexOf(e.toLowerCase())?((t=_(t).clone()).displayNameEscaped=NelioContent.helpers.strongify(_.escape(t.displayName),e),t.usernameEscaped=NelioContent.helpers.strongify(_.escape(t.username),e),t):null)},templateResult:function(e){return void 0===e.displayName?e.text:l(i._profileTemplate.default(e))},templateSelection:function(e){return l(i._profileTemplate.selected(e))}}),t.val(this.model.get("profileId")).trigger("change");var s=jQuery('<div class="nc-target-container"></div>'),o=jQuery('<select class="nc-target" name="target"></select>');return s.html(o),o.hide(),this.$el.append(s),this._fixTargetSelectorVisibility(),this},lock:function(){this._isLocked=!0,this.$("select.nc-profile").prop("disabled",!0),this.$("select.nc-target").prop("disabled",!0)},_changeProfile:function(){this.stopListening(this.model,"change:profileId",this._changeSelectedProfile);var e=NelioContent.profiles.get(NelioContent.helpers.trim(this.$("select.nc-profile").val()));void 0!==e&&this.model.set("profileId",e.get("id")),this.listenTo(this.model,"change:profileId",this._changeSelectedProfile),this._maybeFixNewMessageInfo()},_changeTarget:function(){var e=this.$("select.nc-target"),t=e.val(),i=e.ncselect2("data"),s=_.findWhere(i,{id:t});void 0!==s?(this.model.set("targetName",s.name),this.model.set("targetDisplayName",s.displayName)):(this.model.set("targetName","default"),this.model.set("targetDisplayName","")),this._maybeFixNewMessageInfo()},_changeSelectedProfile:function(){this.stopListening(this.model,"change:profileId",this._changeSelectedProfile),this.$("select").val(this.model.get("profileId")).trigger("change"),this.listenTo(this.model,"change:profileId",this._changeSelectedProfile)},_fixTargetSelectorVisibility:function(){if(this._rendered){var e=this.$(".nc-target");e.ncselect2(),e.ncselect2("destroy"),void 0!==this._targetDataLoader&&("function"==typeof this._targetDataLoader.abort&&this._targetDataLoader.abort(),this._targetDataLoader=void 0);var t=NelioContent.profiles.get(this.model.get("profileId"));if(t.allowsMultiTargets()){var i=_.findWhere(NelioContent.networkMetas,{id:this.model.get("network")}),s=this;e.val(""),e.ncselect2({placeholder:i.multiTargetLabels.loading,width:"100%"}),this._targetDataLoader=l.ajax({url:NelioContent.apiUri+"/profile/"+t.get("id")+"/targets",method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},success:function(e){s._buildTargetSelector(e),s._targetDataLoader=void 0},error:function(){s._targetDataLoader=void 0}}),this._previousTargetName=this.model.get("targetName"),this.model.set("targetName",""),this.model.set("targetDisplayName","")}else this.model.set("targetName","default"),this.model.set("targetDisplayName","")}},_buildTargetSelector:function(e){var t=this.$(".nc-target"),i=this;if(t.ncselect2({dropdownCssClass:"nc-ncselect2-above-jquery-dialog",width:"100%",data:e,matcher:function(e,t){return"object"!=typeof e||"string"!=typeof e.term?t:(e=e.term,-1!==t.displayName.toLowerCase().indexOf(e.toLowerCase())?((t=_(t).clone()).displayNameEscaped=NelioContent.helpers.strongify(t.displayName,e),t):null)},templateResult:function(e){return void 0===e.displayName?e.text:(void 0===e.displayNameEscaped&&(e.displayNameEscaped=_.escape(e.displayName)),l(i._targetTemplate(e)))},templateSelection:function(e){return void 0!==e.displayName&&void 0===e.displayNamedEscaped&&(e.displayNameEscaped=_.escape(e.displayName)),l(i._targetTemplate(e))}}),!(e.length<=0)){var s=e[0],o=_.findWhere(e,{name:this._previousTargetName});void 0!==o&&(s=o),t.val(s.id).trigger("change"),this._previousTargetName=""}},_maybeFixNewMessageInfo:function(){this.model.isNew()&&this.model.set("profiles",[{id:this.model.get("profileId"),targetName:this.model.get("targetName"),targetDisplayName:this.model.get("targetDisplayName")}])},close:function(){this._rendered&&(this.$("select.nc-profile").ncselect2("destroy"),this.$("select.nc-target").ncselect2(),this.$("select.nc-target").ncselect2("destroy")),this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.MultipleProfileSelector=Backbone.View.extend({_disabledProfileIds:[],_isLocked:!1,_profileTemplate:NelioContent.helpers.getTemplate("_nc-multiple-profile-selector-profile"),_availableSocialNetworks:void 0,_activeNetwork:"none",_targetSelectorDialog:void 0,template:NelioContent.helpers.getTemplate("_nc-multiple-profile-selector"),events:{"click .nc-available-networks .nc-network":"_changeNetwork","click .nc-profiles .nc-profile:not( .nc-disabled )":"_onProfileClicked"},initialize:function(e){void 0===e&&(e={}),this._availableSocialNetworks={},_.each(NelioContent.profiles.pluck("network"),function(e){this._availableSocialNetworks[e]=0},this),_.each(this.model.get("profiles"),function(e){var t=e.id,i=NelioContent.profiles.get(t);void 0!==i&&(void 0===this._availableSocialNetworks[i.get("network")]&&(this._availableSocialNetworks[i.get("network")]=0),this._availableSocialNetworks[i.get("network")]+=1)},this),this._activeNetwork=NelioContent.profiles.at(0).get("network"),_.every(NelioContent.profiles.pluck("network"),function(e){return!(0<this._availableSocialNetworks[e])||(this._activeNetwork=e,!1)},this),this.model.set("profileId",this._findBestProfileInNetwork(this._activeNetwork).get("id")),this.render=_.bind(this.render,this),this.listenTo(this,"nc:change:selectedProfile",this.render),this.listenTo(this,"nc:change:activeNetwork",this.render)},render:function(){this.$el.find(".nc-profile.nc-disabled").tooltip("destroy"),this.el.innerHTML=this.template();var s=this._activeNetwork,o=this.$(".nc-available-networks");_.mapObject(this._availableSocialNetworks,function(e,t){var i=l('<div class="nc-network nc-status"></div>');i.data("network",t),i.addClass("nc-"+t),o.append(i),0<e&&i.addClass("nc-selected"),t===s&&i.addClass("nc-active")}),_.keys(this._availableSocialNetworks).length<=1&&o.hide();var i=this.$(".nc-profiles"),n=this._disabledProfileIds,e=NelioContent.profiles.where({network:this._activeNetwork});return _.each(e,function(t){var e=t.toJSON();e.disabled=_.contains(n,t.get("id")),e.allowsMultiTargets=t.allowsMultiTargets(),t.allowsMultiTargets()?(e.allowsMultiTargets=!0,e.targetCount=_.filter(_.pluck(this.model.get("profiles"),"id"),function(e){return e===t.get("id")}).length,9<e.targetCount&&(e.targetCount="9-plus"),e.selected=0<e.targetCount):e.selected=_.contains(_.pluck(this.model.get("profiles"),"id"),t.get("id")),i.append(l(this._profileTemplate(e)))},this),this.$el.find(".nc-profile.nc-disabled").tooltip({position:{my:"left bottom",at:"right-5 top+5"},tooltipClass:"nc_tooltip nc_warning_tooltip",show:!1,hide:!1}),this},lock:function(){this._isLocked=!0},disableProfiles:function(e){this._disabledProfileIds=e},_changeNetwork:function(e){if(!this._isLocked){var t=e.target||e.srcElement,i=l(t).closest(".nc-network").data("network");if(i!==this._activeNetwork){this._activeNetwork=i,this.trigger("nc:change:activeNetwork");var s=this._findBestProfileInNetwork(i);this.model.set("profileId",s.get("id"))}}},_onProfileClicked:function(e){if(!this._isLocked){var t=e.target||e.srcElement,i=l(t).closest(".nc-profile"),s=NelioContent.profiles.get(i.data("profile"));s.allowsMultiTargets()?this._selectTargets(s):this._toggleProfileSelection(s)}},_selectTargets:function(s){this._targetSelectorDialog=new NelioContent.views.TargetSelector({model:s});var e=_.where(this.model.get("profiles"),{id:s.get("id")});this._targetSelectorDialog.setOriginalSelection(_.pluck(e,"targetName"));var o=this;this.listenTo(this._targetSelectorDialog,"nc:update:targets",function(e){var t=_(this.model.get("profiles")).clone(),i=[];_.each(t,function(e){e.id!==s.get("id")&&i.push(e)}),_.each(e,function(e){i.push({id:s.get("id"),targetName:e.name,targetDisplayName:e.displayName})}),o.model.set("profiles",i),o._selectProfileForPreview(s)}),this.listenTo(this._targetSelectorDialog,"nc:close:dialog",function(){o.stopListening(o._targetSelectorDialog),o._targetSelectorDialog.close(),o._targetSelectorDialog=void 0}),this._targetSelectorDialog.openDialog()},_toggleProfileSelection:function(t){var e=_(this.model.get("profiles")).clone();if(_.contains(_.pluck(e,"id"),t.get("id"))){var i=_.filter(e,function(e){return e.id===t.get("id")});0<i.length&&(i=i[0],e=_.without(e,i))}else e.push({id:t.get("id"),targetName:"default",targetDisplayName:""});this.model.set("profiles",e),this._selectProfileForPreview(t)},_selectProfileForPreview:function(t){var i=this.model.get("profiles"),e=NelioContent.profiles.filter(function(e){return e.get("network")===t.get("network")&&_.contains(_.pluck(i,"id"),e.get("id"))});this._availableSocialNetworks[t.get("network")]=e.length;var s=_.pluck(this.model.get("profiles"),"id");if(_.contains(s,t.get("id")))this.model.set("profileId",t.get("id"));else if(this.model.get("profileId")===t.get("id")){var o=this._findBestProfileInNetwork(t.get("network"));this.model.set("profileId",o.get("id"))}this.trigger("nc:change:selectedProfile")},_findBestProfileInNetwork:function(t){var i=_.pluck(this.model.get("profiles"),"id"),e=NelioContent.profiles.filter(function(e){return e.get("network")===t&&_.contains(i,e.get("id"))})[0];return void 0===e&&(e=NelioContent.profiles.findWhere({network:t})),e},close:function(){this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.SocialMessagePreview=Backbone.View.extend({_profileInformation:{displayName:"David Aguilera",firstLetter:"d",username:"@davilera, Nelio Software",photo:"https://twitter.com/davilera/profile_image"},_warningTemplate:NelioContent.helpers.getTemplate("_nc-preview-warning-message"),_sharedLinkInformation:{title:"",excerpt:"",permalink:"",domain:"",date:!1,author:"",image:"",status:"invalid",_ajaxRequest:void 0,_isBasedOnTheRelatedPost:!1},initialize:function(){this.render=_.bind(this.render,this),this._getUrlMetaData=_.bind(this._getUrlMetaData,this),this.listenTo(this,"nc:getUrlMetaData",_.debounce(this._getUrlMetaData,300)),this.listenTo(this,"nc:change:sharedLink",this.render),this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"change:profileId",this._updateProfileInformation),this.listenTo(this.model,"change:_previewUrl",this._maybeObtainSharedLinkInformation),this._sharedLinkInformation.permalink="",this._sharedLinkInformation.status="invalid",this._updateProfileInformation(),this._maybeObtainSharedLinkInformation()},render:function(){var e=_.pluck(NelioContent.profiles.where({network:this.model.get("network")}),"id"),t=_.pluck(this.model.get("profiles"),"id");if(this.model.isNew()&&0===_.intersection(e,t).length)return this.el.innerHTML=this._warningTemplate(i),this;var i=this.model.toJSON();if(i.textFormatted=this._beautifyLinks(this.model.getPreviewText()),i.profile=this._profileInformation,i.sharedLink=this._sharedLinkInformation,0===this.model.get("postId")||this.model.post.isPublished()||this.model.post.isScheduled())i.dateFormatted=this.formatDate(this.model.get("schedule"));else if("exact"===this.model.get("dateType")&&/[12][0-9][0-9][0-9]-[01][0-9]-[0-3][0-9]/.test(this.model.get("dateValue"))){var s=this.model.get("dateValue")+" "+this.model.get("timeValue");s=ncNewLocalMoment(s),i.dateFormatted=this.formatDate(s)}else i.dateFormatted=NelioContent.i18n.dates.someday;return this.el.innerHTML=this.template(i),this},beautifyLink:function(e){return e},formatDate:function(e){return e.format("YYYY-MM-DD h:mm a")},_beautifyLinks:function(e){var t,i;t=_.uniq(e.match(/"nc-link">[^<]+</g));for(var s=0;s<t.length;++s)i=t[s].replace('"nc-link">',"").replace("<",""),e=e.replace(t[s],'"nc-link">'+this.beautifyLink(i)+"<");return e},_updateProfileInformation:function(){var e=NelioContent.profiles.get(this.model.get("profileId"));void 0===e&&(e=NelioContent.profiles.at(0)),this._profileInformation={displayName:e.get("displayName"),firstLetter:e.get("firstLetter"),username:e.get("username"),photo:e.get("photo")}},_setSharedLinkStatus:function(e){this._sharedLinkInformation.status=e,this.trigger("nc:change:sharedLink:status"),this.trigger("nc:change:sharedLink")},_maybeObtainSharedLinkInformation:function(){var e=this.model.get("_previewUrl"),t=this.model.post.toJSON();if(void 0!==this._sharedLinkInformation._ajaxRequest&&(this._sharedLinkInformation._ajaxRequest.abort(),this._setSharedLinkStatus("invalid")),0===e.length)this._sharedLinkInformation.permalink="",this._setSharedLinkStatus("invalid");else if(e===this._sharedLinkInformation.permalink);else if(e!==t.permalink||"error"===this._sharedLinkInformation.status)this._setSharedLinkStatus("loading"),this._sharedLinkInformation._isBasedOnTheRelatedPost=!1,this.trigger("nc:getUrlMetaData",e);else if(e===t.permalink&&this.model.get("postId")===t.id){this._sharedLinkInformation._isBasedOnTheRelatedPost=!0;var i=NelioContent.users.getUser(t.author);i.isLoading()?i.listenToOnce(i,"nc:load",_.bind(function(){this._maybeObtainSharedLinkInformation()},this)):(t.author=i.get("name"),void 0!==t.image&&0!==t.image.length||(t.image=t.autoImage),this._updateSharedLinkInformation(t),this._setSharedLinkStatus("ready"))}},_getUrlMetaData:function(e){var t=this;this._sharedLinkInformation._ajaxRequest=l.ajax({url:ajaxurl,data:{action:"nelio_content_get_url_meta_data",url:e},success:function(e){e.title=NelioContent.helpers.decodeHTMLEntities(e.title),e.excerpt=NelioContent.helpers.decodeHTMLEntities(e.excerpt),t._updateSharedLinkInformation(e),"error"!==t._sharedLinkInformation.status&&t._setSharedLinkStatus("ready")},error:function(){t._setSharedLinkStatus("error")}})},_updateSharedLinkInformation:function(i){switch(void 0===i.image&&(i.image=""),i.responseCode){case 403:case 404:case 500:return this._sharedLinkInformation.status="error",this.trigger("nc:change:sharedLink:status"),void this.trigger("nc:change:sharedLink")}if(void 0===i.title||0===NelioContent.helpers.trim(i.title).length)return this._sharedLinkInformation.status="error",this.trigger("nc:change:sharedLink:status"),void this.trigger("nc:change:sharedLink");var s=!1;if(_.each(["id","title","excerpt","permalink","date","author"],function(e){var t=i[e];void 0===t&&(t=""),"excerpt"===e&&90<t.length&&(t=t.substring(0,90)+"…"),this._sharedLinkInformation[e]!==t&&(this._sharedLinkInformation[e]=t,this.trigger("nc:change:sharedLink:"+e),s=!0)},this),this._sharedLinkInformation.image!==i.image&&(this._sharedLinkInformation.image=i.image,this.trigger("nc:change:sharedLink:image"),s=!0,0<i.image.length)){var e=new Image;e.onerror=function(){view._sharedLinkInformation.image===i.image&&(view._sharedLinkInformation.image="",view.trigger("nc:change:sharedLink:image"),view.trigger("nc:change:sharedLink"))},e.src=i.image}if("string"==typeof i.permalink){var t=this._sharedLinkInformation.permalink;0<(t=t.replace(/^https?:\/\//,"")).indexOf("/")&&(t=t.substring(0,t.indexOf("/"))),t!==this._sharedLinkInformation.domain&&(this._sharedLinkInformation.domain=t,this.trigger("nc:change:sharedLink:domain"),s=!0)}s&&this.trigger("nc:change:sharedLink")},close:function(){this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.FacebookPreview=NelioContent.views.SocialMessagePreview.extend({template:NelioContent.helpers.getTemplate("_nc-facebook-preview"),beautifyLink:function(e){return 60<e.length&&(e="/"===e[e.length-1]?e.substring(0,58)+"…/":e.substring(0,59)+"…"),e},formatDate:function(e){return e.format(NelioContent.i18n.dates.preview.facebook)}}),NelioContent.views.GooglePlusPreview=NelioContent.views.SocialMessagePreview.extend({template:NelioContent.helpers.getTemplate("_nc-googleplus-preview"),beautifyLink:function(e){var t=(e=e.replace(/https?:\/\//,"")).indexOf("/");return-1!==t&&(e=e.substring(0,t)),e},formatDate:function(e){return e.format(NelioContent.i18n.dates.preview.googleplus)}}),NelioContent.views.InstagramPreview=NelioContent.views.SocialMessagePreview.extend({template:NelioContent.helpers.getTemplate("_nc-instagram-preview"),beautifyLink:function(e){var t=(e=e.replace(/https?:\/\//,"")).indexOf("/");return-1!==t&&(e=e.substring(0,t)),e},formatDate:function(e){return e.format(NelioContent.i18n.dates.preview.instagram)}}),NelioContent.views.LinkedInPreview=NelioContent.views.SocialMessagePreview.extend({_links:{},template:NelioContent.helpers.getTemplate("_nc-linkedin-preview"),beautifyLink:function(e){if(void 0===this._links[e]){var t="https://lnkd.in/",i=Math.floor(10*Math.random()),s=Math.floor(10*Math.random()),o=Math.floor(10*Math.random());t+=o<3?i+"n3Li"+s+"o":o<5?"D4"+i+"vid"+s:o<7?i+"toNI"+s+"v":"ru"+i+s+"Th"+i,this._links[e]=t}return this._links[e]},formatDate:function(e){return e.format(NelioContent.i18n.dates.preview.googleplus)}}),NelioContent.views.PinterestPreview=NelioContent.views.SocialMessagePreview.extend({template:NelioContent.helpers.getTemplate("_nc-pinterest-preview"),beautifyLink:function(e){var t=(e=e.replace(/https?:\/\//,"")).indexOf("/");return-1!==t&&(e=e.substring(0,t)),e},formatDate:function(e){return e.format(NelioContent.i18n.dates.preview.pinterest)}}),NelioContent.views.TumblrPreview=NelioContent.views.SocialMessagePreview.extend({template:NelioContent.helpers.getTemplate("_nc-tumblr-preview"),beautifyLink:function(e){var t=(e=e.replace(/https?:\/\//,"")).indexOf("/");if(-1!==t){var i=t+15;i<e.length&&(e=e.substring(0,i)+"…")}return e},formatDate:function(e){return e.format(NelioContent.i18n.dates.preview.tumblr)}}),NelioContent.views.TwitterPreview=NelioContent.views.SocialMessagePreview.extend({template:NelioContent.helpers.getTemplate("_nc-twitter-preview"),beautifyLink:function(e){var t=(e=e.replace(/https?:\/\//,"")).indexOf("/");if(-1!==t){var i=t+15;i<e.length&&(e=e.substring(0,i)+"…")}return e},formatDate:function(e){return"time-interval"===this.model.get("timeType")?e.format(NelioContent.i18n.dates.preview.twitterNoTime):e.format(NelioContent.i18n.dates.preview.twitter)}}),NelioContent.views.DateSelector=Backbone.View.extend({_isLocked:!1,_isDatePickerReady:!1,template:NelioContent.helpers.getTemplate("_nc-date-selector"),events:{"change .nc-value":"_changeDate","keyup  input.nc-value":"_changeDate","click  .nc-change-type":"_changeDateType","click  .nc-datepicker":"_maybeInitDatePicker"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this.model,"change:dateType",this.render)},render:function(){var e=this.$(".nc-datepicker");"date"!==e.prop("type")&&(e.datepicker("destroy"),this._isDatePickerReady=!1);var t=this.model.toJSON();return t.dateOffsetMode=this._getDateOffsetMode(),this.el.innerHTML=this.template(t),this.$(".nc-value").val(this.model.get("dateValue")),this},lock:function(){this._isLocked=!0,this.$("input").prop("disabled",!0),this.$("select").prop("disabled",!0)},_getDateOffsetMode:function(){return 0===this.model.get("postId")?"after-now":this.model.post.isPublished()?"after-now":"positive-days"===this.model.get("dateType")?"after-publication":void 0!==this.model.get("task")?"before-publication":"after-publication"},_changeDate:function(e){if(!this._isLocked){var t,i=e.target||e.srcElement,s=l(i);switch(s.data("date-type")){case"exact":t=s.val(),this.model.set("dateValue",t);break;case"negative-days":case"positive-days":0===(t=s.val()).length&&(t="2"),this.model.set("dateValue",t);break;case"predefined-offset":switch(t=s.val()){case"positive-days":case"negative-days":case"exact":this.model.set({dateType:t,dateValue:""});break;default:this.model.set("dateValue",t)}}}},_changeDateType:function(e){if(!this._isLocked)return this.model.set("dateValue","0"),this.model.set("dateType","predefined-offset"),!1},_maybeInitDatePicker:function(e){var t=this.$(".nc-datepicker");this._isDatePickerReady||"exact"!==this.model.get("dateType")||"date"===t.prop("type")||(t.datepicker({dateFormat:"yy-mm-dd",minDate:0}),t.datepicker("show")),this._isDatePickerReady=!0},close:function(){this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.TimeSelector=Backbone.View.extend({_isLocked:!1,template:NelioContent.helpers.getTemplate("_nc-time-selector"),events:{"change .nc-value":"_changeTime","keyup  input.nc-value":"_changeTime","click  .nc-change-type":"_changeTimeType"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this.model,"change:dateType",this._useProperSelector),this.listenTo(this.model,"change:dateValue",this._useProperSelector),this.listenTo(this.model,"change:dateType",this.render),this.listenTo(this.model,"change:dateValue",this.render),this.listenTo(this.model,"change:timeType",this.render)},render:function(){var e=this.model.toJSON();return e.timeOffsetMode=this._getTimeOffsetMode(),this.el.innerHTML=this.template(e),this.$(".nc-value").val(this.model.get("timeValue")),this},lock:function(){this._isLocked=!0,this.$("input").prop("disabled",!0),this.$("select").prop("disabled",!0)},_getTimeOffsetMode:function(){var e=this.model.get("dateType"),t=this.model.get("dateValue");return"predefined-offset"===e&&"0"===t?0===this.model.get("postId")||this.model.post.isPublished()?"after-now":"after-publication":"time-interval"},_changeTime:function(e){if(!this._isLocked){var t,i=e.target||e.srcElement,s=l(i);switch(s.data("time-type")){case"exact":t=s.val(),this.model.set("timeValue",t);break;case"negative-hours":0===(t=s.val()).length&&(t="2"),this.model.set("timeValue","-"+t);break;case"positive-hours":0===(t=s.val()).length&&(t="2"),this.model.set("timeValue",t);break;case"time-interval":switch(t=s.val()){case"exact":this.model.set({timeType:t,timeValue:""});break;default:this.model.set("timeValue",t)}break;case"predefined-offset":switch(t=s.val()){case"positive-hours":case"negative-hours":case"exact":this.model.set({timeType:t,timeValue:""});break;default:this.model.set("timeValue",t)}}}},_useProperSelector:function(){if(!this._isLocked){var e=this.model.get("dateType"),t=this.model.get("dateValue");switch(this.model.get("timeType")){case"exact":break;case"negative-hours":case"positive-hours":case"predefined-offset":"predefined-offset"===e&&"0"===t||(this.model.set("timeValue","morning"),this.model.set("timeType","time-interval"));break;case"time-interval":"predefined-offset"===e&&"0"===t&&(this.model.set("timeValue","0"),this.model.set("timeType","predefined-offset"))}}},_changeTimeType:function(e){if(!this._isLocked)return this.model.set("timeValue","0"),this.model.set("timeType","predefined-offset"),this._useProperSelector(),!1},close:function(){this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}})}(jQuery);