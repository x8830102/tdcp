!function(o){"use strict";NelioContent.models.Account=Backbone.Model.extend({defaults:{isLoading:!1,error:!1,creationDate:"",email:"",firstname:"",lastname:"",fullname:"",fullnameFormatted:"",photo:"",license:"",endDate:"",nextChargeDate:"",nextChargeTotal:"",subscription:"none",state:"active",invoices:void 0,errorLoadingInvoices:!1},initialize:function(){this.listenTo(this,"change:firstname",this._setFullname),this.listenTo(this,"change:lastname",this._setFullname),this._setFullname(),this.listenTo(this,"change:fullname",this._setFirstLetter),this._setFirstLetter(),this.listenTo(this,"change:fullname",this._formatFullname),this._formatFullname(),this.listenTo(this,"change:endDate",this._fixEndDateFormat),this._fixEndDateFormat(),this.listenTo(this,"change:nextChargeDate",this._fixNextChargeDateFormat),this._fixNextChargeDateFormat(),this.listenTo(this,"change:creationDate",this._fixCreationDateFormat),this._fixCreationDateFormat()},load:function(){this.set("isLoading",!0);var t=this;o.ajax({url:ajaxurl,data:{action:"nelio_content_get_account"},success:function(e){t.set(e),t.set("error",!1),t.set("isLoading",!1),t.resetInvoices()},error:function(e){t.set("error",e.responseJSON),t.set("isLoading",!1)}})},resetInvoices:function(){if(this.set("invoices",void 0),this.set("errorLoadingInvoices",!1),"regular"===this.get("mode")){var t=this;o.ajax({url:NelioContent.apiUri+"/subscription/invoices",method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},success:function(e){t.set("errorLoadingInvoices",!1),t.set("invoices",e)},error:function(){t.set("errorLoadingInvoices",!0),t.set("invoices",[])}})}},_setFullname:function(){var e=NelioContent.helpers.trim(this.get("firstname")),t=NelioContent.helpers.trim(this.get("lastname"));if(0<e.length&&0<t.length){var n=NelioContent.i18n.fullnameFormat;n=(n=n.replace("{firstname}",e)).replace("{lastname}",t),this.set("fullname",n)}else 0<e.length&&0===t.length?this.set("fullname",e):0===e.length&&0<t.length?this.set("fullname",t):this.set("fullname",NelioContent.i18n.errors.generic.unknownUserName)},_formatFullname:function(){this.set("fullnameFormatted",_.escape(this.get("fullname")))},_setFirstLetter:function(){var e=this.get("fullname");e===NelioContent.i18n.errors.generic.unknownUserName&&(e=""),this.set("firstLetter",NelioContent.helpers.extractFirstLetter(e))},_fixNextChargeDateFormat:function(){this._fixDate("nextChargeDate")},_fixEndDateFormat:function(){this._fixDate("endDate")},_fixCreationDateFormat:function(){this._fixDate("creationDate")},_fixDate:function(e){var t=this.get(e);"string"==typeof t?""!==NelioContent.helpers.trim(t)?this.set(e,ncNewLocalMoment(t)):this.set(e,ncNewLocalMoment()):"object"!=typeof t&&this.set(e,ncNewLocalMoment())}}),NelioContent.models.FastspringProduct=NelioContent.models.Model.extend({defaults:{plan:"",price:""},parse:function(e){e.product.indexOf("monthly")?this.set("plan","monthly"):this.set("plan","yearly"),this.set("price",e.pricing.price.USD)}}),NelioContent.collections.FastspringProducts=NelioContent.collections.Collection.extend({_isReady:!1,model:NelioContent.models.FastspringProduct,comparator:function(e){return"monthly"===e.get("plan")?"0mon":"1yea"},isReady:function(){return this._isReady},populate:function(){this.reload()},reload:function(){this._isReady=!1;var i=this;o.ajax({url:NelioContent.productsUri,method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},success:function(e){i._isReady=!0,i.reset([]);var n=["nc-monthly","nc-yearly"];_.each(e,function(e){if(_.contains(n,e.product)){var t=new NelioContent.models.FastspringProduct({id:e.product});t.parse(e),i.add(t)}}),i.trigger("nc:ready")},error:function(e){i.trigger("nc:error",e.responseJSON)}})}}),NelioContent.views.UserSelector=Backbone.View.extend({_userOptionTemplate:NelioContent.helpers.getTemplate("_nc-user-selector-option"),_selectedUserTemplate:NelioContent.helpers.getTemplate("_nc-user-selector-selected-option"),_rendered:!1,_defaultValue:void 0,_single:!1,_$select:void 0,_dropdownCssClass:"nc-ncselect2-above-jquery-dialog",_width:"100%",events:{"change .nc-user-selector":"_onUserChange"},initialize:function(e){void 0===e&&(e={}),void 0!==e.defaultValue&&(this._defaultValue=e.defaultValue),"boolean"==typeof e.single&&(this._single=e.single),"object"==typeof e.$select?this._$select=e.$select:this._$select=jQuery('<select class="nc-user-selector"></select>'),"string"==typeof e.dropdownCssClass&&(this._dropdownCssClass=e.dropdownCssClass),"string"==typeof e.width&&(this._width=e.width),this.render=_.bind(this.render,this),this._getAjaxData=_.bind(this._getAjaxData,this),this._processResults=_.bind(this._processResults,this),this._templateResult=_.bind(this._templateResult,this),this._templateSelection=_.bind(this._templateSelection,this)},render:function(){if(this._rendered)return this;this._rendered=!0;var e=[];if("number"==typeof this._defaultValue){var t=NelioContent.users.getUser(this._defaultValue);if(t.isLoading())return this.listenToOnce(t,"nc:load",this.render),this.listenToOnce(t,"nc:load:error",this.render),this._rendered=!1,this;e=[t.toJSON()]}var n=this;return this.$el.html(this._$select),this._$select.ncselect2({data:e,dropdownCssClass:this._dropdownCssClass,width:this._width,placeholder:NelioContent.i18n.actions.selectAUser,templateResult:n._templateResult,templateSelection:n._templateSelection,ajax:{url:ajaxurl,cache:!1,dataType:"json",delay:250,data:n._getAjaxData,processResults:n._processResults}}),this.setValue(this._defaultValue),this._single&&this._$select.prop("disabled",!0),this},setValue:function(e){if(this._rendered){if("number"==typeof e){var t=_.bind(function(){this.undelegateEvents(),this._$select.empty().html('<option value="'+e+'"></option>').trigger("change"),this.delegateEvents()},this),n=NelioContent.users.getUser(e);n.isLoading()?this.listenToOnce(n,"nc:load",t):t()}}else this._defaultValue=e},lock:function(){this._$select.prop("disabled",!0)},unlock:function(){this._$select.prop("disabled",!1)},clearSelection:function(){this._$select.val(void 0),this._$select.trigger("change")},_getAjaxData:function(e){return{action:"nelio_content_get_authors",term:e.term,page:e.page}},_processResults:function(e,t){t.page=t.page||1;for(var n=0;n<e.items.length;++n)NelioContent.users.add(e.items[n]),e.items[n]=NelioContent.users.get(e.items[n].id).toJSON();return{results:e.items,pagination:{more:e.more}}},_templateResult:function(e){return void 0===e.name?e.text:o(this._userOptionTemplate(e))},_templateSelection:function(e){return isNaN(parseInt(e.id))?e.text:(e=NelioContent.users.getUser(e.id).toJSON(),o(this._selectedUserTemplate(e)))},_onUserChange:function(e){var t=e.target||e.srcElement,n=o(t),i=NelioContent.helpers.trim(n.val());i=isNaN(parseInt(i))?i:parseInt(i),this.trigger("nc:change",i)},close:function(){this._rendered&&this._$select.ncselect2("destroy"),this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.AccountPage=Backbone.View.extend({_$spinner:void 0,_license:{formStatus:"none",newValue:"",regex:/^[0-9a-zA-Z$#]{21}$/},_invoiceTemplates:{table:NelioContent.helpers.getTemplate("_nc-billing"),invoice:NelioContent.helpers.getTemplate("_nc-invoice")},template:NelioContent.helpers.getTemplate("_nc-account-page"),events:{"click .nc-use-license-key":"_showUseLicenseKeyForm","click .nc-hide-license-form":"_hideUseLicenseKeyForm","click .nc-validate-license":"_validateLicense","keyup input.nc-license-key":"_maybeEnableValidateLicenseButton","change input.nc-license-key":"_maybeEnableValidateLicenseButton","click .nc-subscribe":"_maybeSubscribe","click .nc-upgrade":"_maybeUpgradeSubscription","click .nc-cancel-subscription":"_maybeCancelSubscription","click .nc-reactivate":"_maybeReactivateSubscription"},initialize:function(e){void 0===e&&(e={}),this._$spinner=e.spinner,this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change:isLoading",this.render),this.listenTo(this.model,"change:invoices",this.render)},render:function(){if(this.model.get("isLoading"))return this.el.innerHTML="",this;if(this.model.get("error"))return this.el.innerHTML='<span class="nc-dashicons nc-dashicons-warning"></span> '+_.escape(this.model.get("error")),void 0!==this._$spinner&&this._$spinner.hide(),this;var e=this.model.toJSON(),t=this.model.get("creationDate");e.creationDateFormatted=t.format(NelioContent.i18n.dates.creationDate),e.endDateFormatted="",e.nextRenewalDateFormatted="","canceled"===this.model.get("status")?e.endDateFormatted=this.model.get("endDate").format(NelioContent.i18n.dates.cancelDateText):e.nextRenewalDateFormatted=this.model.get("nextChargeDate").format(NelioContent.i18n.dates.nextChargeDate),e.modifyLicenseKeyStatus=this._license.formStatus,e.newLicenseKey=this._license.newValue,this.el.innerHTML=this.template(e),void 0!==this._$spinner&&(this.model.get("isLoading")?this._$spinner.show():this._$spinner.hide());var n=this.model.get("invoices");if(this.model.get("errorLoadingInvoices"))this.$("#nc-billing-table").html(NelioContent.i18n.errors.api.cantGetInvoices);else if("object"==typeof n)if(0<n.length){var i=this,s=o(this._invoiceTemplates.table());this.$("#nc-billing-table").html(s),_.each(n,function(e){s.append(i._invoiceTemplates.invoice(e))})}else this.$("#nc-billing-table").html(NelioContent.i18n.feedback.noInvoices);return this._license.regex.test(this._license.newValue)||this.$(".nc-validate-license").prop("disabled",!0),this},_showUseLicenseKeyForm:function(){this._license.newValue="",this._license.formStatus="visible-form",this.trigger("nc:render")},_hideUseLicenseKeyForm:function(){this._license.newValue="",this._license.formStatus="none",this.trigger("nc:render")},_validateLicense:function(){this._license.formStatus="validating",this.trigger("nc:render");var t=this;o.ajax({url:ajaxurl,data:{action:"nelio_content_use_license",license:NelioContent.helpers.trim(this._license.newValue)},success:function(e){t._license.newValue="",t._license.formStatus="none",t.model.set(e),t.model.resetInvoices(),t.trigger("nc:render")},error:function(e){NelioContent.helpers.openErrorDialog(e.responseJSON),t._license.formStatus="form",t.trigger("nc:render")}})},_maybeEnableValidateLicenseButton:function(){this._license.newValue=this.$("input.nc-license-key").val(),this.$(".nc-validate-license").prop("disabled",!this._license.regex.test(this._license.newValue))},_maybeSubscribe:function(){var e=this,t=new NelioContent.views.SubscribeDialog;this.listenTo(t,"nc:close",function(){e.stopListening(t)}),t.render()},_maybeUpgradeSubscription:function(){var t=this,e=new NelioContent.views.UpgradeDialog({model:this.model});this.listenTo(e,"nc:upgrade",function(e){t.model.set(e),t.model.resetInvoices(),t.trigger("nc:render")}),this.listenTo(e,"nc:close",function(){t.stopListening(e)}),e.render()},_maybeCancelSubscription:function(){var e=this.model.get("nextChargeDate").format(NelioContent.i18n.dates.cancelDateDialog),n=this,i=NelioContent.helpers.openDeletionConfirmationDialog(NelioContent.i18n.titles.cancelSubscription,NelioContent.i18n.dialogs.cancelSubscription.replace("{date}",_.escape(e)),NelioContent.i18n.actions.cancelSubscription,function(){var e=i.parent().find("button"),t=i.parent().find(".nc-super-delete-button");e.prop("disabled",!0),t.html(NelioContent.i18n.feedback.cancelingSubscription),i.dialog("option","closeOnEscape",!1),o.ajax({url:ajaxurl,data:{action:"nelio_content_cancel_subscription"},success:function(e){n.model.set(e),n.model.resetInvoices(),n.trigger("nc:render"),i.dialog("close")},error:function(e){i.dialog("close"),NelioContent.helpers.openErrorDialog(e.responseJSON)}})}),t=i.dialog("option","buttons");t[0].text=NelioContent.i18n.actions.close,i.dialog("option","buttons",t),i.parent().find(".nc-cancel-button").focus()},_maybeReactivateSubscription:function(){var n=this,i=NelioContent.helpers.openConfirmationDialog(NelioContent.i18n.titles.reactivateSubscription,NelioContent.i18n.dialogs.reactivateSubscription,NelioContent.i18n.actions.reactivateSubscription,function(){var e=i.parent().find("button"),t=i.parent().find(".button-primary");e.prop("disabled",!0),t.html(NelioContent.i18n.feedback.reactivatingSubscription),i.dialog("option","closeOnEscape",!1),o.ajax({url:ajaxurl,data:{action:"nelio_content_uncancel_subscription"},success:function(e){n.model.set(e),n.model.resetInvoices(),n.trigger("nc:render"),i.dialog("close")},error:function(e){i.dialog("close"),NelioContent.helpers.openErrorDialog(e.responseJSON)}})}),e=i.dialog("option","buttons");e[0].text=NelioContent.i18n.actions.close,i.dialog("option","buttons",e),i.parent().find(".nc-reactivate").focus()},close:function(){this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.SubscribeDialog=Backbone.View.extend({template:NelioContent.helpers.getTemplate("_nc-subscribe-dialog"),initialize:function(){this.collection=new NelioContent.collections.FastspringProducts,this.collection.populate(),this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.collection,"nc:ready",this.render),this.listenTo(this.collection,"nc:error",this.render),this._convertToDialog()},render:function(){var e={mode:"loading",personalPlanPrices:"",teamPlanPrices:""};return this.collection.isReady()&&(2===this.collection.length?(e.monthlyPlan=this._getPlan("monthly"),e.yearlyPlan=this._getPlan("yearly"),e.mode="ready"):e.mode="error"),this.el.innerHTML=this.template(e),this.$el.dialog("open"),this},_lock:function(){this.$("*").attr("disabled","disabled"),this.$el.addClass("nc-locked")},_convertToDialog:function(){var e=this;this.$el.dialog({title:NelioContent.i18n.titles.subscribe,modal:!0,width:Math.min(600,NelioContent.helpers.getWindowWidth()-20),dialogClass:"nc-dialog",position:{my:"center top",at:"center top+80"},close:function(){e.trigger("nc:close:dialog")}})},_getPlan:function(e){if("monthly"===e)return this.collection.get("nc-monthly").toJSON();var t=this.collection.get("nc-yearly").toJSON();return t.equivalence=Math.round(t.price/12),t},close:function(){this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}});var e=new NelioContent.views.AccountPage({el:o(".nc-billing-page-container"),spinner:o(".nc-billing-page h2 .spinner"),model:new NelioContent.models.Account});e.model.load(),e.render()}(jQuery);