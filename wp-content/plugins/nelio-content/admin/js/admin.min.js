!function(o){"use strict";NelioContent.hasSocialProfiles=!!NelioContent.hasSocialProfiles;var e,s,t,i,a,n,r,l,c,h=NelioContent.i18n.locale.toLowerCase().replace("_","-"),d=h;function u(i){if(-1!==_.indexOf(r,i))return!0;var e=function(e){var t=e.indexOf("?");-1!==t&&(e=e.substring(0,t));if(/^https?:\/\//i.test(e)){var i=(e=e.replace(/^https?:\/\//i,"")).indexOf("/");if(-1===i)return"";e=e.substring(i,e.length)}var n=e.substring(Math.max(0,e.length-6),e.length),s=n.indexOf(".");return-1!==s?n.substring(s+1,n.length).toLowerCase():""}(i);return!(0<e.length&&-1!==_.indexOf(l,e))&&(!_.reduce(NelioContent.misc.nonReferenceDomains,function(e,t){return e||t.test(i)},!1)&&(r.push(i),!0))}0<d.indexOf("-")&&(d=d.substr(0,d.indexOf("-"))),o.fn.ncselect2.defaults.set("language",d),_.contains(ncmoment.locales(),h)?ncmoment.updateLocale(h,{calendar:{lastDay:NelioContent.i18n.dates.lastDay,sameDay:NelioContent.i18n.dates.sameDay,nextDay:NelioContent.i18n.dates.nextDay,lastWeek:NelioContent.i18n.dates.lastWeek,nextWeek:NelioContent.i18n.dates.nextWeek,sameElse:NelioContent.i18n.dates.default},week:{dow:NelioContent.i18n.startOfWeek}}):_.contains(ncmoment.locales(),d)&&ncmoment.updateLocale(d,{calendar:{lastDay:NelioContent.i18n.dates.lastDay,sameDay:NelioContent.i18n.dates.sameDay,nextDay:NelioContent.i18n.dates.nextDay,lastWeek:NelioContent.i18n.dates.lastWeek,nextWeek:NelioContent.i18n.dates.nextWeek,sameElse:NelioContent.i18n.dates.default},week:{dow:NelioContent.i18n.startOfWeek}}),NelioContent.misc.nonReferenceDomains=_.map(NelioContent.misc.nonReferenceDomains,function(e){return e=(e=(e=e.replace(/\./g,"\\.")).replace(/\*$/,"[^/]+")).replace(/\*/g,"[^/]*"),e=new RegExp("^[^:]+://[^/]*"+e)}),NelioContent.models.Model=Backbone.Model.extend({clearToDefaults:function(){var e={silent:!0};return this.clear(e),"function"==typeof this.defaults?this.set(this.defaults(),e):this.set(this.defaults,e),this},sync:function(e,t,i){return(i=i||{}).beforeSend=function(e){e.setRequestHeader("Authorization","Bearer "+NelioContent.apiAuthToken)},Backbone.Model.prototype.sync.apply(this,arguments)}}),NelioContent.collections.Collection=Backbone.Collection.extend({sync:function(e,t,i){return(i=i||{}).beforeSend=function(e){e.setRequestHeader("Authorization","Bearer "+NelioContent.apiAuthToken)},Backbone.Collection.prototype.sync.apply(this,arguments)}}),NelioContent.helpers.getTemplate=function(e){var t=document.getElementById(e);return t?NelioContent.helpers.template(t.innerHTML):(console.warn("Template «"+e+"» not found. Using empty template."),NelioContent.helpers.template(""))},NelioContent.helpers.template=function(e){return _.template(NelioContent.helpers.trim(e),{evaluate:/\[\*([\s\S]+?)\*\]/g,interpolate:/\[\*=([\s\S]+?)\*\]/g,escape:/\[\*~([\s\S]+?)\*\]/g})},e=jQuery,s=-1,NelioContent.helpers.chunk=function(e,t){for(var i=[],n=0;n<e.length;n+=t)i.push(e.slice(n,n+t));return i},NelioContent.helpers.isGutenbergActive=function(){return!!(wp&&wp.data&&wp.data.select("core/editor"))},NelioContent.helpers.refreshAuthToken=function(t,i){e.ajax({url:ajaxurl,data:{action:"nelio_content_get_api_auth_token"},success:function(e){NelioContent.apiAuthToken=e,"function"==typeof t&&t()},error:function(e){"function"==typeof i&&i(e)}})},NelioContent.helpers.isSubscribed=function(){return"none"!==NelioContent.subscription},NelioContent.helpers.getWindowWidth=function(){return e(window).width()},NelioContent.helpers.getScrollbarWidth=function(){if(0<=s)return s;var e=document.createElement("div");e.style.visibility="hidden",e.style.width="100px",e.style.msOverflowStyle="scrollbar",document.body.appendChild(e);var t=e.offsetWidth;e.style.overflow="scroll";var i=document.createElement("div");i.style.width="100%",e.appendChild(i);var n=i.offsetWidth;return e.parentNode.removeChild(e),s=t-n},NelioContent.helpers.openPopup=function(e,t,i){var n=void 0!==window.screenLeft?window.screenLeft:screen.left,s=void 0!==window.screenTop?window.screenTop:screen.top,o=(window.innerWidth?window.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width)/2-t/2+n,a=(window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:screen.height)/2-i/2+s,r=window.open(e,"","width="+t+", height="+i+", top="+a+", left="+o);return window.focus&&r.focus(),r},NelioContent.helpers.addStyle=function(e){var t=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css",i.styleSheet?i.styleSheet.cssText=e:i.appendChild(document.createTextNode(e)),t.appendChild(i)},NelioContent.helpers.callAndDebounce=function(e,t,i){function n(){e(),s=!0}"number"!=typeof i&&(i=0);var s=!1;0===i?n():setTimeout(n,i);var o=_.debounce(e,t);return function(){s&&o()}},NelioContent.helpers.getParamFromUrl=function(e,t){arguments.length<2&&(t=e,e=window.location.href);var i=e.split("?")[1]||"";i=i.split("&");for(var n=0;n<i.length;++n){var s=i[n];if(s===t)return"";if(0===s.indexOf(t+"="))return s.replace(t+"=","")}},NelioContent.helpers.addParamInUrl=function(e,t,i){var n=!1;arguments.length<3&&(i=t,t=e,e=window.location.href,n=!0);var s=e.split("?");e=s[0];var o,a=s[1]||"";for(a=a.split("&"),o=0;o<a.length;++o){var r=a[o];if(r===t||0===r.indexOf(t+"="))break}return a[o]=void 0===i?t:t+"="+encodeURIComponent(i),0<a.length&&(e+="?"+a.join("&")),n&&"function"==typeof history.replaceState&&history.replaceState(null,null,e),e},NelioContent.helpers.removeParamFromUrl=function(e,t){var i=!1;arguments.length<2&&(t=e,e=window.location.href,i=!0);var n=t;"string"==typeof n&&(n=[t]);var s=e.split("?");e=s[0];var o=s[1]||"";o=o.split("&");for(var a=0;a<o.length;++a)for(var r=o[a],l=0;l<n.length;++l)r!==(t=n[l])&&0!==r.indexOf(t+"=")||(o[a]=void 0);return 0<o.length&&(e+="?"+o.join("&").replace(/&+/g,"&").replace(/^&|&$/g,"")),i&&"function"==typeof history.replaceState&&history.replaceState(null,null,e),e},NelioContent.helpers.getSelection=function(e){if(void 0!==document.selection)return e.focus(),document.selection.createRange().text;if(void 0===e.selectionStart)return"";var t=e.selectionStart,i=e.selectionEnd;return e.value.substring(t,i)},NelioContent.helpers.getAbsoluteUrl=function(e){return/^\/\//.test(e)?"http:"+e:"/"===e[0]?NelioContent.blogUrl.replace(/^((https?:)?\/\/[^\/]+).*$/,"$1")+e:e},function(){NelioContent.helpers.trim=function(e){return null==e?"":"string"!=typeof e?e:e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},NelioContent.helpers.capitalizeFirstLetter=function(e){return"string"!=typeof e?"":e.charAt(0).toUpperCase()+e.slice(1)},NelioContent.helpers.strongify=function(e,t){t=(t=t.replace("\\","")).replace(".","\\.");var i=new RegExp(t,"gi");return e.replace(i,"<strong>$&</strong>")},NelioContent.helpers.getTweetLength=function(e){return e=e.replace(/[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f]/g,"aa"),twttr.txt.getTweetLength(e)};var t=document.createElement("div");NelioContent.helpers.decodeHTMLEntities=function(e){return"string"!=typeof e?"":(e=(e=e.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,"")).replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,""),t.innerHTML=e,e=t.textContent,NelioContent.helpers.trim(e))},NelioContent.helpers.extractFirstLetter=function(e){var t=latinize(e.toLowerCase()).replace(/[^a-z]/g,"");return 0<t.length?t.substring(0,1):"unknown"};var i=/^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;function n(e){if("BR"===e.tagName)return"\n";var t=[].slice.call(e.childNodes);if(t.length)return t.reverse(),_.reduce(t,function(e,t){var i=n(t);switch(t.tagName){case"OL":case"P":case"UL":/^\n/.test(e)||(e="\n\n"+e),/^\n\n/.test(e)||(e="\n"+e);break;case"ARTICLE":case"ASIDE":case"BLOCKQUOTE":case"DIV":case"H1":case"H2":case"H3":case"H4":case"H5":case"LI":case"P":/^\n/.test(e)||(e="\n"+e)}return i+e},"");var i=e.textContent||e.innerText||"";return"PRE"!==e.tagName&&(i=i.replace(/\r?\n/g,"")),i}function s(e){for(var t=0;t<e.length&&e[t];){var i=e[t];i.parentNode?i.parentNode.removeChild(i):++t}}function a(e,t){var i,n;if(!t)return!1;var s,o=function(e,t){var i,n;for(i=e.parentNode;i;i=i.parentNode)for(n=t.parentNode;n;n=n.parentNode)if(i===n)return i;return!1}(e,t);if(!o)return!1;for(i=e;r(i)&&i!==o;i=i.parentNode){for(n=t;r(n)&&n!==o;n=n.parentNode){if(s=n,i.nextSibling===s)return!0;if(n.previousSibling&&n.parentNode!==o)return!1}if(i.nextSibling&&i.parentNode!==o)return!1}return!1}NelioContent.helpers.isEmail=function(e){return i.test(e)},NelioContent.helpers.processHtml=function(e){var t=_.map(function(e){var t=document.createElement("div");t.innerHTML="<div>"+e+"</div>";var i,n=_.map(t.querySelectorAll("ncshare"));if(!n.length)return[];var s=[],o=0;for(;o<n.length;){for(i=[n[o]],++o;a(n[o-1],n[o]);)i.push(n[o]),++o;s.push(i)}return s}(e),function(e){var t=_.map(e,function(e){return e.textContent}).join(""),i=_.map(e,function(e){if(e.querySelector("a"))return e.innerHTML;var t=function(e){for(var t=e.parentNode;t;t=t.parentNode)if("a"===t.nodeName.toLowerCase())return t.getAttribute("href")||!1;return!1}(e);return t?'<a href="'+_.escape(t)+'">'+e.textContent+"</a>":e.textContent}).join("");return{text:NelioContent.helpers.trim(t),html:NelioContent.helpers.trim(i)}}),i=document.createElement("div");return i.innerHTML=e,s(i.getElementsByTagName("script")),s(i.getElementsByTagName("link")),s(i.getElementsByTagName("figcaption")),s(i.getElementsByTagName("caption")),s(i.getElementsByTagName("img")),s(i.getElementsByTagName("pre")),s(i.getElementsByTagName("style")),s(i.querySelectorAll("li li")),s(_.filter(i.getElementsByTagName("code"),function(e){return!!e.parentNode&&NelioContent.helpers.trim(e.textContent||e.innerText)===NelioContent.helpers.trim(e.parentNode.textContent||e.parentNode.innerText)})),_.each(i.getElementsByTagName("a"),function(e){e.textContent,e.textContent='<a href="'+e.getAttribute("href")+'">'+e.textContent+"</a>"}),{clean:n(i),highlights:_.uniq(t),top:_.union(_.map(i.getElementsByTagName("h1"),function(e){return e.textContent||e.innerText}),_.map(i.getElementsByTagName("h2"),function(e){return e.textContent||e.innerText}),_.map(i.getElementsByTagName("h3"),function(e){return e.textContent||e.innerText}),_.map(i.getElementsByTagName("strong"),function(e){return e.textContent||e.innerText}))}},NelioContent.helpers.htmlToText=function(e){var t=document.createElement("div");t.innerHTML=e;try{return n(t).replace(/\n\+$/,"")}catch(e){return t.textContent||t.innerText}};var o=["#comment","#text","ncshare","a","abbr","acronym","address","b","big","code","del","em","i","ins","mark","q","s","samp","small","span","strike","strong","sub","sup","time","u","var","wbr"];function r(e){return!!e&&_.includes(o,e.nodeName.toLowerCase())}}(),function(c){c.widget("ui.dialogS2",c.ui.dialog,{_allowInteraction:function(e){return!0}}),NelioContent.helpers.openDeletionConfirmationDialog=function(e,t,i,n){var s=c("<div>"+t+"</div>");return s.dialog({title:e,modal:!0,width:Math.min(500,c(window).width()-20),dialogClass:"nc-dialog",buttons:[{class:"button nc-cancel-button",text:NelioContent.i18n.actions.cancel,click:function(){s.dialog("close")}},{class:"button nc-super-delete-button",text:i,click:function(){n()}}]}),s},NelioContent.helpers.openConfirmationDialog=function(e,t,i,n){var s=c("<div>"+t+"</div>");return s.dialog({title:e,modal:!0,width:Math.min(500,c(window).width()-20),dialogClass:"nc-dialog",buttons:[{class:"button nc-cancel-button",text:NelioContent.i18n.actions.cancel,click:function(){s.dialog("close")}},{class:"button button-primary",text:i,click:function(){n()}}]}),s},NelioContent.helpers.openDialog=function(e,t){var i=c(t);return i.dialog({title:e,modal:!0,width:Math.min(500,c(window).width()-20),dialogClass:"nc-dialog",buttons:[{class:"button nc-cancel-button",text:NelioContent.i18n.actions.ok,click:function(){i.dialog("close"),i.dialog("destroy")}}]}),i};var n=[];NelioContent.helpers.openWarningDialog=function(e,t){var i=c('<div class="nc-error-dialog">'+(t='<span class="nc-dashicons nc-dashicons-warning"></span> '+t)+"</div>");i.dialog({title:e,modal:!0,autoOpen:!1,width:Math.min(500,c(window).width()-20),dialogClass:"nc-dialog",buttons:[{class:"button nc-cancel-button",text:NelioContent.i18n.actions.ok,click:function(){i.dialog("close"),i.dialog("destroy")}}],close:function(){n.shift(),n.length&&n[0].dialog("open")}}),n.push(i),n[0]===i&&i.dialog("open")},NelioContent.helpers.openErrorDialog=function(e){NelioContent.helpers.openWarningDialog(NelioContent.i18n.titles.error,e)},NelioContent.helpers.makeDialogButton=function(i,n,e,t){var s="button";return t&&(s="button button-primary"),{class:s+" nc-"+n+"-button",text:e,click:function(e){var t=e.target||e.srcElement;c(t).closest("button").hasClass("button-disabled")||i.trigger("nc:click:dialog:"+n,e)}}},NelioContent.helpers.makeDialogSaveButton=function(e,t){return NelioContent.helpers.makeDialogButton(e,"save",t,!0)},NelioContent.helpers.makeDialogCancelButton=function(e,t){return NelioContent.helpers.makeDialogButton(e,"cancel",t)},NelioContent.helpers.makeDialogDeleteButton=function(e,t){return NelioContent.helpers.makeDialogButton(e,"delete",t)},NelioContent.helpers.makeWarningTooltip=function(e){void 0!==e&&0!==e.length&&e.tooltip({position:{my:"right bottom",at:"right+5 top-5"},tooltipClass:"nc_tooltip nc_warning_tooltip",show:!1,hide:!1})},NelioContent.helpers.makeInfoTooltip=function(e){void 0!==e&&0!==e.length&&e.tooltip({position:{my:"center top",at:"center bottom+10"},tooltipClass:"nc_tooltip",show:!1,hide:!1})},NelioContent.helpers.startPointerTour=function(n,e){var s,a,o=0;function r(){a&&a.pointer("close"),o>=n.length?"function"==typeof e&&e():(s=n[o],++o,(a=c(s.target))||r(),l())}function l(){var e=s.title;1<n.length&&(e+=" ("+o+"/"+n.length+")"),a.pointer({content:"<h3>"+e+"</h3>"+s.content,buttons:t,position:s.position}),a&&(a.pointer("open"),setTimeout(function(){var e=c(window),t=a.offset(),i=e.scrollTop(),n=window.innerHeight,s=t.top,o=t.bottom;i<=s&&o<n||(s-=Math.round(Math.min(400,n/2)),c("html, body").animate({scrollTop:s},500))},50))}function t(){var e='<a class="nc-previous" href="#">'+_.escape(NelioContent.i18n.actions.previous)+"</a>";o<=1&&(e="");var t='<a class="nc-next" href="#">'+_.escape(NelioContent.i18n.actions.next)+"</a>";o===n.length&&(t='<a class="close" href="#">'+_.escape(NelioContent.i18n.actions.close)+"</a>");var i=jQuery('<div class="nc-buttons">'+e+t+"</div>");return i.find("a.nc-previous").on("click",function(e){e.preventDefault(),function e(){if(a&&a.pointer("destroy"),o<=1)return o=0,void r();s=n[o-2],--o,(a=c(s.target))||e(),l()}()}),i.find("a:not( .nc-previous )").on("click",function(e){e.preventDefault(),r()}),i}r()}}(jQuery),jQuery,NelioContent.helpers.selectImage=function(t){void 0===t&&(t={}),"function"!=typeof t.onSelection&&(t.onSelection=function(){});var i=wp.media.frames.shareImageFrame=wp.media({title:NelioContent.i18n.titles.selectImage,button:{text:NelioContent.i18n.actions.choose},multiple:!1});i.on("select",function(){var e=i.state().get("selection").first().toJSON();t.onSelection(e)}),"number"==typeof t.image&&i.on("open",function(){var e=wp.media.attachment(t.image);i.state().get("selection").add(e)}),"function"==typeof t.onClose&&i.on("close",t.onClose),i.open()},jQuery,t=/[12][0-9][0-9][0-9]-[01][0-9]-[0-3][0-9]/,i=/[012][0-9]:[0-5][0-9]/,window.ncLocalizeMoment=function(e,t){return void 0===t&&(t=NelioContent.i18n.timezone),0<t.indexOf(":")?e.utcOffset(t):e.tz(t),e},window.ncNewLocalMoment=function(e,t){return"string"==typeof e&&""!==NelioContent.helpers.trim(e)||(e=ncLocalizeMoment(ncmoment()).format("YYYY-MM-DD HH:mm")),/^[0-9]{4}.[0-9]{2}.[0-9]{2}/.test(e)&&!/^[0-9]{4}.[0-9]{2}.[0-9]{2}.[0-9]{2}:[0-9]/.test(e)&&(e=NelioContent.helpers.trim(e)+" 12:00"),void 0===t&&(t=NelioContent.i18n.timezone),0<t.indexOf(":")?ncLocalizeMoment(ncmoment(e+t),t):ncLocalizeMoment(ncmoment.tz(e,t),t)},NelioContent.helpers.isDate=function(e){return t.test(e)},NelioContent.helpers.isTime=function(e){return i.test(e)},NelioContent.helpers.getTimeInterval=function(e){var t,i,n;switch(e){case"all":i=t=void 0;break;case"month-to-date":t=ncmoment().date(1).format("YYYY-MM-DD"),i=ncmoment().format("YYYY-MM-DD");break;case"last-30-days":t=ncmoment().add(-30,"days").format("YYYY-MM-DD"),i=ncmoment().format("YYYY-MM-DD");break;case"last-month":t=(n=ncmoment().add(-1,"months")).startOf("month").format("YYYY-MM-DD"),i=n.endOf("month").format("YYYY-MM-DD");break;case"year-to-date":t=ncmoment().startOf("year").format("YYYY-MM-DD"),i=ncmoment().format("YYYY-MM-DD");break;case"last-12-months":t=ncmoment().add(-12,"months").format("YYYY-MM-DD"),i=ncmoment().format("YYYY-MM-DD");break;case"last-year":t=(n=ncmoment().add(-1,"years")).startOf("year").format("YYYY-MM-DD"),i=n.endOf("year").format("YYYY-MM-DD")}return{from:t,to:i,mode:e}},jQuery,a=/<a[^>]+href=("[^"]*"|'[^']*')/gi,n=/<img[^>]+src=("[^"]*"|'[^']*')/gi,r=[],l=["jpg","png","tif","bmp","svg","pgm","pbm","pnm","hdr","bpg","cpt","psd","psp","xcf","ppm","dwf","dwg","dxf","jpeg","tiff","webp","heif","mkv","flv","avi","mov","vob","ogv","ogg","drc","mng","mov","wmv","yuv","asf","mp4","m4p","m4v","mpg","mpe","mpv","mp2","m2v","m4v","svi","3gp","3g2","mxf","roq","nsv","f4v","f4p","f4a","f4b","rm","qt","webm","gifv","rmvb","mpeg","zip","rar","3ds","x3d","xgl","pub","7z","po","pot","js","css","scss"],NelioContent.helpers.countImages=function(e){if(""===e||!e)return 0;var t=e.match(n);return null==t?0:t.length},NelioContent.helpers.extractReferences=function(e){for(var t,i=[];t=a.exec(e);){var n=t[1];u(n=n.substring(1,n.length-1))&&!_.contains(i,n)&&i.push(n)}return i},NelioContent.helpers.isExternalReference=function(e){var t=NelioContent.blogUrl.toLowerCase().replace(/^https:/,"http:");return-1===(e=e.toLowerCase().replace("https","http")).indexOf(t)&&/^[a-zA-Z]+:\/\//.test(e)},c=jQuery,NelioContent.helpers.buildPostFilter=function(e,t){var i;void 0===t&&(t=!1),"remove-none-option"===t&&e.find("option[value=none]").remove(),e.ncselect2({width:"15em",templateSelection:function(e){switch(e.id){case"all":return 1<NelioContent.postTypes.length?NelioContent.i18n.filters.selection.allPostTypes:NelioContent.postTypes[0].labels.allItems;case"none":return i='<span class="nc-dashicons nc-dashicons-hidden"></span> ',1===NelioContent.postTypes.length&&"post"===NelioContent.postTypes[0].name?c("<span>"+i+NelioContent.i18n.filters.selection.noPosts+"</span>"):c("<span>"+i+NelioContent.i18n.filters.selection.noPostTypes+"</span>");default:return i="post"===e.id?'<span class="nc-dashicons nc-dashicons-admin-post"></span> ':"page"===e.id?'<span class="nc-dashicons nc-dashicons-admin-page"></span> ':'<span class="nc-dashicons nc-dashicons-marker"></span> ',c("<span>"+i+e.text+"</span>")}}})},setInterval(NelioContent.helpers.refreshAuthToken,6e5),NelioContent.models.User=Backbone.Model.extend({defaults:{email:"",name:NelioContent.i18n.errors.generic.unknownUserName,photo:"",role:"subscriber",loading:!1,existsInWordPress:!0},initialize:function(){this.listenTo(this,"change:name",this._setFirstLetter),this._setFirstLetter()},loadData:function(){if(!this.get("loading")){if(!this.get("id"))return this.set("loading",!1),void this.set("existsInWordPress",!1);this.set("loading",!0);var t=this;o.ajax({url:ajaxurl,data:{action:"nelio_content_get_user",user:t.get("id")},success:function(e){e.loading=!1,e.existsInWordPress=!0,t.set(e),t.trigger("nc:load")},error:function(){t.set({loading:!1,existsInWordPress:!1}),t.trigger("nc:load:error")}})}},valid:function(){return!this.get("loading")&&this.get("existsInWordPress")},isLoading:function(){return this.get("loading")},_setFirstLetter:function(){var e=this.get("name");e===NelioContent.i18n.errors.generic.unknownUserName&&(e=""),this.set("firstLetter",NelioContent.helpers.extractFirstLetter(e))}}),NelioContent.collections.Users=Backbone.Collection.extend({model:NelioContent.models.User,current:function(){return this.get(NelioContent.userId)},getUser:function(e){var t=this.get(e);return void 0===t&&((t=new NelioContent.models.User({id:e})).loadData(),this.add(t)),t}}),NelioContent.users=new NelioContent.collections.Users(NelioContent.users),NelioContent.models.AjaxError=Backbone.Model.extend({defaults:function(){return{code:0,message:""}},initialize:function(){},parseResponse:function(e){var t=503,i=NelioContent.i18n.errors.api.emptyAjaxStatus;0!==e.status&&(t=e.status),"string"==typeof e.responseJSON&&(i=e.responseJSON),this.set("code",t),this.set("message",i)}}),NelioContent.models.Post=Backbone.Model.extend({defaults:function(){return{id:0,type:NelioContent.postTypes[0].name,status:"draft",calendarKind:"post",title:"",excerpt:"",editLink:"",permalink:"",categories:[],titleFormatted:"",excerptFormatted:"",author:0,autoImage:"",imageId:0,image:"",date:!1,statistics:!1,followers:[],socialQueueError:!1,timeSinceLastShare:!1,publishCount:"&ndash;",scheduleCount:!1}},initialize:function(){this.listenTo(this,"change:permalink",this._fixPermalink),this._fixPermalink(),this.listenTo(this,"change:id",this._fixPostIdType),this._fixPostIdType(),this.listenTo(this,"change:imageId",this._fixImageIdType),this._fixImageIdType(),this.listenTo(this,"change:date",this._fixDateFormat),this._fixDateFormat(),this.listenTo(this,"change:title",this._escapeTitle),this.listenTo(this,"change:excerpt",this._escapeExcerpt),this._maybeUnescapeTitleAndExcerpt(),"post"===this.get("type")&&0===this.get("categories").length&&this.set("categories",[NelioContent.categories[0].id])},isPublished:function(){return"publish"===this.get("status")},isScheduled:function(){return!this.isPublished()&&!(!this.get("date")||!ncNewLocalMoment().isBefore(this.get("date")))},getDateForSorting:function(){return this.get("date").format("YYYY-MM-DDTHH:mm")},getRelevantDay:function(){return!!this.get("date")&&this.get("date").format("YYYY-MM-DD")},reschedule:function(e){if(this.get("date")&&this.get("date").format("YYYY-MM-DD")===e)this.trigger("nc:abort:reschedule");else{var t=this;o.ajax({url:ajaxurl,data:{action:"nelio_content_reschedule_post",post:this.get("id"),date:e},success:function(e){t.set(e),t.trigger("nc:reschedule")},error:function(e){t.trigger("nc:error",e.responseJSON)}})}},isLoading:function(){return this.get("loading")},trash:function(){var t=this;o.ajax({url:ajaxurl,data:{action:"nelio_content_trash_post",post:this.get("id")},success:function(){t.trigger("nc:trash")},error:function(e){t.trigger("nc:error",e.responseJSON)}})},_fixPostIdType:function(){this.stopListening(this,"change:id",this._fixPostIdType);var e=this.get("id");"string"==typeof e&&(e=parseInt(e),isNaN(e)?(this.set("id",0),this.set("status","draft"),this.set("title",""),this.set("permalink",""),this.set("excerpt","")):this.set("id",e)),this.listenTo(this,"change:id",this._fixPostIdType)},_fixImageIdType:function(){this.stopListening(this,"change:imageId",this._fixImageIdType);var e=this.get("imageId");e=parseInt(e),isNaN(e)||this.set("imageId",e),this.listenTo(this,"change:imageId",this._fixImageIdType)},_fixDateFormat:function(){var e=this.get("date");"string"==typeof e&&this.set("date",ncNewLocalMoment(e))},_fixPermalink:function(){if(""!==NelioContent.helpers.trim(NelioContent.blogUrl)){var e=this.get("permalink");void 0!==e&&""!==NelioContent.helpers.trim(e)||(e=NelioContent.blogUrl),this.set("permalink",NelioContent.helpers.getAbsoluteUrl(e))}},_escapeTitle:function(){this.set("titleFormatted",_.escape(this.get("title")))},_escapeExcerpt:function(){this.set("excerptFormatted",_.escape(this.get("excerpt")))},_maybeUnescapeTitleAndExcerpt:function(){var e=this.get("title");void 0!==e&&0!==NelioContent.helpers.trim(e).length||this.set("title",NelioContent.helpers.decodeHTMLEntities(this.get("titleFormatted")));var t=this.get("excerpt");void 0!==t&&0!==NelioContent.helpers.trim(t).length||this.set("excerpt",NelioContent.helpers.decodeHTMLEntities(this.get("excerptFormatted")))}});var p=ncNewLocalMoment();NelioContent.models.SocialMessage=NelioContent.models.Model.extend({urlRoot:NelioContent.apiUri+"/social",defaults:function(){return{siteId:"",profileId:"",targetName:"default",targetDisplayName:"",profiles:[],network:"twitter",networkKind:"single",calendarKind:"social",type:"text",status:"draft",source:"manual",isFreePreview:!1,postId:0,postType:NelioContent.postTypes[0].name,baseDatetime:"none",dateType:"predefined-offset",dateValue:"0",timeType:"predefined-offset",timeValue:"0",timezone:NelioContent.i18n.timezone,schedule:p.toISOString(),text:"",textComputed:"",mentions:[],image:"",imageId:0,sent:!1,sentTime:0,sentResponse:"",sentAttempts:0,nextAttemptTimestamp:0,failureDescription:"",url:"",_previewUrl:"",timestamp:0}},post:void 0,initialize:function(e,t){this.listenTo(this,"change:text",this._updateTextLengthInAllNetworks),this.listenTo(this,"change:text",this._computeText),this.listenTo(this,"change:network",this._updateActiveNetworkMetas),this.listenTo(this,"change:profiles",this._updateActiveNetworkMetas),this.listenTo(this,"change:textComputed",this._extractRelevantUrl),this.listenTo(this,"change:network",this._extractRelevantUrl),this.listenTo(this,"change:profileId",this._fixProfileInformation),this.listenTo(this,"change:schedule",this._fixScheduleFormat),this.listenTo(this,"change:dateType",this._setBaseDatetime),this.listenTo(this,"change:dateValue",this._fixSchedule),this.listenTo(this,"change:timeValue",this._fixSchedule),this.listenTo(this,"change:postId",this._setDefaultText),this.listenTo(this,"change:image",this._fixImageUrl),this.listenTo(this,"change:auto",this._maybeFixSource),this._fixScheduleFormat(),(t=t||{}).enableFastInit||this.completeInitialization()},completeInitialization:function(){this.__isInitComplete||(this.__isInitComplete=!0,this.post=new NelioContent.models.Post,this._computeText(),this._updateActiveNetworkMetas(),this._extractRelevantUrl(),this._fixProfileInformation(),this._setBaseDatetime(),this._fixImageUrl(),this._maybeFixSource())},setPost:function(e){this.stopListening(this.post),this.post=e,this.set("postId",this.post.get("id")),this.set("postType",this.post.get("type")),this._setBaseDatetime(),this._fixSchedule(),this.listenTo(this.post,"change:dateType",this._setBaseDatetime),this.trigger("change:text"),this.trigger("change:textComputed")},loadPost:function(){if(0!==this.get("postId"))if(this.post&&this.get("postId")===this.post.get("id"))this.trigger("nc:load:post");else{var t=this;o.ajax({url:ajaxurl,data:{action:"nelio_content_get_post",post:this.get("postId")},success:function(e){t.setPost(new NelioContent.models.Post(e)),t.trigger("nc:load:post")},error:function(e){t.trigger("nc:error:post",e.responseJSON)}})}else this.trigger("nc:load:post")},getTextLength:function(){var e=this._getRelevantNetworkForTextLength();return this.__textLengthPerNetwork[e].value},getMaxTextLength:function(){var e=this._getRelevantNetworkForTextLength();return this.__textLengthPerNetwork[e].max},isTextTooLong:function(){return this.getTextLength()>this.getMaxTextLength()},getDateForSorting:function(){var e="";if(this.post&&(this.post.isPublished()||this.post.isScheduled())){e+=this.get("schedule").format("YYYY-MM-DDTHH:mm")}else{if("exact"===this.get("dateType"))e+=this.get("dateValue");else{var t="Z0000000"+this.get("dateValue");e+=t.substr(t.length-6)}if("exact"===this.get("timeType"))e+=this.get("timeValue");else{var i="Z0000000"+this.get("timeValue");e+=i.substr(i.length-6)}}return e.toLowerCase()},getRelevantDay:function(){return this.get("schedule").format("YYYY-MM-DD")},isSomethingMissing:function(){if(NelioContent.helpers.trim(this.get("text"))<=0)return NelioContent.i18n.errors.socialMessage.noMessage;if(this.isTextTooLong())return NelioContent.i18n.errors.socialMessage.messageTooLong;if(this.isNew()&&this.get("profiles").length<=0)return NelioContent.i18n.errors.socialMessage.noProfiles;var t,e,i,n=!1;if(this.isNew()?_.each(this.get("profiles"),function(e){void 0!==(t=NelioContent.profiles.get(e.id))&&(n=n||t.requiresImageToShare())}):void 0!==(t=NelioContent.profiles.get(this.get("profileId")))&&(n=t.requiresImageToShare()),n&&"image"!==this.get("type"))return this.isNew()&&1<this.get("profiles").length?NelioContent.i18n.errors.socialMessage.noImageMultiple:NelioContent.i18n.errors.socialMessage.noImageSingle;if(NelioContent.helpers.trim(this.get("targetName"))<=0)return NelioContent.i18n.errors.socialMessage.noTarget;if("exact"===this.get("dateType")){if(!NelioContent.helpers.isDate(this.get("dateValue")))return NelioContent.i18n.errors.datetime.invalidDate}else if(""===NelioContent.helpers.trim(this.get("dateValue")))return NelioContent.i18n.errors.datetime.noDate;if("exact"===this.get("timeType")){if(!NelioContent.helpers.isTime(this.get("timeValue")))return NelioContent.i18n.errors.datetime.invalidTime}else if(""===NelioContent.helpers.trim(this.get("timeValue")))return NelioContent.i18n.errors.datetime.noTime;if("exact"===this.get("dateType")){if("exact"===this.get("timeType"))i=this.get("timeValue");else if("time-interval"===this.get("timeType"))switch(this.get("timeValue")){case"night":i="23:00";break;case"afternoon":i="19:00";break;case"noon":i="15:00";break;default:i="11:00"}else i="12:00";if(e=this.get("dateValue")+" "+i,(e=ncNewLocalMoment(e)).isBefore(ncNewLocalMoment()))return NelioContent.i18n.errors.datetime.noPastAllowed}return!(!this.post||0!==this.post.get("id")&&!this.post.isPublished()||"0"!==this.get("dateValue")||"exact"!==this.get("timeType")||(e=(e=ncNewLocalMoment().format("YYYY-MM-DD"))+" "+this.get("timeValue"),e=ncNewLocalMoment(e),!ncNewLocalMoment().isAfter(e)))&&NelioContent.i18n.errors.datetime.noPastAllowed},reschedule:function(e){if(this.stopListening(this,"change:dateValue",this._fixSchedule),this.stopListening(this,"change:timeValue",this._fixSchedule),"exact"===this.get("dateType")){if(this.get("dateValue")===e)return void this.trigger("nc:abort:reschedule");this.set("dateValue",e);var t=this.get("schedule").format("HH:mm");this.set("schedule",e+" "+t)}else{var i=ncNewLocalMoment(this.get("schedule").format("YYYY-MM-DD")+"T12:00:00.000"),n=ncNewLocalMoment(e+"T12:00:00.000"),s=this.get("schedule").format("HH:mm"),o=n.diff(i,"d");if(0===o)return void this.trigger("nc:abort:reschedule");var a=parseInt(this.get("dateValue"),10),r=a+o;if(r<0)return void this.trigger("nc:abort:reschedule",{title:NelioContent.i18n.titles.invalidSocialScheduling,content:NelioContent.i18n.dialogs.invalidSocialScheduling});switch(r){case 0:this.set("dateType","predefined-offset"),this.set("dateValue","0");break;case 1:this.set("dateType","predefined-offset"),this.set("dateValue","1");break;default:this.set("dateType","positive-days"),this.set("dateValue",""+r)}0===a&&"exact"!==this.get("timeType")&&"time-interval"!==this.get("timeType")&&(this.set("timeType","exact"),this.set("timeValue",s)),this.get("schedule").add(o,"d")}this.set("baseDatetime","reschedule"),this.save(void 0,{success:function(e,t){var i=[];void 0!==t.modifiedMessages&&(i=t.modifiedMessages,delete t.modifiedMessages),e.set(t),e._setBaseDatetime(),e.trigger("nc:reschedule",i)},error:function(e){e.trigger("nc:error")}}),this.listenTo(this,"change:dateValue",this._fixSchedule),this.listenTo(this,"change:timeValue",this._fixSchedule)},shareNow:function(){if("error"===this.get("status")){this.set("status","_awaitingEnqueueConfirmation");var t=this;o.ajax({url:NelioContent.apiUri+"/social/"+this.get("id")+"/retry",method:"PUT",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},success:function(e){"schedule"===e.status&&(e.status="_enqueued"),t.set(e)},error:function(){t.set("status","_awaitingEnqueueConfirmation"),t.trigger("nc:error")}})}else this.trigger("nc:error")},getHighlightedText:function(){return this._highlightText(this.get("textComputed"))},getPreviewText:function(){var e="",t="";this.post&&(e=this.post.get("title"),t=this.post.get("permalink"));var i=this.get("text");return i=(i=i.replace(/\{title\}/g,e)).replace(/\{permalink\}/g,t),i=this._wrapMentionsInSpaces(i),this._highlightText(i)},getPreviewTextForCalendar:function(){var e=this.get("textComputed");return e=this._wrapMentionsInSpaces(e),e=(e=this._highlightText(e)).replace(/<br>/g," ")},addNewMention:function(i){var e=this.get("mentions");_.reduce(e,function(e,t){return e||t.network===i.network&&t.networkId===i.networkId},!1)||(e.push(i),this.set("mentions",e))},getEditableHtmlText:function(){var i=this.get("text").replace(/\n/g,"<br>"),e=this.get("mentions"),n=NelioContent.helpers.getTemplate("_nc-mention-in-editor");return _.each(e,function(e){var t;i=(t="facebook"===e.network?new RegExp("@\\[facebook:"+e.networkId+"\\]","g"):new RegExp("@\\["+e.network+":"+e.username+"\\]","g"),i.replace(t,'<span contenteditable="false">'+n(e)+"</span>"))}),i},_wrapMentionsInSpaces:function(e){return e=(e=(e=(e=" "+e+" ").replace(/([^\s])(@\[[a-z]+:[^\]]+\])/g,"$1 $2")).replace(/(@\[[a-z]+:[^\]]+\])([a-zA-Z0-9_])/g,"$1 $2")).substring(1,e.length-1)},_highlightText:function(e){return e=(e=(e=" "+e+" ").replace(/\r\n/g,"\n")).replace(/\n/g," \n "),e=(e=(e=(e=_.escape(e)).replace(/(\s)(https?:\/\/[^\s]+)/g,'$1<a class="nc-link">$2</a>')).replace(twttr.txt.regexen.validHashtag,' <span class="nc-hash">#$3</span>')).replace(/#([0-9]+)/g,' <span class="nc-num-hash">#$1</span>'),e=this._highlightRelevantMentionsInCurrentNetwork(e),e=(e=(e=(e=this._expandMentions(e,this.get("network"))).replace(/ \n /g,"\n")).replace(/\n/g,"<br>")).substring(1,e.length-1)},_highlightRelevantMentionsInCurrentNetwork:function(e){return"facebook"===this.get("network")?"page"===this.get("networkKind")&&(e=e.replace(/(@\[facebook:[0-9]+\])/g,'<span class="nc-mention">$1</span>')):e=(e=e.replace(/(@\[[a-z]+:[a-zA-Z0-9_]+\])/g,'<span class="nc-mention">$1</span>')).replace(twttr.txt.regexen.validMentionOrList,'$1<span class="nc-mention">$2$3</span>'),e},_expandMentions:function(t,i){var n;return _.each(this.get("mentions"),function(e){switch(e.network){case"facebook":n=new RegExp("@\\[facebook:"+e.networkId+"\\]","g"),t=t.replace(n,_.escape(e.displayName));break;case"twitter":t="twitter"===i?(n=new RegExp("@\\[twitter:"+e.username+"\\]","g"),t.replace(n,"@"+e.username)):(n=new RegExp("@\\[twitter:"+e.username+"\\]","g"),t.replace(n,_.escape(e.displayName)));break;default:n=new RegExp("@\\["+e.network+":"+e.username+"\\]","g"),t=t.replace(n,"@"+e.username)}}),t=t.replace(/@\[([a-z]+):([^\]\s]+)\]/g,"@$2")},_updateActiveNetworkMetas:function(){var t=[];if(this.isNew()){var e=_.map(_.pluck(this.get("profiles"),"id"),function(e){var t=NelioContent.profiles.get(e);return t?t.toJSON():{network:!1}});t=_.uniq(_.pluck(e,"network"))}t.length||(t=[this.get("network")]);var i=_.filter(NelioContent.networkMetas,function(e){return _.contains(t,e.id)});this.__textLengthPerNetwork={},_.each(i,_.bind(function(e){this.__textLengthPerNetwork[e.id]={value:this._computeTextLengthIn(e.id),max:e.maxLength}},this))},_updateTextLengthInAllNetworks:function(){_.mapObject(this.__textLengthPerNetwork,_.bind(function(e,t){e.value=this._computeTextLengthIn(t)},this))},_computeTextLengthIn:function(e){var t;return t=this.post&&0<this.post.get("id")?(t=(t=this.get("text")).replace(/\{title\}/g,this.post.get("title"))).replace(/\{permalink\}/g,this.post.get("permalink")):this.get("textComputed"),"image"===this.get("type")&&(t+=" https://neliosoftware.com/wp-content/image.jpg"),t=this._wrapMentionsInSpaces(t),t=this._expandMentions(t,e),NelioContent.helpers.getTweetLength(t)},_getRelevantNetworkForTextLength:function(){var n=!1,s=1/0;return _.mapObject(this.__textLengthPerNetwork,function(e,t){var i=e.max-e.value;i<s&&(s=i,n=t)}),n},_fixProfileInformation:function(){var e=NelioContent.profiles.get(this.get("profileId"));void 0!==e&&(this.set("network",e.get("network")),this.set("networkKind",e.get("kind")))},_computeText:function(){var e=this.get("text");if(0===this.get("postId"))this.set("textComputed",e);else if(this.post&&0<this.post.get("id")){e=e.replace(/\{permalink\}/g,this.post.get("permalink"));var t=this.post.get("title"),i=e.replace(/\{title\}/g,t);"image"===this.get("type")&&(i+=" https://neliosoftware.com/wp-content/image.jpg");var n=Math.max(NelioContent.helpers.getTweetLength(i)-this.getMaxTextLength(),0);n&&(t=t.slice(0,-n-1),t+="…"),e=e.replace(/\{title\}/g,t),this.set("textComputed",e)}},_extractRelevantUrl:function(){var e=" "+this.get("textComputed");this.post&&0<this.post.get("id")&&(e=(e=(e=(e=" "+this.get("text")).replace(/\n/g,"\n ")).replace(/\{title\}/g,this.post.get("title"))).replace(/\{permalink\}/g,this.post.get("permalink")));var t="",i=e.match(/\s(https?:\/\/[^\s]+)/g);if(null===i)return this.post&&this.post.get("permalink")&&(t=this.post.get("permalink")),this.set("_previewUrl",""),void this.set("url",t);switch(this.get("network")){case"twitter":t=i[i.length-1];break;default:t=i[0]}t=NelioContent.helpers.trim(t),this.set("_previewUrl",t),this.set("url",t)},_fixSchedule:function(){if("publish"!==this.get("status")&&(!(0<this.get("postId")&&this.post)||this.post.isPublished()||this.post.isScheduled())){var e;e=0===this.get("postId")||this.post&&this.post.isPublished()?ncNewLocalMoment():this.post.get("date").clone();var t="";if(t="exact"===this.get("dateType")?this.get("dateValue"):(e.add(this.get("dateValue"),"d"),e.format("YYYY-MM-DD")),NelioContent.helpers.isDate(t))if("exact"===this.get("timeType")){if(!NelioContent.helpers.isTime(this.get("timeValue")))return;t+=" "+this.get("timeValue"),this.set("schedule",ncNewLocalMoment(t))}else if("time-interval"===this.get("timeType")){var i="08:00";switch(this.get("timeValue")){case"morning":i="09:00";break;case"noon":i="13:00";break;case"afternoon":i="17:00";break;case"night":i="21:00"}t+=" "+i,this.set("schedule",ncNewLocalMoment(t))}else e.add(this.get("timeValue"),"h"),this.set("schedule",e)}},_fixImageUrl:function(){var e=this.get("image");"string"==typeof e&&this.set("image",NelioContent.helpers.getAbsoluteUrl(e))},_maybeFixSource:function(){if(void 0===this.get("source"))switch(this.get("auto")){case"publication":this.set("source","publication-template");break;case"timeline":case"reshare":this.set("source","reshare-template");break;default:this.set("source","manual")}},_fixScheduleFormat:function(){var e=this.get("schedule");"string"==typeof e&&this.set("schedule",ncNewLocalMoment(e))},_setBaseDatetime:function(){this.post&&(0===this.post.get("id")||this.post.isPublished())?"exact"===this.get("dateType")?this.set("baseDatetime","none"):this.set("baseDatetime","now"):this.post&&this.post.isScheduled()?"exact"===this.get("dateType")?this.set("baseDatetime","none"):this.set("baseDatetime",this.post.get("date").clone()):this.set("baseDatetime","none")},_setDefaultText:function(){var e=NelioContent.helpers.trim(this.get("text"));0<this.get("postId")&&0===e.length&&this.set("text","{title} {permalink}")}}),NelioContent.models.Reference=Backbone.Model.extend({_lastMatchingRegExp:void 0,_regExps:[],defaults:{id:"",title:"",titleFormatted:"",url:"",urlFormatted:"",date:"",author:"",email:"",twitter:"",isInPostContent:!1,status:"pending",suggestionAdvisorDisplayName:"",suggestionAdvisorId:-1,suggestionDate:"",isExternal:!0},initialize:function(){this._lastMatchingRegExp=/a^/,this._generateRegExps(),this.listenTo(this,"change:url",this._generateRegExps),this.listenTo(this,"change",this._escapeFields),this._escapeFields()},isSomethingMissing:function(){var e=this.get("url");if(void 0===e||0===NelioContent.helpers.trim(e).length)return NelioContent.i18n.errors.reference.noUrl;var t=this.get("twitter");if("string"==typeof t&&2<=(t=NelioContent.helpers.trim(t)).length&&"@"!==t.substr(0,1))return NelioContent.i18n.errors.reference.invalidTwitter;var i=this.get("email");if("string"==typeof i&&0<(i=NelioContent.helpers.trim(i).toUpperCase()).length){if(!/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/.test(i))return NelioContent.i18n.errors.reference.invalidMail}return!1},testIfIsInPostContent:function(t){this.get("url");if(this._lastMatchingRegExp.test(t))this.set("isInPostContent",!0);else{var i=!1;_.each(this._regExps,function(e){if(e.test(t))return i=!0,void(this._lastMatchingRegExp=e)},this),this.set("isInPostContent",i)}},autoload:function(){if("pending"===this.get("status")){var t=this;o.ajax({url:ajaxurl,data:{action:"nelio_content_autoload_reference",url:this.get("url")},success:function(e){t.set(e)}})}},_generateRegExps:function(){var e=this.get("url");if(0===e.length)this._regExps=[];else{var t=_.escape(e);this._regExps=[new RegExp('"'+e+'"',"i"),new RegExp('"'+t+'"',"i"),new RegExp("'"+e+"'","i"),new RegExp("'"+t+"'","i")]}},_escapeFields:function(){_.each(["author","url","title"],function(e){this.set(e+"Escaped",_.escape(this.get(e)))},this)}}),NelioContent.collections.References=Backbone.Collection.extend({model:NelioContent.models.Reference,post:new NelioContent.models.Post,initialize:function(){this._onAdd=_.bind(this._onAdd,this),this._onRemove=_.bind(this._onRemove,this),this._onReset=_.bind(this._onReset,this),this.listenTo(this,"add",this._onAdd),this.listenTo(this,"remove",this._onRemove),this.listenTo(this,"reset",this._onReset)},suggestReference:function(i){if(void 0===this.get(i.id)){var e=NelioContent.users.current();"function"==typeof i.set?-1===i.get("suggestionAdvisorId")&&(i.set("suggestionAdvisorDisplayName",e.get("name")),i.set("suggestionAdvisorId",e.get("id"))):void 0!==i.suggestionAdvisorId&&-1!==i.suggestionAdvisorId||(i.suggestionAdvisorDisplayName=e.get("name"),i.suggestionAdvisorId=e.get("id")),i=this.add(i),this.listenTo(i,"nc:discard",this.discardReference);var n=this;o.ajax({url:ajaxurl,data:{action:"nelio_content_suggest_post_reference",post:this.post.get("id"),url:i.get("url")},success:function(e){i.set(e)},error:function(e){var t=NelioContent.i18n.errors.reference.notSuggested+" "+e.responseJSON;NelioContent.helpers.openErrorDialog(t),n.remove(i)}})}},discardReference:function(t){var i=t.get("status");t.set("status","_discarding");var n=this;o.ajax({url:ajaxurl,data:{action:"nelio_content_discard_post_reference",post:this.post.get("id"),reference:t.get("postId")},success:function(e){n.remove(t)},error:function(e){var t=NelioContent.i18n.errors.reference.notDiscarded+" "+e.responseJSON;NelioContent.helpers.openErrorDialog(t),this.set("status",i)}})},includeReferences:function(e){var t=this;if((e=_.reject(e,function(e){return t.get(e)})).length){var i=this.add(_.map(e,function(e){return{id:e,url:e,status:"improvable"}}));_.each(i,function(e){t._addPostReference(e)})}},removeIncludedReferences:function(e){if(e.length){var t=this.remove(e),i=this;_.each(t,function(e){i._removePostReference(e)})}},setPost:function(e){this.post=e},_onAdd:function(e){this.listenTo(e,"nc:discard",this.discardReference),e.autoload()},_onRemove:function(e){this.stopListening(e)},_onReset:function(e,t){_.each(t.previousModels,this._onRemove),this.each(this._onAdd)},_addPostReference:function(t){o.ajax({url:ajaxurl,data:{action:"nelio_content_add_post_reference",post:this.post.get("id"),url:t.get("url")},success:function(e){t.set(e),t.autoload()}})},_removePostReference:function(e){o.ajax({url:ajaxurl,data:{action:"nelio_content_delete_post_reference_by_url",post:this.post.get("id"),url:e.get("url")}})}}),NelioContent.models.EditorialComment=NelioContent.models.Model.extend({urlRoot:NelioContent.apiUri+"/comment",defaults:function(){return{comment:"",date:ncNewLocalMoment(),authorId:NelioContent.users.current().get("id"),postId:0,postType:NelioContent.postTypes[0].name}},initialize:function(){this.listenTo(this,"change:date",this._fixDateFormat),this._fixDateFormat()},save:function(){if(this.isNew()){arguments[1]=arguments[1]||{};var t=arguments[1].success,i=this.toJSON();arguments[1].success=function(){var e={action:"nelio_content_new_comment",comment:i.comment,post_id:i.postId,author_id:i.authorId,date:i.date.toISOString()};o.ajax({url:ajaxurl,data:e}),"function"==typeof t&&t.apply(this,arguments)}}NelioContent.models.Model.prototype.save.apply(this,arguments)},_fixDateFormat:function(){var e=this.get("date");"string"==typeof e&&this.set("date",ncNewLocalMoment(e))}}),NelioContent.collections.EditorialComments=NelioContent.collections.Collection.extend({model:NelioContent.models.EditorialComment,post:void 0,initialize:function(){this.listenTo(this,"add",this._onAdd),this.listenTo(this,"remove",this._onRemove),this.listenTo(this,"reset",this._onReset)},setPost:function(e){this.post=e,this.each(function(e){e.set("postId",this.post.get("id")),e.set("postType",this.post.get("type"))},this)},_onAdd:function(e){this.listenTo(e,"destroy",this.remove),e.set("postId",this.post.get("id")),e.set("postType",this.post.get("type"))},_onRemove:function(e){this.stopListening(e)},_onReset:function(e,t){_.each(t.previousModels,this._onRemove,this),this.each(this._onAdd,this)}}),NelioContent.models.EditorialTask=NelioContent.models.Model.extend({urlRoot:NelioContent.apiUri+"/task",defaults:function(){return{task:"",completed:!1,color:"none",calendarKind:"task",postId:0,postType:NelioContent.postTypes[0].name,baseDatetime:"none",dateDue:ncNewLocalMoment(),dateType:"predefined-offset",dateValue:"0",timezone:NelioContent.i18n.timezone,assignerId:NelioContent.users.current().get("id"),assigneeId:NelioContent.users.current().get("id")}},post:new NelioContent.models.Post,initialize:function(){this.listenTo(this,"change:dateDue",this._fixDateDueFormat),this._fixDateDueFormat(),this.listenTo(this,"change:color",this._fixColor),this._fixColor(),this.listenTo(this,"change:completed",this._onCompletionChange)},save:function(){if(this.isNew()){arguments[1]=arguments[1]||{};var e=arguments[1].success,t=this;arguments[1].success=function(){t._sendNotification("new_task"),"function"==typeof e&&e.apply(this,arguments)}}NelioContent.models.Model.prototype.save.apply(this,arguments)},setPost:function(e){this.stopListening(this.post),this.post=e,this.set("postId",this.post.get("id")),this.set("postType",this.post.get("type")),this._setBaseDatetime(),this.listenTo(this.post,"change:dateType",this._setBaseDatetime)},toggleCompletionInAws:function(i){var n=this.get("completed");this.set("completed",!this.get("completed")),this.save(void 0,{success:function(e,t){e.set("completed",t.completed),!n&&e.get("completed")&&e._sendNotification("task_completed"),"function"==typeof i&&i()}})},isSomethingMissing:function(){return NelioContent.helpers.trim(this.get("task"))<=0?NelioContent.i18n.errors.task.noTask:""===NelioContent.helpers.trim(this.get("dateValue"))?NelioContent.i18n.errors.datetime.noDate:"exact"===this.get("dateType")&&!NelioContent.helpers.isDate(this.get("dateValue"))&&NelioContent.i18n.errors.datetime.invalidDate},getDateForSorting:function(){var e="";if(this.post.isPublished()||this.post.isScheduled()){var t=this.get("dateDue");"string"==typeof t&&(t=ncNewLocalMoment(t)),e+=t.toISOString()}else if("exact"===this.get("dateType"))e+=this.get("dateValue");else{var i="Z0000000"+this.get("dateValue");e+=i.substr(i.length-6)}return e},getRelevantDay:function(){return this.get("dateDue").format("YYYY-MM-DD")},reschedule:function(e){if("exact"===this.get("dateType")){if(this.get("dateValue")===e)return void this.trigger("nc:abort:reschedule");this.set("dateValue",e),this.set("dateDue",ncNewLocalMoment(e+"T12:00:00.000"))}else{var t=ncNewLocalMoment(this.get("dateDue").format("YYYY-MM-DD")+"T12:00:00.000"),i=ncNewLocalMoment(e+"T12:00:00.000").diff(t,"d");if(0===i)return void this.trigger("nc:abort:reschedule");var n=parseInt(this.get("dateValue"));"negative-days"===this.get("dateType")&&(n=-n);var s=n+i;t.format("HH:mm");0<s?(this.set("dateType","positive-days"),this.set("dateValue",""+s)):s<0?(this.set("dateType","negative-days"),this.set("dateValue",""+Math.abs(s))):(this.set("dateType","predefined-offset"),this.set("dateValue","0")),this.get("dateDue").add(i,"d")}this.set("baseDatetime","reschedule"),this.save(void 0,{success:function(e,t){e.set(t),e._setBaseDatetime(),e.trigger("nc:reschedule")},error:function(e){e.trigger("nc:error")}})},_sendNotification:function(e){var t=this.toJSON(),i={action:"nelio_content_task_notification",mode:e,task:t.task,post_id:t.postId,assignee_id:t.assigneeId,assigner_id:t.assignerId,completed:t.completed,date_due:t.dateDue.toISOString()||void 0};o.ajax({url:ajaxurl,data:i})},_fixDateDueFormat:function(){var e=this.get("dateDue");"string"==typeof e&&this.set("dateDue",ncNewLocalMoment(e))},_fixColor:function(){_.contains(["none","red","orange","yellow","green","cyan","blue","purple"],this.get("color"))||this.set("color","none")},_setBaseDatetime:function(){0===this.post.get("id")||this.post.isPublished()?"exact"===this.get("dateType")?this.set("baseDatetime","none"):this.set("baseDatetime","now"):this.post.isScheduled()?"exact"===this.get("dateType")?this.set("baseDatetime","none"):this.set("baseDatetime",this.post.get("date").clone()):this.set("baseDatetime","none")}}),NelioContent.collections.EditorialTasks=NelioContent.collections.Collection.extend({model:NelioContent.models.EditorialTask,post:void 0,initialize:function(){this.listenTo(this,"add",this._onAdd),this.listenTo(this,"remove",this._onRemove),this.listenTo(this,"reset",this._onReset)},setPost:function(e){this.post=e,this.each(function(e){e.set("postId",this.post.get("id")),e.set("postType",this.post.get("type"))},this)},_triggerModelChange:function(e){this.trigger("nc:change:model",this,e)},_onAdd:function(e){this.listenTo(e,"change",this._triggerModelChange),this.listenTo(e,"destroy",this.remove),e.set("postId",this.post.get("id")),e.set("postType",this.post.get("type"))},_onRemove:function(e){this.stopListening(e)},_onReset:function(e,t){_.each(t.previousModels,this._onRemove,this),this.each(this._onAdd,this)}}),NelioContent.collections.Followers=NelioContent.collections.Collection.extend({model:NelioContent.models.User,comparator:function(e,t){return NelioContent.users.current().get("id")===e.id?-1:NelioContent.users.current().get("id")===t.id?1:this.post.get("author")===e.id?-1:this.post.get("author")===t.id?1:e.id-t.id},post:void 0,initialize:function(e,t){this.post=t.post,this.reset(this.post.get("followers"))}}),NelioContent.collections.MonthlyCalendarItems=NelioContent.collections.Collection.extend({_isLoading:!1,_today:void 0,_firstDayInCalendar:void 0,_lastDayInCalendar:void 0,_firstDayOfMonth:void 0,_ajaxRequests:void 0,_isMessagePublicationPaused:!1,_alreadyLoadedInfo:!1,_filters:!1,model:function(e,t){switch(e.calendarKind){case"post":return new NelioContent.models.Post(e,t);case"social":return(t=t||{}).enableFastInit=!0,new NelioContent.models.SocialMessage(e,t);case"task":return new NelioContent.models.EditorialTask(e,t)}},initialize:function(e,t){this._today=ncNewLocalMoment(),this._firstDayOfMonth=this._today,this._filters={post:ncstore.get("nc-calendar-post-filter["+NelioContent.wpBlogId+"]","all")||"all",social:ncstore.get("nc-calendar-social-filter["+NelioContent.wpBlogId+"]","all")||"all",task:ncstore.get("nc-calendar-task-filter["+NelioContent.wpBlogId+"]","all")||"all"};var i=this._firstDayOfMonth;"object"==typeof t&&"string"==typeof t.date&&(/^[12][01][0-9][0-9]-[01][0-9]-[0123][0-9]$/.test(t.date)?i=t.date:/^[2][01][0-9][0-9]-[0-1][0-9]$/.test(t.date)&&(i=t.date+"-10")),this.gotoDate(i),this._loadItems=_.debounce(this._loadItems,0),this._doLoadItems=_.debounce(this._doLoadItems,500),this.refresh=_.bind(this.refresh,this),this.listenTo(this,"nc:change:date",this._loadItems),this.refresh()},isMessagePublicationPaused:function(){return this._isMessagePublicationPaused},getFirstDay:function(){return this._firstDayInCalendar.clone()},getLastDay:function(){return this._firstDayInCalendar.clone().add(41,"d")},getToday:function(){return this._today.clone()},getFirstDayOfMonth:function(){return this._firstDayOfMonth.clone()},gotoDate:function(e){switch(typeof e){case"object":this._firstDayOfMonth=ncLocalizeMoment(e.clone());break;case"undefined":this._firstDayOfMonth=ncNewLocalMoment();break;default:this._firstDayOfMonth=ncNewLocalMoment(e)}var t=this._firstDayOfMonth.clone();t.date(1),t.hours(0),t.minutes(0),t.seconds(0),t.milliseconds(0),this._firstDayOfMonth=t.clone();for(var i=this._firstDayOfMonth.clone().startOf("week").format("d");t.format("d")!=i;)t.add(-1,"d");if(this._firstDayInCalendar=t.clone(),t.add(6,"w"),t.add(-1,"ms"),this._lastDayInCalendar=t.clone(),"undefined"!=typeof history&&"function"==typeof history.replaceState){var n=window.location.href;-1===(n=(n=(n=n.replace(/\bdate=([12][01][0-9][0-9]-[01][0-9](-[0123][0-9])?)\b/,"")).replace(/\?$/,"")).replace(/\&$/,"")).indexOf("?")?n+="?":n+="&",n+="date="+this._firstDayOfMonth.format("YYYY-MM"),history.replaceState(null,null,n)}this.trigger("nc:change:date")},prevMonth:function(){this._firstDayInCalendar.add(-2,"w"),this.gotoDate(this._firstDayInCalendar)},nextMonth:function(){this._firstDayInCalendar.add(8,"w"),this.gotoDate(this._firstDayInCalendar)},isTodayVisible:function(){return this._today.month()===this._firstDayOfMonth.month()&&this._today.year()===this._firstDayOfMonth.year()},refresh:function(){this._alreadyLoadedInfo={posts:{},social:{},tasks:{}},this._loadItems()},refreshPost:function(i){NelioContent.useEditorialCalendarOnly||o.ajax({url:NelioContent.apiUri+"/post/"+i+"/items",method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},success:_.bind(function(e){var t=this.filter(function(e){return e.get("postId")===i});this.remove(t),e.social=_.map(e.social,function(e){return e.calendarKind="social",e}),e.tasks=_.map(e.tasks,function(e){return e.calendarKind="task",e}),e.social=_.filter(e.social,function(e){return e.schedule}),e.tasks=_.filter(e.tasks,function(e){return e.dateDue}),this.add(_.union(e.social,e.tasks)),this._isLoading=!1,this.trigger("nc:change:isLoading",this._isLoading),this.trigger("nc:items:loaded")},this),error:_.bind(function(){this.refresh()},this)})},isLoading:function(){return this._isLoading},applyFilters:function(e){switch(e.get("calendarKind")){case"post":return"all"===this._filters.post||"none"!==this._filters.post&&(1<NelioContent.postTypes.length?e.get("type")===this._filters.post:"post"!==NelioContent.postTypes[0].name||_.contains(_.pluck(e.get("categories"),"id"),this._filters.post));case"social":return!!NelioContent.profiles.isReady()&&("all"===this._filters.social||"none"!==this._filters.social&&(0===this._filters.social.indexOf("nc:network:")?e.get("network")===this._filters.social.substring(11):e.get("profileId")===this._filters.social));case"task":return"all"===this._filters.task||"none"!==this._filters.task&&e.get("assigneeId")===this._filters.task;default:return console.log("Unknown calendar kind."),!1}},getFilter:function(e){return this._filters[e]||"all"},setFilter:function(e,t){switch(e){case"post":ncstore.set("nc-calendar-post-filter["+NelioContent.wpBlogId+"]",t);break;case"social":"none"===this._filters.social&&"none"!==t&&(this._alreadyLoadedInfo.social={}),ncstore.set("nc-calendar-social-filter["+NelioContent.wpBlogId+"]",t);break;case"task":"none"===this._filters.task&&"none"!==t&&(this._alreadyLoadedInfo.tasks={}),ncstore.set("nc-calendar-task-filter["+NelioContent.wpBlogId+"]",t);break;default:return}this._filters[e]=t,this._loadItems()},toCSV:function(){var i=[];this.each(function(e){var t=e.toJSON();switch(e.get("calendarKind")){case"social":t.date=e.get("schedule").format("YYYY-MM-DD"),t.time=e.get("schedule").format("HH:mm"),t.sort=e.get("schedule").format("YYYY-MM-DD")+"1"+e.get("schedule").format("HH:mm")+"1"+t.textComputed;break;case"task":t.date=e.get("dateDue").format("YYYY-MM-DD"),t.time="",t.sort=e.get("dateDue").format("YYYY-MM-DD")+"0"+t.task;break;default:t.date=e.get("date").format("YYYY-MM-DD"),t.time=e.get("date").format("HH:mm"),t.sort=e.get("date").format("YYYY-MM-DD")+"1"+e.get("date").format("HH:mm")+"0"+t.title}i.push(t)}),i=i.sort(function(e,t){return e.sort<t.sort?-1:e.sort>t.sort?1:0});var n=this.getFirstDayOfMonth(),s=this.getFirstDayOfMonth().add(1,"month");i=_.filter(i,function(e){var t=ncNewLocalMoment(e.date+" 10:00");return n.isBefore(t)&&t.isBefore(s)});var e,t={};e=_.filter(i,function(e){return"post"!==e.calendarKind&&0<e.postId}),e=_.uniq(_.pluck(e,"postId")),o.ajax({url:ajaxurl,data:{action:"nelio_content_get_post_permalinks",posts:e},success:_.bind(function(e){t=e},this),complete:_.bind(function(){this.trigger("nc:download:csv",this._genCSV(i,t))},this)})},_genCSV:function(e,i){var n='"Date","Time","Type","Author/Profile/Assignee","Title/Text/Task","Permalink","Status"\n';return _.each(e,function(e){switch(e.calendarKind){case"social":n+='"'+e.date+'",',n+='"'+e.time+'",',n+='"'+NelioContent.helpers.capitalizeFirstLetter(e.network)+'",',n+='"'+NelioContent.profiles.get(e.profileId).get("username")+'",',n+='"'+e.textComputed.replace(/"/g,'""')+'",',n+='"'+(i[e.postId]||"N/A")+'",',n+='"'+e.status+'"';break;case"task":n+='"'+e.date+'",',n+='"'+e.time+'",',n+='"Editorial Task",',n+='"'+NelioContent.users.get(e.assigneeId).get("name")+'",',n+='"'+e.task.replace(/"/g,'""')+'",',n+='"'+(i[e.postId]||"N/A")+'",',n+='"'+(e.completed?"done":"pending")+'"';break;default:var t=_.findWhere(NelioContent.postTypes,{name:e.type});t=void 0!==t?t.labels.singular:e.type,n+='"'+e.date+'",',n+='"'+e.time+'",',n+='"WordPress '+t+'",',n+='"'+NelioContent.users.get(e.author).get("name")+'",',n+='"'+e.title.replace(/"/g,'""')+'",',n+='"'+e.permalink+'",',n+='"'+e.status+'"'}n+="\n"}),n.replace(/\n$/,"")},_loadItems:function(){_.map(this._ajaxRequests,function(e){e.abort()}),this._isEverythingInThisMonthAlreadyLoaded()?this._maybeAddItemsInCollection():(this._isLoading=!0,this.trigger("nc:change:isLoading",this._isLoading),this._doLoadItems())},_doLoadItems:function(){this.__posts=[],this.__social=[],this.__tasks=[],this._ajaxRequests=[];var e=this.getFirstDay().add(-1,"d"),t=this.getLastDay().add(1,"d");this._runPostAjaxRequest(e,t),this._runSocialAjaxRequest(e,t),this._runTaskAjaxRequest(e,t),this._maybeAddItemsInCollection()},_runPostAjaxRequest:function(e,t){var i=e.clone().add(15,"d").format("YYYYMM");if(!this._isAlreadyLoaded("posts",i)){var n=o.ajax({url:ajaxurl,data:{action:"nelio_content_get_monthly_posts",start:e.format("YYYY-MM-DD"),end:t.format("YYYY-MM-DD")},success:_.bind(function(e){this.__posts=e,this._markAsAlreadyLoaded("posts",i)},this),complete:_.bind(function(){this._ajaxRequests=_.without(this._ajaxRequests,n),this._maybeAddItemsInCollection()},this)});this._ajaxRequests.push(n)}},_runSocialAjaxRequest:function(t,i,e){if(!NelioContent.useEditorialCalendarOnly&&"none"!==this._filters.social){var n=t.clone().add(15,"d").format("YYYYMM");if(!this._isAlreadyLoaded("social",n)){var s=o.ajax({url:NelioContent.apiUri+"/calendar/messages",method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},data:{from:t.format("YYYY-MM-DD"),to:i.format("YYYY-MM-DD"),page:e},success:_.bind(function(e){this.__social=_.union(this.__social,e.messages||[]),e.page?this._runSocialAjaxRequest(t,i,e.page):this._markAsAlreadyLoaded("social",n)},this),complete:_.bind(function(){this._ajaxRequests=_.without(this._ajaxRequests,s),this._maybeAddItemsInCollection()},this)});this._ajaxRequests.push(s)}}},_runTaskAjaxRequest:function(t,i,e){if(!NelioContent.useEditorialCalendarOnly&&"none"!==this._filters.task){var n=t.clone().add(15,"d").format("YYYYMM");if(!this._isAlreadyLoaded("tasks",n)){var s=o.ajax({url:NelioContent.apiUri+"/calendar/tasks",method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},data:{from:t.format("YYYY-MM-DD"),to:i.format("YYYY-MM-DD"),page:e},success:_.bind(function(e){this.__tasks=_.union(this.__tasks,e.tasks||[]),e.page?this._runTaskAjaxRequest(t,i,++e.page):this._markAsAlreadyLoaded("tasks",n)},this),complete:_.bind(function(){this._ajaxRequests=_.without(this._ajaxRequests,s),this._maybeAddItemsInCollection()},this)});this._ajaxRequests.push(s)}}},_maybeAddItemsInCollection:function(){if(!this._ajaxRequests||!this._ajaxRequests.length){this.__social=_.map(this.__social,function(e){return e.calendarKind="social",e}),this.__tasks=_.map(this.__tasks,function(e){return e.calendarKind="task",e});var e=_.union(this.__posts,this.__social,this.__tasks);this.add(e),this._isLoading=!1,this.trigger("nc:change:isLoading",this._isLoading),this.trigger("nc:items:loaded")}},_markAsAlreadyLoaded:function(e,t){try{this._alreadyLoadedInfo[e][t]=!0}catch(e){}},_isAlreadyLoaded:function(e,t){try{return this._alreadyLoadedInfo[e][t]||!1}catch(e){return!1}},_isEverythingInThisMonthAlreadyLoaded:function(){var e=this.getFirstDay().clone().add(15,"d").format("YYYYMM");return!!this._isAlreadyLoaded("posts",e)&&(!(!this._isAlreadyLoaded("social",e)&&"none"!==this.getFilter("social"))&&!(!this._isAlreadyLoaded("tasks",e)&&"none"!==this.getFilter("task")))}}),NelioContent.collections.SocialTimeline=NelioContent.collections.Collection.extend({model:NelioContent.models.SocialMessage,post:void 0,initialize:function(){this.fillTimelineAutomatically=_.bind(this.fillTimelineAutomatically,this),this.listenTo(this,"add",this._onAdd),this.listenTo(this,"remove",this._onRemove),this.listenTo(this,"reset",this._onReset)},getDisabledProfileIds:function(){if(NelioContent.helpers.isSubscribed())return[];var t=ncNewLocalMoment().format("YYYY-MM-DD"),e=this.filter(function(e){return!e.get("isFreePreview")&&e.getRelevantDay()===t});return e=_.map(e,function(e){return e.toJSON()}),_.uniq(_.pluck(e,"profileId"))},setPost:function(e){this.post=e,this.each(function(e){e.setPost(this.post)},this),this.trigger("nc:set:post")},fillTimelineAutomatically:function(){var i=this;o.ajax({url:ajaxurl,data:{action:"nelio_content_get_post_for_auto_sharing",post:this.post.get("id")},success:function(e){!function(e){var t=NelioContent.helpers.processHtml(e.content);e=_.extend(e,t),o.ajax({url:NelioContent.apiUri+"/post/"+e.id+"/social/auto",type:"POST",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},data:JSON.stringify(e),success:function(e){i.reset(e),i.trigger("nc:auto:ready")},error:function(e){var t=NelioContent.i18n.errors.api.emptyAjaxStatus;NelioContent.helpers.trim(e.responseJSON.errorMessage).length&&(t=NelioContent.i18n.errors.api.generic+" ",t+=NelioContent.helpers.trim(e.responseJSON.errorMessage)),i.trigger("nc:auto:error",t)}})}(e)},error:function(){var e=NelioContent.i18n.errors.generic.unknown;i.trigger("nc:auto:error",e)}})},_onAdd:function(e){this.listenTo(e,"destroy",this.remove),e.setPost(this.post)},_onRemove:function(e){this.stopListening(e)},_onReset:function(e,t){_.each(t.previousModels,this._onRemove,this),this.each(this._onAdd,this)}}),NelioContent.models.SocialProfile=NelioContent.models.Model.extend({_allowsMultiTargets:!1,_isImageRequired:!1,_autoFrequencies:void 0,urlRoot:NelioContent.apiUri+"/profile",defaults:function(){return{calendarId:"",profileId:"",network:"",kind:"",photo:"",creationDate:ncNewLocalMoment(),displayName:"",firstLetter:"",creatorId:0,creatorDisplayName:"",creatorEditLink:"",publicationFrequency:0,reshareFrequency:0,username:"",status:"valid",synching:!1}},_creator:!1,initialize:function(){this.listenTo(this,"change:displayName",this._setFirstLetter),this._setFirstLetter(),this.listenTo(this,"change:displayName",this._escapeNameAndUsername),this.listenTo(this,"change:username",this._escapeNameAndUsername),this._escapeNameAndUsername(),this.listenTo(this,"change:creationDate",this._fixCreationDateFormat),this._fixCreationDateFormat(),this.listenTo(this,"change:network",this._fixAllowsMultiTargets),this._fixAllowsMultiTargets(),this.listenTo(this,"change:network",this._fixImageIsRequired),this._fixImageIsRequired(),this.listenTo(this,"change:creatorId",this._changeCreator),this._changeCreator(),this._autoFrequencies={publication:this.get("publicationFrequency")||0,reshare:this.get("reshareFrequency")||0}},allowsMultiTargets:function(){return this._allowsMultiTargets},requiresImageToShare:function(){return this._isImageRequired},setAutoPublicationFrequency:function(e){if(!NelioContent.misc.usesCustomAutomationFrequencies&&!this.get("synching")){this.set("synching",!0);var t,i=_.findWhere(NelioContent.networkMetas,{id:this.get("network")});t=i?i.socialAutomations:{reshare:{low:1,mid:1,high:1},publication:{low:1,mid:1,high:1},boostedPublication:{low:1,mid:1,high:1}},this.get("publicationFrequency")&&(this.get("reshareFrequency")?this.set("publicationFrequency",t.boostedPublication[e]):this.set("publicationFrequency",t.publication[e])),this.get("reshareFrequency")&&this.set("reshareFrequency",t.reshare[e]),this._synchronizeFrequencies()}},toggleAutoPublication:function(e){this.get("synching")||(this.get("publicationFrequency")?this.set("publicationFrequency",0):this.set("publicationFrequency",-1),this.setAutoPublicationFrequency(e))},toggleAutoReshare:function(e){this.get("synching")||(this.get("reshareFrequency")?this.set("reshareFrequency",0):this.set("reshareFrequency",-1),this.setAutoPublicationFrequency(e))},guessFrequency:function(){var t,e=_.findWhere(NelioContent.networkMetas,{id:this.get("network")});t=e?e.socialAutomations:{reshare:{low:1,mid:1,high:1},publication:{low:1,mid:1,high:1},boostedPublication:{low:1,mid:1,high:1}};var i="unknown",n="unknown",s=this.get("publicationFrequency"),o=this.get("reshareFrequency");return s&&o?_.each(["low","mid","high"],function(e){t.boostedPublication[e]===s&&(i=e)}):s&&_.each(["low","mid","high"],function(e){t.publication[e]===s&&(i=e)}),o&&_.each(["low","mid","high"],function(e){t.reshare[e]===o&&(n=e)}),"low"===i||"low"===n?"low":"mid"===i||"mid"===n?"mid":"high"===i||"high"===n?"high":"unknown"},setAutoFrequencies:function(e,t){this.get("synching")||(this.set("synching",!0),this.set("publicationFrequency",e),this.set("reshareFrequency",t),this._synchronizeFrequencies())},_synchronizeFrequencies:function(){var e=this.get("publicationFrequency")||0,t=this.get("reshareFrequency")||0;if(this._autoFrequencies.publication===e&&this._autoFrequencies.reshare===t)return this.set("synching",!1),void this.trigger("nc:synched");this._autoFrequencies.publication=e,this._autoFrequencies.reshare=t;var i=this;o.ajax({url:NelioContent.apiUri+"/profile/"+this.get("id"),method:"PUT",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},data:JSON.stringify({publicationFrequency:e,reshareFrequency:t}),complete:function(){i.set("synching",!1),i.trigger("nc:synched")}}),NelioContent.tmp.wasLastDayWithResharesReset||(NelioContent.tmp.wasLastDayWithResharesReset=!0,o.ajax({url:ajaxurl,data:{action:"nelio_content_reset_last_day_with_reshares"}}))},_setFirstLetter:function(){this.set("firstLetter",NelioContent.helpers.extractFirstLetter(this.get("displayName")))},_fixCreationDateFormat:function(){var e=this.get("creationDate");"string"==typeof e&&this.set("creationDate",ncNewLocalMoment(e))},_changeCreator:function(){this._creator&&(this.stopListening(this._creator),this._creator=!1),this._creator=NelioContent.users.getUser(this.get("creatorId"));var e=this._creator;e.valid()?(this.set("creatorDisplayName",e.get("name")),this.set("creatorEditLink",e.get("editLink"))):(this.set("creatorDisplayName",""),this.set("creatorEditLink",""));var t=this;this.listenTo(e,"nc:load",function(){e.valid()?(t.set("creatorDisplayName",e.get("name")),t.set("creatorEditLink",e.get("editLink"))):(t.set("creatorDisplayName",""),t.set("creatorEditLink",""))})},_escapeNameAndUsername:function(){var e=this.get("username");"twitter"===this.get("network")&&"@"!==e[0]&&(e="@"+e,this.set("username",e)),this.set("displayNameEscaped",_.escape(this.get("displayName"))),this.set("usernameEscaped",_.escape(this.get("username")))},_fixAllowsMultiTargets:function(){var e=_.findWhere(NelioContent.networkMetas,{id:this.get("network")});void 0!==e&&e.allowsMultiTargets?this._allowsMultiTargets=!0:this._allowsMultiTargets=!1},_fixImageIsRequired:function(){var e=_.findWhere(NelioContent.networkMetas,{id:this.get("network")});void 0!==e&&e.isImageRequired?this._isImageRequired=!0:this._isImageRequired=!1}}),NelioContent.collections.ConnectedSocialProfiles=NelioContent.collections.Collection.extend({model:NelioContent.models.SocialProfile,_isReady:!1,isReady:function(){return this._isReady},populate:function(){this.reload()},guessFrequency:function(){var e=this.map(function(e){return e.guessFrequency()});return _.contains(e,"low")?"low":_.contains(e,"mid")?"mid":"high"},reload:function(){if(NelioContent.useEditorialCalendarOnly)return this._isReady=!0,this.reset([]),void this.trigger("nc:ready");var e=ncstore.get("nc-social-profiles["+NelioContent.wpBlogId+"]",!1);if(e)return this._isReady=!0,this.reset(e),void this.trigger("nc:ready");this._isReady=!1;var i=this;o.ajax({url:NelioContent.apiUri+"/profiles",method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},success:function(e){i._updateProfileAvailabilityInWP(0<e.length),i._isReady=!0,i.reset(e);var t=i.guessFrequency();i.each(function(e){e.setAutoPublicationFrequency(t)}),ncstore.set("nc-social-profiles["+NelioContent.wpBlogId+"]",i.toJSON(),(new Date).getTime()+6048e5),i.trigger("nc:ready")},error:function(e){i._isReady=!0,i.reset([]),i.trigger("nc:error")}})},reloadAfterAddingNewProfile:function(){this.listenToOnce(this,"reset",this._enableAutomationsInNewestProfile),this.reload()},enablePublicationAutomations:function(){var t=this,e=0;function i(){++e>=t.length&&t.trigger("nc:reshare-enabled")}this.each(function(e){t.listenToOnce(e,"nc:synched",i),e.set("publicationFrequency",0),e.set("reshareFrequency",0),e.toggleAutoPublication("high")})},_enableAutomationsInNewestProfile:function(){if(this.length){var e=this.toJSON();e=_.each(e,function(e){return e.creationDate=e.creationDate.toISOString(),e}),e=_.sortBy(e,"creationDate");var t=this.get(e[e.length-1].id),i=ncNewLocalMoment(),n=t.get("creationDate");10<Math.abs(i.diff(n,"minutes"))||t.toggleAutoPublication(this.guessFrequency())}},_updateProfileAvailabilityInWP:function(e){NelioContent.hasSocialProfiles!==e&&o.ajax({url:ajaxurl,data:{action:"nelio_content_update_profiles_availability",value:e?"yes":"no"}})}}),NelioContent.profiles=new NelioContent.collections.ConnectedSocialProfiles,NelioContent.profiles.populate(),NelioContent.models.SocialTemplate=NelioContent.models.Model.extend({urlRoot:NelioContent.apiUri+"/template",defaults:function(){return{siteId:"",text:"{title} {permalink}",isFallback:!1,type:"publication",targetName:"default",author:0,postType:"nc_any",postCategory:"nc_none",creationDate:ncNewLocalMoment(),creatorId:NelioContent.users.current().get("id"),creatorDisplayName:"",creatorEditLink:""}},_creator:!1,_referenceRegExp:/{ref:author}|{ref:title}|{ref:twitter}|{ref:url}/,initialize:function(){this.listenTo(this,"change:profileId",this._fixProfileInformation),this.listenTo(this,"change:network",this._fixProfileInformation),this._fixProfileInformation(),NelioContent.profiles.isReady()||this.listenToOnce(NelioContent.profiles,"nc:ready",this._fixProfileInformation),this.listenTo(this,"change:creationDate",this._fixCreationDateFormat),this._fixCreationDateFormat(),this.listenTo(this,"change:creatorId",this._changeCreator),this._changeCreator(),this.listenTo(this,"change:text",this._fixType),this._fixType()},isSomethingMissing:function(){return NelioContent.helpers.trim(this.get("text"))<=0&&NelioContent.i18n.errors.socialTemplate.noMessage},toJSON:function(){var e=NelioContent.models.Model.prototype.toJSON.call(this);return"network"===e.network&&(e.network=e.profileId,delete e.profileId),"post"!==e.postType&&(e.postCategory="nc_none"),delete e.profiles,e},_fixProfileInformation:function(){this.stopListening(this,"change:network",this._fixProfileInformation),this.stopListening(this,"change:profileId",this._fixProfileInformation);var e=this.get("profileId"),t=this.get("network");if("string"==typeof t&&t.length)if("string"==typeof e&&e.length)if(_.contains(_.pluck(NelioContent.networkMetas,"id"),e))this.set("network","network");else{var i=NelioContent.profiles.get(e);void 0!==i&&this.set("network",i.get("network"))}else this.set("profileId",t),this.set("network","network");else this.set("profileId","twitter"),this.set("network","network");this.listenTo(this,"change:profileId",this._fixProfileInformation),this.listenTo(this,"change:network",this._fixProfileInformation)},_fixCreationDateFormat:function(){var e=this.get("creationDate");"string"==typeof e&&this.set("creationDate",ncNewLocalMoment(e))},_changeCreator:function(){this._creator&&(this.stopListening(this._creator),this._creator=!1),this._creator=NelioContent.users.getUser(this.get("creatorId"));var e=this._creator;e.valid()?(this.set("creatorDisplayName",e.get("name")),this.set("creatorEditLink",e.get("editLink"))):(this.set("creatorDisplayName",""),this.set("creatorEditLink",""));var t=this;this.listenTo(e,"nc:load",function(){e.valid()?(t.set("creatorDisplayName",e.get("name")),t.set("creatorEditLink",e.get("editLink"))):(t.set("creatorDisplayName",""),t.set("creatorEditLink",""))})},_fixType:function(){if("reshare"!==this.get("type")){var e=this.get("text");this._referenceRegExp.test(e)?this.set("type","reference"):this.set("type","publication")}}}),NelioContent.collections.SocialTemplates=NelioContent.collections.Collection.extend({model:NelioContent.models.SocialTemplate,_isReady:!1,isReady:function(){return this._isReady},populate:function(){this.reload()},reload:function(){if(NelioContent.useEditorialCalendarOnly)return this._isReady=!0,this.reset([]),void this.trigger("nc:ready");var e=ncstore.get("nc-social-templates["+NelioContent.wpBlogId+"]",!1);if(e)return this._isReady=!0,this.reset(e),void this.trigger("nc:ready");this._isReady=!1;var t=this;o.ajax({url:NelioContent.apiUri+"/templates",method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken},success:function(e){e.push({text:"{title} {permalink}",isFallback:!0,type:"publication"}),e.push({text:"{title} {permalink}",isFallback:!0,type:"reshare"}),t._isReady=!0,t.reset(e),ncstore.set("nc-social-templates["+NelioContent.wpBlogId+"]",t.toJSON(),(new Date).getTime()+6048e5),t.trigger("nc:ready")}})}}),NelioContent.templates=new NelioContent.collections.SocialTemplates,NelioContent.templates.populate(),"object"==typeof NelioContent.lastPublishedPost&&(NelioContent.lastPublishedPost=new NelioContent.models.Post(NelioContent.lastPublishedPost))}(jQuery);