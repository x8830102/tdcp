!function(a){"use strict";var t;NelioContent.views.SocialTimeline=Backbone.View.extend({_isLocked:!1,_isAutoGeneratingSocialMessages:!1,className:"nc-social-timeline",_overview:{$instance:void 0,sections:{$before:void 0,$day:void 0,$nextDay:void 0,$week:void 0,$month:void 0,$later:void 0},marks:{$start:void 0,$end:void 0},isFixed:!1,lastHighlightedBlock:"day",ignoreNextAutoHighlight:!1},_$blocks:{before:void 0,day:void 0,nextDay:void 0,week:void 0,month:void 0,later:void 0},_messageViews:{before:[],day:[],nextDay:[],week:[],month:[],later:[]},_socialMessageEditorView:void 0,_adminBarHeight:32,_$window:void 0,_$document:void 0,_templates:{autoGeneratingSocialMessages:NelioContent.helpers.getTemplate("_nc-auto-generating-social-messages"),normal:NelioContent.helpers.getTemplate("_nc-social-timeline"),noProfiles:NelioContent.helpers.getTemplate("_nc-no-profile-available"),autoDraft:NelioContent.helpers.getTemplate("_nc-no-social-timeline-on-auto-draft")},events:{"click .nc-timeline-overview .nc-section":"_gotoSection","click .nc-manual-create:not( .nc-disabled )":"_openSocialMessageEditorDialog","click .nc-auto-create":"_savePostToAutogenerateMessages","click .button.nc-action.nc-new-social-message.nc-add-message":"_openSocialMessageEditorDialog","click .button.nc-action.nc-new-social-message.nc-upgrade":"_gotoAccountPage","click .nc-new-social-message.nc-first-message.nc-add-message":"_openSocialMessageEditorDialog","click .nc-new-social-message.nc-first-message.nc-upgrade":"_gotoAccountPage"},initialize:function(){this._$window=a(window),this._$document=a(document),this.collection=new NelioContent.collections.SocialTimeline,this._resetMessageViews(),this.render=_.bind(this.render,this),this._updateMessage=_.bind(this._updateMessage,this),this._addNewMessages=_.bind(this._addNewMessages,this),this.listenTo(this.collection,"add",this._addMessageView),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this._removeMessageView),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection,"reset",this._resetMessageViews),this.listenTo(this.collection,"reset",this.render),this.listenTo(this,"nc:render",this.render),this._maybeFixOverview=_.bind(this._maybeFixOverview,this),this._onWindowResize=_.bind(this._onWindowResize,this),this._maybeHighlightADifferentBlockInOverview=_.bind(this._maybeHighlightADifferentBlockInOverview,this),this._$document.on("scroll",this._maybeFixOverview),this._$document.on("scroll",this._maybeHighlightADifferentBlockInOverview),this._$window.on("resize",this._onWindowResize),this._$window.on("resize",this._maybeHighlightADifferentBlockInOverview),NelioContent.helpers.isGutenbergActive()&&this._listenToGutenbergSaveEvent()},render:function(){if(this._isAutoGeneratingSocialMessages)return this.el.innerHTML=this._templates.autoGeneratingSocialMessages(),this;if(0===NelioContent.profiles.length)return this.el.innerHTML=this._templates.noProfiles(),this;if(void 0===this.collection.post)return this;if("auto-draft"===this.collection.post.get("status"))return this.el.innerHTML=this._templates.autoDraft(),this;var t={isTimelineVisible:this._isTimelineVisible(),dayStatus:this._getStatus("day"),nextDayStatus:this._getStatus("nextDay"),weekStatus:this._getStatus("week"),monthStatus:this._getStatus("month"),laterStatus:this._getStatus("later"),isPostPublished:this.collection.post.isPublished(),excludedFromReshare:this.collection.post.get("excludedFromReshare")},e=ncNewLocalMoment();if(this.collection.post.isPublished())t.dayFormattedDate=e.format(NelioContent.i18n.dates.default),t.nextDayFormattedDate=e.add(1,"d").format(NelioContent.i18n.dates.default),t.statistics=this.collection.post.get("statistics");else if(this.collection.post.isScheduled()){var i=this.collection.post.get("date").clone();t.dayFormattedDate=i.format(NelioContent.i18n.dates.default),t.nextDayFormattedDate=i.add(1,"d").format(NelioContent.i18n.dates.default)}else t.dayFormattedDate="",t.nextDayFormattedDate="";if(!NelioContent.helpers.isSubscribed()){var n=this.collection,s=_.map(n.getDisabledProfileIds(),function(e){return n.get(e)});t.areMoreMessagesAllowed=s.length<NelioContent.profiles.length}t.timeSinceLastShare=!1;var o=_.pluck(_.where(this.collection.toJSON(),{status:"publish"}),"sentTime").sort();try{if(o.length){var a=o.sort().reverse()[0];t.timeSinceLastShare=ncLocalizeMoment(ncmoment(a)).fromNow()}}catch(e){t.timeSinceLastShare=!1}return this.el.innerHTML=this._templates.normal(t),this._overview.$instance=this.$(".nc-timeline-overview"),this._overview.marks.$start=this.$("#timeline-start"),this._overview.marks.$end=this.$("#timeline-end"),this._overview.sections.$day=this.$(".nc-timeline-overview .nc-section.nc-day"),this._overview.sections.$nextDay=this.$(".nc-timeline-overview .nc-section.nc-next-day"),this._overview.sections.$week=this.$(".nc-timeline-overview .nc-section.nc-week"),this._overview.sections.$month=this.$(".nc-timeline-overview .nc-section.nc-month"),this._overview.sections.$later=this.$(".nc-timeline-overview .nc-section.nc-later"),this._overview.sections["$"+this._overview.lastHighlightedBlock].addClass("nc-active"),this._populateBlock("day"),this._populateBlock("nextDay"),this._populateBlock("week"),this._populateBlock("month"),this._populateBlock("later"),this._overview.isFixed=!1,this._maybeFixOverview(),this._maybeHighlightADifferentBlockInOverview(),NelioContent.helpers.makeInfoTooltip(this.$(".nc-help-with-html-tooltip")),this._isLocked?(this.$el.addClass("nc-locked"),this.$(".nc-new-social-message").addClass("nc-locked")):(this.$el.removeClass("nc-locked"),this.$(".nc-new-social-message").removeClass("nc-locked")),this},lock:function(){_.mapObject(this._messageViews,function(e){_.each(e,function(e){e.lock()})}),this._isLocked=!0,this.trigger("nc:render")},unlock:function(){_.mapObject(this._messageViews,function(e){_.each(e,function(e){e.unlock()})}),this._isLocked=!1,this.trigger("nc:render")},fillTimelineAutomatically:function(){if(!this._isAutoGeneratingSocialMessages){this._isAutoGeneratingSocialMessages=!0,this.trigger("nc:render");var e=this;this.listenToOnce(this.collection,"nc:auto:error",function(e){NelioContent.helpers.openErrorDialog(e),t()}),this.listenToOnce(this.collection,"nc:auto:ready",t),this.collection.fillTimelineAutomatically()}function t(){e._isAutoGeneratingSocialMessages=!1,e.unlock()}},_populateBlock:function(e){var t=e;"nextDay"===t&&(t="next-day");var i=this.$(".nc-timeline-section.nc-"+t+" .nc-social-messages"),n=this._messageViews[e];i.children().detach(),_.each(n,function(e){i.append(e.render().el)},this),this._$blocks[e]=i},_getStatus:function(e){return void 0!==this._messageViews[e]?0===this._messageViews[e].length?"bad":this._messageViews[e].length<2?"improvable":"good":"bad"},_resetMessageViews:function(){function e(e){this.stopListening(e),this.stopListening(e.model),e.close()}_.each(this._messageViews.before,e,this),_.each(this._messageViews.day,e,this),_.each(this._messageViews.nextDay,e,this),_.each(this._messageViews.week,e,this),_.each(this._messageViews.month,e,this),_.each(this._messageViews.later,e,this),this._messageViews={before:[],day:[],nextDay:[],week:[],month:[],later:[]},this.collection.each(this._addMessageView,this)},_addMessageView:function(e){var t="none";if("publish"!==e.get("status")||this.collection.post.isPublished()){if("publish"===e.get("status")||this.collection.post.isPublished()||this.collection.post.isScheduled()){var i,n;n=this.collection.post.isPublished()?(i=ncNewLocalMoment()).clone().add(1,"d"):(i=this.collection.post.get("date").clone()).clone().add(1,"d");var s=e.get("schedule"),o=s.diff(i,"day");i.isSame(s,"day")?t="day":n.isSame(s,"day")?t="nextDay":0<o&&o<=9?t="week":0<o&&o<=30?t="month":0<o&&(t="later")}else if("exact"===e.get("dateType"))t="later";else{var a=e.get("dateValue");if(a<=0)if("exact"!==e.get("timeType")){var l=e.get("timeValue");t=l<24?"day":l<48?"nextDay":l<216?"week":l<720?"month":"later"}else t="day";else t=a<=1?"nextDay":a<=9?"week":a<=30?"month":"later"}var r=this._extractView(e);"none"!==t?(void 0===r&&(r=new NelioContent.views.SocialTimelineMessage({model:e}),this.listenTo(r,"nc:edit",this._openSocialMessageEditorDialog),this.listenTo(r.model,"change:dateValue",this._addMessageView),this.listenTo(r.model,"change:dateValue",this.render),this.listenTo(r.model,"change:timeValue",this._addMessageView),this.listenTo(r.model,"change:timeValue",this.render),this._isLocked&&r.lock()),this._messageViews[t].push(r),this._messageViews[t].sort(function(e,t){var i=e.model.getDateForSorting(),n=t.model.getDateForSorting();return"twitter"===e.model.get("network")?i+="Atwitter":i+="B"+e.model.get("network"),"twitter"===t.model.get("network")?n+="Atwitter":n+="B"+t.model.get("network"),(i+=e.model.get("profileId")+e.model.get("text"))<(n+=t.model.get("profileId")+t.model.get("text"))?-1:n<i?1:0})):void 0!==r&&r.close()}},_removeMessageView:function(e){var t=this._extractView(e);void 0!==t&&(this.stopListening(t),this.stopListening(t.model),t.close())},_extractView:function(t){function i(e){return e.model===t}var n;return _.each(["before","day","nextDay","week","month","later"],function(e){if(void 0===n){var t=_.filter(this._messageViews[e],i);0<t.length&&(n=t[0],this._messageViews[e]=_.without(this._messageViews[e],n))}},this),n},_fixOverview:function(e){if(void 0!==this._overview.$instance)if(this._isLocked)this._overview.isFixed&&this._unfixOverview();else if(this._overview.$instance.css("top",e),!this._overview.isFixed){var t=this._overview.$instance.width();this._overview.$instance.addClass("nc-fixed"),this._overview.$instance.css("left",this._overview.$instance.offset().left),this._overview.$instance.css("width",t),this._overview.isFixed=!0}},_unfixOverview:function(){this._overview.isFixed&&(this._overview.$instance.removeClass("nc-fixed"),this._overview.$instance.css("top",""),this._overview.$instance.css("left",""),this._overview.$instance.css("width",""),this._overview.isFixed=!1)},_maybeFixOverview:function(){if(this._isTimelineVisible()&&void 0!==this._overview.$instance){var e=this._$window.scrollTop(),t=this._overview.marks.$start.offset().top-e,i=this._overview.marks.$end.offset().top-e;if(t<=this._adminBarHeight&&-100<i){var n=this._adminBarHeight;i<280&&(n-=280-i),this._fixOverview(n)}else this._unfixOverview()}},_onWindowResize:function(){this._unfixOverview(),this._maybeFixOverview(),this._maybeHighlightADifferentBlockInOverview()},_gotoSection:function(e){for(var t=e.target||e.srcElement;-1===t.className.indexOf("section");)t=t.parentNode;var i=this._overview.$instance.height()+this._adminBarHeight+75;this._overview.ignoreNextAutoHighlight=!0,-1!==t.className.indexOf("nc-later")?(this._$window.scrollTop(this._$blocks.later.offset().top-i),this._highlightBlockInOverview("later")):-1!==t.className.indexOf("nc-month")?(this._$window.scrollTop(this._$blocks.month.offset().top-i),this._highlightBlockInOverview("month")):-1!==t.className.indexOf("nc-week")?(this._$window.scrollTop(this._$blocks.week.offset().top-i),this._highlightBlockInOverview("week")):-1!==t.className.indexOf("nc-next-day")?(this._$window.scrollTop(this._$blocks.nextDay.offset().top-i),this._highlightBlockInOverview("nextDay")):(this._$window.scrollTop(this._$blocks.day.offset().top-i),this._highlightBlockInOverview("day"))},_gotoAccountPage:function(){document.location.href=NelioContent.pages.account},_maybeHighlightADifferentBlockInOverview:function(){if(this._isTimelineVisible())if(this._overview.ignoreNextAutoHighlight)this._overview.ignoreNextAutoHighlight=!1;else if(void 0!==this._overview.$instance){var e=this._$window.scrollTop()+(this._adminBarHeight+this._overview.$instance.height()+80);this._$blocks.later.offset().top<=e?this._highlightBlockInOverview("later"):this._$blocks.month.offset().top<=e?this._highlightBlockInOverview("month"):this._$blocks.week.offset().top<=e?this._highlightBlockInOverview("week"):this._$blocks.nextDay.offset().top<=e?this._highlightBlockInOverview("nextDay"):this._highlightBlockInOverview("day")}},_highlightBlockInOverview:function(e){this._overview.lastHighlightedBlock!==e&&(this._overview.sections.$later.removeClass("nc-active"),this._overview.sections.$month.removeClass("nc-active"),this._overview.sections.$week.removeClass("nc-active"),this._overview.sections.$nextDay.removeClass("nc-active"),this._overview.sections.$day.removeClass("nc-active"),this._overview.sections["$"+e].addClass("nc-active"),this._overview.lastHighlightedBlock=e)},_openSocialMessageEditorDialog:function(e,t){if(e.preventDefault(),!this._isLocked){var i=new NelioContent.models.SocialMessage;if(i.setPost(this.collection.post),void 0===t){var n=e.target||e.srcElement;switch(a(n).closest(".nc-information").find("h4").attr("name")){case"later":i.set("dateType","exact"),i.set("timeType","time-interval"),i.set("timeValue","morning");break;case"month":i.set("dateValue","28"),i.set("timeType","time-interval"),i.set("timeValue","morning");break;case"week":i.set("dateValue","7"),i.set("timeType","time-interval"),i.set("timeValue","morning");break;case"next-day":i.set("dateValue","1"),i.set("timeType","time-interval"),i.set("timeValue","morning")}i.set("profileId",NelioContent.profiles.at(0).get("id"))}else i.set(t.toJSON());this._socialMessageEditorView=new NelioContent.views.SocialMessageEditor({model:i}),this.listenTo(this._socialMessageEditorView,"nc:add:messages",this._addNewMessages),this.listenTo(this._socialMessageEditorView,"nc:update:message",this._updateMessage),this.listenTo(this._socialMessageEditorView,"nc:delete:message",this._deleteMessage),this.listenTo(this._socialMessageEditorView,"nc:close:dialog",this._onClosingMessageEditorView),this._socialMessageEditorView.disableProfiles(this.collection.getDisabledProfileIds()),this._socialMessageEditorView.render()}},_savePostToAutogenerateMessages:function(e){if(e.preventDefault(),!this._isLocked)if(this._areSocialAutomationsEnabled())if(this.lock(),this.$(".nc-auto-create").addClass("disabled nc-disabled").html(NelioContent.i18n.feedback.saving),this.$(".nc-manual-create").addClass("disabled nc-disabled"),NelioContent.helpers.isGutenbergActive())this._generateMessagesAfterGutenbergSaveEvent=!0,wp.data.dispatch("core/editor").savePost();else{var t=a("form#post");t.append('<input type="hidden" name="_nc_auto_messages" value="true" />');var i=a("#nc-form-submit");i.length?i.click():t.submit()}else NelioContent.helpers.openDialog(NelioContent.i18n.titles.socialAutomations,"<div>"+NelioContent.i18n.dialogs.enableSocialAutomations+"</div>")},_areSocialAutomationsEnabled:function(){return 0<NelioContent.profiles.reduce(function(e,t){return e+t.get("publicationFrequency")+t.get("reshareFrequency")},0)},_addNewMessages:function(e){this.collection.add(e)},_updateMessage:function(e){"function"==typeof e.toJSON&&(e=e.toJSON());var t=this.collection.get(e.id);void 0!==t&&t.clearToDefaults().set(e)},_deleteMessage:function(e){this.collection.remove(e)},_isTimelineVisible:function(){return void 0!==this.collection.post&&(this.collection.post.isPublished()||this.collection.length)},_onClosingMessageEditorView:function(){this.stopListening(this._socialMessageEditorView),this._socialMessageEditorView.close(),this._socialMessageEditorView=void 0},_listenToGutenbergSaveEvent:function(){var t=this;wp.data.subscribe(function(){var e=wp.data.select("core/editor");t.collection.post&&t.collection.post.get("status")!==e.getCurrentPostAttribute("status")&&(t.collection.post.set("status",e.getCurrentPostAttribute("status")),t.trigger("nc:render")),e.isSavingPost()||e.isAutosavingPost()||t._generateMessagesAfterGutenbergSaveEvent&&e.didPostSaveRequestSucceed()&&(t._generateMessagesAfterGutenbergSaveEvent=!1,t.fillTimelineAutomatically())})},close:function(){function e(e){this.stopListening(e),this.stopListening(e.model),e.close()}this._messageViews=[],_.each(this._messageViews.before,e,this),_.each(this._messageViews.day,e,this),_.each(this._messageViews.nextDay,e,this),_.each(this._messageViews.week,e,this),_.each(this._messageViews.month,e,this),_.each(this._messageViews.later,e,this),this._messageViews={before:[],day:[],nextDay:[],week:[],month:[],later:[]},this.stopListening(),this.unbind(),this._$document.off("scroll",this._maybeFixOverview),this._$document.off("scroll",this._maybeHighlightADifferentBlockInOverview),this._$window.off("resize",this._onWindowResize),this._$window.off("resize",this._maybeHighlightADifferentBlockInOverview),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.SocialTimelineMessage=Backbone.View.extend({_isLocked:!1,_deletionStatus:"none",_isImageVisible:!1,template:NelioContent.helpers.getTemplate("_nc-social-timeline-message"),events:{mouseleave:"_cancelMessageDeletion","click .nc-actions .nc-delete":"_askForMessageDeletionConfirmation","click .nc-actions .nc-cancel-deletion":"_cancelMessageDeletion","click .nc-actions .nc-do-delete":"_deleteMessage","click .nc-actions .nc-edit":"_editMessage","click .nc-actions .nc-share-now":"_shareNow","click .nc-actions .nc-toggle-image-visibility":"_toggleImageVisibility"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change",this.render)},render:function(){var e=this.model.toJSON(),t=NelioContent.profiles.get(this.model.get("profileId")),i=_.findWhere(NelioContent.networkMetas,{id:this.model.get("network")});return e.networkAllowsMultiTargets=!1,void 0!==i&&i.allowsMultiTargets&&(e.networkAllowsMultiTargets=!0,e.targetLabel=i.multiTargetLabels.targetLabel),void 0===t&&(t=NelioContent.profiles.at(0)),e.photo=t.get("photo"),e.displayName=t.get("displayName"),e.firstLetter=t.get("firstLetter"),e.textFormatted=this.model.getHighlightedText(),e.textFormatted=e.textFormatted.replace(/>https?:\/\/([^\/<]+)([^<]{0,12})([^<]*)/gi,">$1$2>>>$3<<<").replace(/>>>[^<]+<<</gi,"...").replace(/>>><<</gi,""),e.dateFormatted=this._getDatetimeFormatted(),e.isAuthorMe=this.model.get("authorId")===NelioContent.users.current().get("id"),e.locked=this._isLocked,e.deletionStatus=this._deletionStatus,this.el.innerHTML=this.template(e),"deleting"===this._deletionStatus?this.$el.addClass("nc-deleting"):this.$el.removeClass("nc-deleting"),"image"===this.model.get("type")&&this._isImageVisible?this.$(".nc-social-timeline.nc-message").addClass("nc-image-expanded"):this.$(".nc-social-timeline.nc-message").removeClass("nc-image-expanded"),"image"===this.model.get("type")?this.$(".nc-social-timeline.nc-message").addClass("nc-has-image"):this.$(".nc-social-timeline.nc-message").removeClass("nc-has-image"),this},lock:function(){return this._isLocked=!0,this._deletionStatus="none",this},unlock:function(){return this._isLocked=!1,this._deletionStatus="none",this},_askForMessageDeletionConfirmation:function(){this._deletionStatus="awaiting-confirmation",this.trigger("nc:render")},_cancelMessageDeletion:function(){"awaiting-confirmation"===this._deletionStatus&&(this._deletionStatus="none",this.trigger("nc:render"))},_deleteMessage:function(e){this._deletionStatus="deleting",this.trigger("nc:render"),this.model.destroy()},_editMessage:function(e){this.trigger("nc:edit",e,this.model)},_shareNow:function(){this.model.shareNow()},_toggleImageVisibility:function(){this._isImageVisible=!this._isImageVisible,this._isImageVisible?this.$(".nc-social-timeline.nc-message").addClass("nc-image-expanded"):this.$(".nc-social-timeline.nc-message").removeClass("nc-image-expanded")},_getDatetimeFormatted:function(){var e=this._getDateFormatted(),t=this._getTimeFormatted();return 0<e.length&&0<t.length?_.escape(e+" • "+t):_.escape(e+t)},_getDateFormatted:function(){if(this.model.post.isPublished()||this.model.post.isScheduled())return this.model.get("schedule").format(NelioContent.i18n.dates.default);if("exact"===this.model.get("dateType"))return ncNewLocalMoment(this.model.get("dateValue")+" 12:00").format(NelioContent.i18n.dates.default);var e=parseInt(this.model.get("dateValue"));return 3<=e?NelioContent.i18n.dates.daysAfterPublication.replace("{days}",e):""},_getTimeFormatted:function(){if(this.model.post.isPublished()||this.model.post.isScheduled())return this.model.get("schedule").format(NelioContent.i18n.time.default);if("exact"===this.model.get("timeType"))return this.model.get("timeValue");var e=parseInt(this.model.get("timeValue"));return 0===e?NelioContent.i18n.dates.onPublication:1===e?NelioContent.i18n.dates.oneHourAfterPublication:2<=e?NelioContent.i18n.dates.hoursAfterPublication.replace("{hours}",e):""},close:function(){this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.EditorialComment=Backbone.View.extend({_deletionStatus:"none",_autoRenderTimeout:0,_isBeingSaved:!1,template:NelioContent.helpers.getTemplate("_nc-editorial-comment"),events:{mouseleave:"_cancelCommentDeletion","click .nc-action.nc-delete":"_askForCommentDeletionConfirmation","click .nc-action.nc-cancel-deletion":"_cancelCommentDeletion","click .nc-action.nc-do-delete":"_deleteComment"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render);var e=NelioContent.users.getUser(this.model.get("authorId"));e.isLoading()&&this.listenToOnce(e,"nc:load",_.bind(function(){this.trigger("nc:render")},this))},render:function(){var e=this.model.toJSON();e.deletionStatus=this._deletionStatus,e.isBeingSaved=this._isBeingSaved,e.dateFormatted=this._prepareDate(),ncNewLocalMoment().diff(this.model.get("date"),"m")<15?e.canBeDeleted=!0:e.canBeDeleted=!1;var t=NelioContent.users.getUser(this.model.get("authorId"));return e.isAuthorMe=t.get("id")===NelioContent.users.current().get("id"),e.photo=t.get("photo"),e.displayName=t.get("name"),e.firstLetter=t.get("firstLetter"),"davilera"===t.get("id")&&(e.photo="https://secure.gravatar.com/avatar/fd9a4ef5e8c94fc90a7cef16fa8553a5?s=100&d=mm&r=g",e.displayName=NelioContent.i18n.messages.davilera,e.firstLetter="d"),this.el.innerHTML=this.template(e),this},setIsBeingSaved:function(e){this._isBeingSaved=e,this.trigger("nc:render")},_prepareDate:function(){this._clearAutoRenderTimeout();var e,t=ncNewLocalMoment(),i=t.clone().add(-1,"d"),n=this.model.get("date");if(2<t.diff(n,"d"))e=n.format(NelioContent.i18n.dates.default);else if(n.isSame(i,"day"))e=n.format(NelioContent.i18n.dates.lastDay)+", "+n.format(NelioContent.i18n.time.default),this._autoRenderTimeout=setTimeout(this.render,9e5);else if(n.isSame(t,"day")){e=3<Math.abs(n.diff(t,"h"))?n.format(NelioContent.i18n.time.default):t.diff(n,"s")<30?n.format(NelioContent.i18n.time.now):NelioContent.helpers.capitalizeFirstLetter(n.fromNow());var s=Math.abs(t.diff(n,"m"));this._autoRenderTimeout=s<1?setTimeout(this.render,2e4):s<5?setTimeout(this.render,6e4):setTimeout(this.render,9e5)}else e=n.format(NelioContent.i18n.dates.default);return e},_askForCommentDeletionConfirmation:function(){this._deletionStatus="awaiting-confirmation",this.trigger("nc:render")},_cancelCommentDeletion:function(){"awaiting-confirmation"===this._deletionStatus&&(this._deletionStatus="none",this.trigger("nc:render"))},_deleteComment:function(e){this._deletionStatus="deleting",this.trigger("nc:render"),this.model.destroy()},_clearAutoRenderTimeout:function(){0<this._autoRenderTimeout&&(clearTimeout(this._autoRenderTimeout),this._autoRenderTimeout=0)},close:function(){this._clearAutoRenderTimeout(),this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.EditorialComments=Backbone.View.extend({_commentViews:[],_rendered:!1,template:NelioContent.helpers.getTemplate("_nc-editorial-comments"),events:{"keypress textarea":"_maybeAddComment"},initialize:function(){void 0===this.collection&&(this.collection=new NelioContent.collections.EditorialComments),this.collection.each(function(e){var t=new NelioContent.views.EditorialComment({model:e});this._commentViews.push(t)},this),this.render=_.bind(this.render,this),this.listenTo(this.collection,"add",this._addEditorialComment),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this._removeEditorialComment),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection,"reset",this._resetCommentViews),this.listenTo(this.collection,"reset",this.render)},render:function(){this._rendered||(this.el.innerHTML=this.template(),this._rendered=!0);var t=this.$(".nc-editorial-comments");return t.children().detach(),_.each(this._commentViews,function(e){t.append(e.render().el)},this),t.length&&(t[0].scrollTop=t[0].scrollHeight),this},addComment:function(i){var n=new NelioContent.views.EditorialComment({model:i});n.setIsBeingSaved(!0),this._commentViews.push(n),this.stopListening(this.collection,"add",this._addEditorialComment),this.collection.add(i),this.listenTo(this.collection,"add",this._addEditorialComment),i.save(void 0,{success:function(e,t){i.set(t),n.setIsBeingSaved(!1)}})},_resetCommentViews:function(){_.each(this._commentViews,function(e){e.close()},this),this._commentViews=[],this.collection.each(this._addEditorialComment,this)},_addEditorialComment:function(e){var t=new NelioContent.views.EditorialComment({model:e});this._commentViews.push(t)},_removeEditorialComment:function(t){var e=_.filter(this._commentViews,function(e){return e.model===t},this);if(0<e.length){var i=e[0];this._commentViews=_.without(this._commentViews,i),this.stopListening(i),i.close()}},_maybeAddComment:function(e){if(13===e.keyCode&&!e.shiftKey){var t=this.$("textarea"),i=NelioContent.helpers.trim(t.val());if(t.val(""),0===i.length)return!1;var n=new NelioContent.models.EditorialComment({comment:i});return this.addComment(n),!1}},close:function(){_.each(this._commentViews,function(e){e.close()},this),this._commentViews=[],this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.Notifications=Backbone.View.extend({_views:{users:void 0},_followerTemplate:NelioContent.helpers.getTemplate("_nc-follower"),template:NelioContent.helpers.getTemplate("_nc-notifications"),events:{"click .nc-discard":"_removeFollower"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection.post,"change:author",this._changeAuthor),this.listenTo(this.collection.post,"change:author",this.render),this._views.users=new NelioContent.views.UserSelector({}),this.listenTo(this._views.users,"nc:change",this._onUserSelected)},render:function(){this._views.users.$el.detach();var e={amountOfFollowers:this.collection.length,followerIds:this.collection.pluck("id")};this.el.innerHTML=this.template(e);var i=this.$(".nc-followers");return this.collection.each(_.bind(function(e){var t=e.toJSON();t.isAuthor=this.collection.post.get("author")===e.get("id"),t.isCurrentUser=NelioContent.users.current().get("id")===e.get("id"),i.append(this._followerTemplate(t))},this)),this.$(".nc-users-placeholder").html(this._views.users.render().el),this._views.users.$el.trigger("change"),this},_onUserSelected:function(e){var t=NelioContent.users.getUser(e);this.collection.push(t),this.stopListening(this._views.users,"nc:change",this._onUserSelected),this._views.users.clearSelection(),this.listenTo(this._views.users,"nc:change",this._onUserSelected)},_changeAuthor:function(){var e=NelioContent.users.getUser(this.collection.post.get("author"));e.get("loading")?this.listenToOnce(e,"nc:load",_.bind(function(){this.collection.post.get("author")===e.get("id")&&this.collection.push(e)},this)):this.collection.push(e)},_removeFollower:function(e){var t=e.target||e.srcElement,i=parseInt(t.getAttribute("data-user-id"));if(!isNaN(i)){var n=this.collection.get(i);this.collection.remove(n)}},close:function(){this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.EditorialTask=Backbone.View.extend({_deletionStatus:"none",_isBeingSaved:!1,template:NelioContent.helpers.getTemplate("_nc-editorial-task"),events:{mouseleave:"_cancelTaskDeletion","click .nc-actions .nc-delete":"_askForTaskDeletionConfirmation","click .nc-actions .nc-cancel-deletion":"_cancelTaskDeletion","click .nc-actions .nc-do-delete":"_deleteTask","click input[type=checkbox]:not( .disabled )":"_toggleCompletion"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change:completed",this.render);var e=NelioContent.users.getUser(this.model.get("assigneeId"));e.isLoading()&&this.listenToOnce(e,"nc:load",_.bind(function(){this.trigger("nc:render")},this))},render:function(){var e=this.model.toJSON();return e.deletionStatus=this._deletionStatus,e.isBeingSaved=this._isBeingSaved,e.isAssignerMe=this.model.get("assignerId")===NelioContent.users.current().get("id"),e.isAssigneeMe=this.model.get("assigneeId")===NelioContent.users.current().get("id"),e.assigneeName=NelioContent.users.getUser(this.model.get("assigneeId")).get("name"),e.isOverdue=!1,e.dateFormatted=this._getDateFormatted(),this.isBeingSaved||(this.model.post.isPublished()||this.model.post.isScheduled())&&(e.isOverdue=this.model.get("dateDue").isBefore(ncNewLocalMoment())),this.el.innerHTML=this.template(e),this},setIsBeingSaved:function(e){this._isBeingSaved=e,this.trigger("nc:render")},_askForTaskDeletionConfirmation:function(){this._deletionStatus="awaiting-confirmation",this.trigger("nc:render")},_cancelTaskDeletion:function(){"awaiting-confirmation"===this._deletionStatus&&(this._deletionStatus="none",this.trigger("nc:render"))},_deleteTask:function(e){this._deletionStatus="deleting",this.trigger("nc:render"),this.model.destroy()},_toggleCompletion:function(){this._isBeingSaved=!0,this.trigger("nc:render");var e=this;this.model.toggleCompletionInAws(function(){e.setIsBeingSaved(!1),e.trigger("nc:render")})},_getDateFormatted:function(){if(this.model.post.isPublished()||this.model.post.isScheduled())return this.model.get("dateDue").calendar();var e;switch(this.model.get("dateType")){case"exact":return this.model.get("dateDue").calendar();case"predefined-offset":e=parseInt(this.model.get("dateValue"));break;case"negative-days":e=-parseInt(this.model.get("dateValue"));break;default:e=parseInt(this.model.get("dateValue"))}return e<0?NelioContent.i18n.dates.daysBeforePublication.replace("{days}",-e):0===e?NelioContent.i18n.dates.publicationDay:NelioContent.i18n.dates.daysAfterPublication.replace("{days}",e)},close:function(){this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.EditorialTasks=Backbone.View.extend({_taskViews:[],_newTaskView:!1,_rendered:!1,template:NelioContent.helpers.getTemplate("_nc-editorial-tasks"),events:{"click .nc-new-task-form-opener input":"_openNewTaskForm"},initialize:function(){void 0===this.collection&&(this.collection=new NelioContent.collections.EditorialTasks),this.collection.each(function(e){var t=new NelioContent.views.EditorialTask({model:e});this._taskViews.push(t)},this),this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.collection,"add",this._addEditorialTask),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this._removeEditorialTask),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection,"reset",this._resetTaskViews),this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"change:completed",this.render),this.listenTo(this,"nc:open:newTaskForm",this.render),this.listenTo(this,"nc:close:newTaskForm",this.render)},render:function(){if(0===this.collection.length&&(this._rendered=!1),!this._rendered){var e={taskCount:this.collection.length};this.el.innerHTML=this.template(e),this._rendered=0!==this.collection.length}var t=this.collection.where({completed:!0}),i=Math.round(100*t.length/this.collection.length),n=this.$(".nc-task-list-progress .nc-bar");100==i?n.addClass("nc-completed"):n.removeClass("nc-completed"),n.css("width",i+"%"),this.$(".nc-task-list-progress .nc-percentage").text(i+"%");var s=this.$(".nc-tasks");return s.children().detach(),_.each(this._taskViews,function(e){s.append(e.render().el)},this),this._newTaskView?(this.$(".nc-new-task-form-opener").hide(),this.$(".nc-new-task-form-container").append(this._newTaskView.render().el)):this.$(".nc-new-task-form-opener").show(),this},addEditorialTask:function(i){this._closeNewTaskForm();var n=new NelioContent.views.EditorialTask({model:i});n.setIsBeingSaved(!0),this._taskViews.push(n),this.stopListening(this.collection,"add",this._addEditorialTask),this.collection.add(i),this.listenTo(this.collection,"add",this._addEditorialTask);var s=this;i.save(void 0,{success:function(e,t){i.set(t),n.setIsBeingSaved(!1),s.trigger("nc:render")}})},_resetTaskViews:function(){_.each(this._taskViews,function(e){e.close()},this),this._taskViews=[],this.collection.each(this._addEditorialTask,this),this._sortEditorialTasks()},_addEditorialTask:function(e){var t=new NelioContent.views.EditorialTask({model:e});e.setPost(this.collection.post),this._taskViews.push(t)},_sortEditorialTasks:function(e){this._taskViews.sort(function(e,t){var i=e.model.getDateForSorting()+e.model.get("task"),n=t.model.getDateForSorting()+t.model.get("task");return i<n?-1:n<i?1:0})},_removeEditorialTask:function(t){var e=_.filter(this._taskViews,function(e){return e.model===t},this);if(0<e.length){var i=e[0];this._taskViews=_.without(this._taskViews,i),i.close()}},_openNewTaskForm:function(){this._newTaskView=new NelioContent.views.NewEditorialTask,this._newTaskView.model.setPost(this.collection.post),this.listenTo(this._newTaskView,"nc:create:task",this.addEditorialTask),this.listenTo(this._newTaskView,"nc:cancel",this._closeNewTaskForm),this.trigger("nc:open:newTaskForm")},_closeNewTaskForm:function(){this._newTaskView&&(this.stopListening(this._newTaskView),this._newTaskView.close(),this._newTaskView=!1,this.trigger("nc:close:newTaskForm"))},close:function(){_.each(this._taskViews,function(e){e.close()},this),this._taskViews=[],"function"==typeof this._newTaskView.close&&(this._newTaskView.close(),this._newTaskView=void 0),this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.NewEditorialTask=Backbone.View.extend({_assigneeView:void 0,_dueDateView:void 0,_$saveButton:void 0,template:NelioContent.helpers.getTemplate("_nc-new-editorial-task"),events:{"keyup textarea":"_updateTask","change textarea":"_updateTask","click .nc-cancel":"_cancel","click .nc-add-task:not( .button-disabled )":"_addTask","click .nc-color":"_changeColor"},initialize:function(){this.model=new NelioContent.models.EditorialTask,this._assigneeView=new NelioContent.views.UserSelector({defaultValue:this.model.get("assigneeId")}),this._dueDateView=new NelioContent.views.DateSelector({model:this.model}),this.render=_.bind(this.render,this),this.listenTo(this.model,"change:task",this._maybeEnableAddButton),this.listenTo(this.model,"change:dateType",this._maybeEnableAddButton),this.listenTo(this.model,"change:dateValue",this._maybeEnableAddButton)},render:function(){void 0!==this._$saveButton&&this._$saveButton.tooltip("destroy");var e=this.model.toJSON();return this.el.innerHTML=this.template(e),this.$(".nc-assignee").html(this._assigneeView.render().el),this.$(".nc-date").html(this._dueDateView.render().el),this._$saveButton=this.$(".nc-add-task"),NelioContent.helpers.makeWarningTooltip(this._$saveButton),this},_cancel:function(){this.trigger("nc:cancel")},_addTask:function(){this.model.set({task:this.$("textarea").val(),assignerId:NelioContent.users.current().get("id"),assigneeId:parseInt(NelioContent.helpers.trim(this.$(".nc-assignee select").val()),10)}),this.trigger("nc:create:task",this.model)},_updateTask:function(e){this.model.set("task",NelioContent.helpers.trim(this.$("textarea").val())),13!==e.keyCode||this.model.isSomethingMissing()||this._addTask()},_maybeEnableAddButton:function(){this._$saveButton.tooltip("close");var e=this.model.isSomethingMissing();e?(this._$saveButton.addClass("button-disabled"),this._$saveButton.attr("title",e)):(this._$saveButton.removeClass("button-disabled"),this._$saveButton.attr("title",""))},_changeColor:function(e){var t=e.target||e.srcElement,i=a(t);if(i.data("color")===this.model.get("color"))return i.removeClass("nc-selected"),void this.model.set("color","none");this.$(".nc-colors .nc-color").removeClass("nc-selected"),this.model.set("color",i.data("color")),this.$(".nc-colors .nc-color.nc-"+this.model.get("color")).addClass("nc-selected")},close:function(){this._assigneeView.close(),this._dueDateView.close(),this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.References=Backbone.View.extend({_rendered:!1,_views:{suggestedReferences:void 0,externalReferences:void 0},_tabTemplate:NelioContent.helpers.getTemplate("_nc-reference-tabs"),_mode:"suggested",events:{"click .nc-reference-tabs .nc-tab:not( .nc-active )":"_switchTab"},initialize:function(e){void 0===e&&(e={}),this.suggestedReferences=e.suggestedReferences,this._views.suggestedReferences=new NelioContent.views.SuggestedReferences({collection:e.suggestedReferences}),this._views.externalReferences=new NelioContent.views.ExternalReferences({collection:e.externalReferences}),this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render)},render:function(){switch(this.$el.html(this._tabTemplate()),this.$(".nc-"+this._mode+"-references-tab").addClass("nc-active"),this._mode){case"external":this.$el.append(this._views.externalReferences.render().$el);break;default:this.$el.append(this._views.suggestedReferences.render().$el)}return this},getSuggestedReferences:function(){return this._views.suggestedReferences.collection},setExternalReferences:function(e){this._views.externalReferences.updateReferenceList(e)},_switchTab:function(e){var t=e.target||e.srcElement;t.className&&-1<t.className.indexOf("nc-external-references-tab")?this._mode="external":this._mode="suggested",this.trigger("nc:render")},close:function(){_.each(this._views,function(e){e.close()},this),this._views={},this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.SuggestedReference=Backbone.View.extend({_awaitingDiscardConfirmation:!1,_referenceEditor:void 0,template:NelioContent.helpers.getTemplate("_nc-suggested-reference"),events:{mouseleave:"_cancelDiscard","click .nc-actions .nc-edit":"_editReference","click .nc-actions .nc-discard":"_askForDiscardConfirmation","click .nc-actions .nc-cancel-discard":"_cancelDiscard","click .nc-actions .nc-do-discard":"_discard"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change",this.render)},render:function(){var e=this.model.toJSON();e.awaitingDiscardConfirmation=this._awaitingDiscardConfirmation;var t=this.model.get("suggestionAdvisorId");return e.wasSuggestedByMe=t===NelioContent.users.current().get("id"),e.wasSuggestedByNelio=0===NelioContent.users.current().get("id"),this.el.innerHTML=this.template(e),this},_editReference:function(){var e=new NelioContent.models.Reference(this.model.toJSON());this._referenceEditor=new NelioContent.views.ReferenceEditor({model:e}),this.listenTo(this._referenceEditor,"nc:update:reference",this._updateReference),this.listenTo(this._referenceEditor,"nc:close:dialog",this._closeDialog),this.trigger("nc:open:editorDialog"),this._referenceEditor.openDialog()},_updateReference:function(e){this.model.set(e)},_closeDialog:function(){this._referenceEditor.close(),this._referenceEditor=void 0,this.trigger("nc:close:editorDialog")},_askForDiscardConfirmation:function(){this._awaitingDiscardConfirmation=!0,this.trigger("nc:render")},_cancelDiscard:function(){this._awaitingDiscardConfirmation=!1,this.trigger("nc:render")},_discard:function(){this._awaitingDiscardConfirmation=!1,this.model.trigger("nc:discard",this.model)},close:function(){this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.SuggestedReferences=Backbone.View.extend({_urlMatcher:/^https?:\/\/([\da-z\.-]+)\.([a-z]{2,6})(\/[^\/\s]+)*\/?$/i,_referenceViews:[],template:NelioContent.helpers.getTemplate("_nc-suggested-references"),events:{"keypress input[type=url]":"_doNotPropagateEnter","keyup input[type=url]":"_onUrlChange","change input[type=url]":"_onUrlChange","click .nc-actions .button:not( .button-disabled )":"_addReference"},initialize:function(e){void 0===this.collection&&(this.collection=new NelioContent.collections.References),this._resetReferenceViews(),this.render=_.bind(this.render,this),this.listenTo(this.collection,"add",this._resetReferenceViews),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this._resetReferenceViews),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection,"reset",this._resetReferenceViews),this.listenTo(this.collection,"reset",this.render)},render:function(){try{this.$(".nc-actions .button").tooltip("destroy")}catch(e){}var e={amITheAuthor:this.collection.post.get("author")===NelioContent.users.current().get("id")};if(this.el.innerHTML=this.template(e),0<this._referenceViews.length){var t=this.$(".nc-list");t.empty(),_.each(this._referenceViews,function(e){t.append(e.render().el)},this)}return NelioContent.helpers.makeWarningTooltip(this.$(".nc-actions .button")),this._maybeEnableAddButton(),this.delegateEvents(),this},_resetReferenceViews:function(){_.each(this._referenceViews,function(e){e.close()},this),this._referenceViews=[],this.collection.each(function(e){var t=new NelioContent.views.SuggestedReference({model:e});this._referenceViews.push(t)},this)},_doNotPropagateEnter:function(e){13===e.keyCode&&(e.preventDefault(),e.stopPropagation())},_onUrlChange:function(e){if(this._maybeEnableAddButton()){var t=e.target||e.srcElement;this.$(t);13===e.keyCode&&this._addReference()}},_maybeEnableAddButton:function(){var e=this.$(".nc-actions .button"),t=this.$(".nc-reference-url input");return 0===NelioContent.helpers.trim(t.val()).length?(e.addClass("button-disabled"),e.attr("title",NelioContent.i18n.errors.reference.noUrl),!1):this._urlMatcher.test(NelioContent.helpers.trim(t.val()))?(e.removeClass("button-disabled"),e.attr("title",""),!0):(e.addClass("button-disabled"),e.attr("title",NelioContent.i18n.errors.reference.invalidUrl),!1)},_addReference:function(){var e=this.$("input[type=url]"),t=e.val();e.val(""),this.collection.suggestReference({id:t,url:t,urlEscaped:_.escape(t)})},close:function(){_.each(this._referenceViews,function(e){e.close()},this),this._referenceViews=[],this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.ExternalReference=Backbone.View.extend({_awaitingDiscardConfirmation:!1,_referenceEditor:void 0,template:NelioContent.helpers.getTemplate("_nc-external-reference"),events:{"click .nc-actions .nc-edit":"_editReference"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change",this.render)},render:function(){var e=this.model.toJSON();return e.awaitingDiscardConfirmation=this._awaitingDiscardConfirmation,this.el.innerHTML=this.template(e),this},_editReference:function(){var e=new NelioContent.models.Reference(this.model.toJSON());this._referenceEditor=new NelioContent.views.ReferenceEditor({model:e}),this.listenTo(this._referenceEditor,"nc:update:reference",this._updateReference),this.listenTo(this._referenceEditor,"nc:close:dialog",this._closeDialog),this.trigger("nc:open:editorDialog"),this._referenceEditor.openDialog()},_updateReference:function(e){this.model.set(e)},_closeDialog:function(){this._referenceEditor.close(),this._referenceEditor=void 0,this.trigger("nc:close:editorDialog")},close:function(){this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.ExternalReferences=Backbone.View.extend({_referenceViews:[],template:NelioContent.helpers.getTemplate("_nc-external-references"),initialize:function(e){void 0===this.collection&&(this.collection=new NelioContent.collections.References),this._resetReferenceViews(),this.render=_.bind(this.render,this),this.updateReferenceList=_.debounce(_.bind(this.updateReferenceList,this),1200),this.listenTo(this.collection,"add",this._resetReferenceViews),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this._resetReferenceViews),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection,"reset",this._resetReferenceViews),this.listenTo(this.collection,"reset",this.render)},render:function(){if(this.el.innerHTML=this.template(),0<this._referenceViews.length){var t=this.$(".nc-list");t.empty(),_.each(this._referenceViews,function(e){t.append(e.render().el)},this)}return this},updateReferenceList:function(t){var e=_.reject(t,_.bind(function(e){return this.collection.get(e)},this));this.collection.includeReferences(e);var i=_.filter(this.collection.pluck("id"),_.bind(function(e){return!_.contains(t,e)},this));this.collection.removeIncludedReferences(i)},_resetReferenceViews:function(){_.each(this._referenceViews,function(e){e.close()},this),this._referenceViews=[],this.collection.each(function(e){var t=new NelioContent.views.ExternalReference({model:e});this._referenceViews.push(t)},this)},close:function(){_.each(this._referenceViews,function(e){e.close()},this),this._referenceViews=[],this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.ReferenceEditor=Backbone.View.extend({_$saveButton:void 0,template:NelioContent.helpers.getTemplate("_nc-reference-editor"),events:{"change input.nc-title":"_updateTitle","keyup input.nc-title":"_updateTitle","change input.nc-url":"_updateUrl","keyup input.nc-url":"_updateUrl","change input.nc-author":"_updateAuthor","keyup input.nc-author":"_updateAuthor","change input.nc-email":"_updateEmail","keyup input.nc-email":"_updateEmail","change input.nc-twitter":"_updateTwitter","keyup input.nc-twitter":"_updateTwitter"},initialize:function(){this.render=_.bind(this.render,this),this._onDialogSave=_.bind(this._onDialogSave,this),this._onDialogCancel=_.bind(this._onDialogCancel,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change:url",this._maybeEnableSaveButton),this.listenTo(this.model,"change:twitter",this._maybeEnableSaveButton),this.listenTo(this.model,"change:email",this._maybeEnableSaveButton)},render:function(){var e=this.model.toJSON();return e.authorEscaped=_.escape(e.author),this.el.innerHTML=this.template(e),this},openDialog:function(){var e=[];this.model.get("isExternal")?e.push(NelioContent.helpers.makeDialogCancelButton(this,NelioContent.i18n.actions.cancel)):e.push(NelioContent.helpers.makeDialogCancelButton(this,NelioContent.i18n.actions.close)),e.push(NelioContent.helpers.makeDialogSaveButton(this,NelioContent.i18n.actions.save));var t=this;this.$el.dialog({title:NelioContent.i18n.titles.editReference,buttons:e,modal:!0,width:Math.min(600,NelioContent.helpers.getWindowWidth()-20),dialogClass:"nc-dialog",position:{my:"center top",at:"center top+45"},open:function(){t.listenTo(t,"nc:click:dialog:save",t._onDialogSave),t.listenTo(t,"nc:click:dialog:cancel",t._onDialogCancel),t._$saveButton=t.$el.parent().find(".button-primary"),NelioContent.helpers.makeWarningTooltip(t._$saveButton)},close:function(){t.stopListening(t,"nc:click:dialog:save",t._onDialogSave),t.stopListening(t,"nc:click:dialog:cancel",t._onDialogCancel),t._$saveButton.tooltip("destroy"),t.$el.dialog("destroy"),t.trigger("nc:close:dialog")}}),this.trigger("nc:render")},_updateTitle:function(){var e=this.$("input.nc-title").val();this.model.set("title",NelioContent.helpers.trim(e))},_updateUrl:function(){var e=this.$("input.nc-url").val();this.model.set("url",NelioContent.helpers.trim(e))},_updateAuthor:function(){var e=this.$("input.nc-author").val();this.model.set("author",NelioContent.helpers.trim(e))},_updateEmail:function(){var e=this.$("input.nc-email").val();this.model.set("email",NelioContent.helpers.trim(e))},_updateTwitter:function(){var e=this.$("input.nc-twitter").val();this.model.set("twitter",NelioContent.helpers.trim(e))},_lock:function(){this.$("input").attr("disabled","disabled")},_unlock:function(){this.model.get("isExternal")&&this.$("input").removeAttr("disabled")},_maybeEnableSaveButton:function(){this._$saveButton.tooltip("close");var e=this.model.isSomethingMissing();e?(this._$saveButton.addClass("button-disabled"),this._$saveButton.attr("title",e)):(this._$saveButton.removeClass("button-disabled"),this._$saveButton.attr("title",""))},_onDialogSave:function(){if(!this.model.isSomethingMissing()){var e=this.$el.parent(),t=e.find(".ui-dialog-titlebar button, .ui-dialog-buttonpane button:not( .button-primary )"),i=e.find(".ui-dialog-buttonpane button.button-primary");this._lock(),this.$el.dialog("option","closeOnEscape",!1),t.prop("disabled",!0),i.prop("disabled",!0),i.html(NelioContent.i18n.feedback.saving);var n=this;a.ajax({url:ajaxurl,data:{action:"nelio_content_update_reference",reference:n.model.get("postId"),title:n.model.get("title"),url:n.model.get("url"),author:n.model.get("author"),email:n.model.get("email"),twitter:n.model.get("twitter")},success:function(e){e?(n.trigger("nc:update:reference",e),n.$el.dialog("close")):this.error()},error:function(e){NelioContent.helpers.openErrorDialog(e.responseJSON),i.html(NelioContent.i18n.actions.save),t.prop("disabled",!1),i.prop("disabled",!1),n.$el.dialog("option","closeOnEscape",!0),n._unlock()}})}},_onDialogCancel:function(){this.$el.dialog("close")},close:function(){this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.PostAnalysisView=Backbone.View.extend({_areDetailsVisible:ncstore.get("nc-post-analysis-visible-details["+NelioContent.wpBlogId+"]",!1),_data:{},_summary:"pending",_postStatus:"draft",_postType:"post",_discardPendingTimeout:0,template:NelioContent.helpers.getTemplate("_nc-post-analysis"),events:{"click .nc-details-control":"_toggleDetailsVisibility"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render);var e=this;this.listenTo(this,"nc:change",_.debounce(function(){e.trigger("nc:render")},600)),this._data={author:"pending",excerpt:"pending",externalLinks:"pending",imageCount:"pending",internalLinks:"pending",tag:"pending",textLength:"pending",thumbnail:"pending",social:"pending",tasks:"pending"},NelioContent.helpers.isSubscribed()||(this._data.tasks=void 0),NelioContent.postAnalysis.isYoastSeoIntegrated&&(this._data.yoastSeo="pending",this._data.yoastContent="pending"),this._discardPendingTimeout=setTimeout(function(){e._discardPendingDetails()},15e3)},render:function(){this._updateSummary();var e=_.clone(this._data);return e.isPostPublished="publish"===this._postStatus,e.areDetailsVisible=this._areDetailsVisible,e.summary=this._summary,this.el.innerHTML=this.template(e),this},onPostChange:function(e){this._postStatus=e.get("status"),this._postType=e.get("type"),"post"!==this._postType&&(this._data.tag=void 0),"publish"===this._postStatus&&(this._data.social=void 0);var t=NelioContent.users.getUser(e.get("author"));t.isLoading()?this.listenToOnce(t,"nc:load",_.bind(function(){this._checkAuthor(t),this.trigger("nc:change")},this)):this._checkAuthor(t),NelioContent.helpers.trim(e.get("excerpt")).length<20?this._data.excerpt="improvable":this._data.excerpt="good";var i=e.get("image"),n=e.get("autoImage"),s=_.where(NelioContent.postTypes,{name:e.get("type")}),o=s.length&&s[0].supportsFeaturedImage;0<e.get("imageId")?this._data.thumbnail="good":"string"==typeof i&&0<i.length?this._data.thumbnail="good":"string"==typeof n&&0<n.length?this._data.thumbnail="improvable":this._data.thumbnail=o?"bad":void 0,this.trigger("nc:change")},_checkAuthor:function(e){"administrator"===e.get("role")?this._data.author="improvable":this._data.author="good"},onSocialMessageListUpdate:function(e){"publish"!==this._postStatus&&(0===e.length?this._data.social="bad":1===e.length?this._data.social="improvable":this._data.social="good",this.trigger("nc:change"))},onTaskListUpdate:function(e){if("post"!==this._postType)return this._data.tag=void 0,void this.trigger("nc:change");var t=[];"function"==typeof e.where&&(t=e.where(function(e){return!e.get("completed")})),0<t.length?this._data.tasks="bad":this._data.tasks="good",this.trigger("nc:change")},onLinksChange:function(e){for(var t=0,i=0,n=NelioContent.blogUrl.toLowerCase().replace(/^https:/,"http:"),s=/^[a-zA-Z]+:\/\//,o=0;o<e.length;++o){var a=e[o].toLowerCase().replace(/^https:/,"http:");if(0===a.indexOf(n)?++i:s.test(a)?++t:++i,2<=i&&2<=t)break}this._data.internalLinks=0===i?"bad":1===i?"improvable":"good",this._data.externalLinks=0===t?"bad":1===t?"improvable":"good",this.trigger("nc:change")},onImageCountChange:function(e){this._data.imageCount=0<e?"good":"improvable",this.trigger("nc:change")},onTextLengthChange:function(e){var t=NelioContent.postAnalysis.minPostLength;e<Math.floor(.6*t)?this._data.textLength="bad":e<Math.floor(.95*t)?this._data.textLength="improvable":this._data.textLength="good",this.trigger("nc:change")},onTagListUpdate:function(e){void 0!==this._data.tag&&(0<e.length?this._data.tag="good":this._data.tag="bad",this.trigger("nc:change"))},onYoastSeoChange:function(e){NelioContent.postAnalysis.isYoastSeoIntegrated&&(this._data.yoastSeo=e,this.trigger("nc:change"))},onYoastContentChange:function(e){NelioContent.postAnalysis.isYoastSeoIntegrated&&(this._data.yoastContent=e,this.trigger("nc:change"))},_toggleDetailsVisibility:function(){this._areDetailsVisible=!this._areDetailsVisible,ncstore.set("nc-post-analysis-visible-details["+NelioContent.wpBlogId+"]",this._areDetailsVisible),this.trigger("nc:render")},_updateSummary:function(){var e=_.filter(_.values(this._data),function(e){return"pending"===e}).length,t=(_.filter(_.values(this._data),function(e){return"good"===e}).length,_.filter(_.values(this._data),function(e){return"improvable"===e}).length),i=_.filter(_.values(this._data),function(e){return"bad"===e}).length;this._summary=0<e?"pending":0===t+i?"awesome":0===i&&t<3?"good":i<=1?"improvable":"bad"},_discardPendingDetails:function(){clearTimeout(this._discardPendingTimeout),this._discardPendingTimeout=0,this._data=_.object(_.map(this._data,function(e,t){return"pending"===e?[t,"unknown"]:[t,e]})),this.trigger("nc:change")},close:function(){0<this._discardPendingTimeout&&(clearTimeout(this._discardPendingTimeout),this._discardPendingTimeout=0),this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.MetaBoxError=Backbone.View.extend({template:NelioContent.helpers.getTemplate("_nc-meta-box-error"),initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this.model,"change",this.render)},render:function(){var e=this.model.toJSON();return this.el.innerHTML=this.template(e),this},close:function(){this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}});var l=a("#title"),r=a("#excerpt"),c=a("#post_author_override"),n=0<window.location.href.indexOf("nc-auto-messages=true");NelioContent.helpers.removeParamFromUrl("nc-auto-messages"),a(document).ready(function(){if(n){var e=document.getElementById("nelio-content-social-timeline-container");e&&setTimeout(function(){e=e.getBoundingClientRect(),a("body, html").animate({scrollTop:Math.max(window.scrollY+e.top-60,0)})},3e3)}});var h,s,d,o,g=!1;a(document).on("tinymce-editor-init",function(e,t){g=t,a(document).trigger("nc:tinymce-editor",g)}),a.ajax({url:ajaxurl,data:{action:"nelio_content_get_post",post:a("#post_ID").val()},success:function(e){t=new NelioContent.models.Post(e)},error:function(){t=new NelioContent.models.Post({id:parseInt(a("#post_ID").val(),10),title:NelioContent.helpers.decodeHTMLEntities(l.val()),excerpt:NelioContent.helpers.decodeHTMLEntities(r.text()),permalink:a("#sample-permalink a").attr("href"),author:parseInt(a("#post_author").val(),10),status:"auto-draft"})},complete:function(){t.set("imageId",parseInt(a("#nc-feat-image-thumbnail-id").val(),10)),t.set("image",a("#nc-feat-image-url").val()),t.set("autoImage",a("#nc-feat-image-auto-url").val()),function(i){h.collection.setPost(i),n&&(h.fillTimelineAutomatically(),a("#nelio-content-social-timeline-container").html(h.render().el));o=new NelioContent.views.Notifications({collection:new NelioContent.collections.Followers(null,{post:i})}),a("#nelio-content-notifications-container").html(o.render().el),a.ajax({url:NelioContent.apiUri+"/post/"+i.get("id")+"/items",method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},success:function(e){if(n||(h.collection.reset(e.social),h.listenToOnce(NelioContent.profiles,"nc:ready",function(){a("#nelio-content-social-timeline-container").html(h.render().el)}),NelioContent.profiles.isReady()&&NelioContent.profiles.trigger("nc:ready")),d.collection.setPost(i),d.collection.reset(e.tasks),a("#nelio-content-editorial-tasks-container").html(d.render().el),s.collection.setPost(i),NelioContent.helpers.isSubscribed())s.collection.reset(e.comments);else{var t=new NelioContent.models.EditorialComment({comment:NelioContent.i18n.messages.commentFreeMessage,authorId:"davilera",postId:i.get("id"),postType:i.get("type")});s.collection.reset(),s.collection.add(t)}a("#nelio-content-editorial-comments-container").html(s.render().el)},error:function(e){var t=new NelioContent.models.AjaxError;t.parseResponse(e),h.close(),a("#nelio-content-social-timeline-container").html(new NelioContent.views.MetaBoxError({model:t}).render().el),s.close(),a("#nelio-content-editorial-comments-container").html(new NelioContent.views.MetaBoxError({model:t}).render().el),o.close(),a("#nelio-content-notifications-container").html(new NelioContent.views.MetaBoxError({model:t}).render().el),d.close(),a("#nelio-content-editorial-tasks-container").html(new NelioContent.views.MetaBoxError({model:t}).render().el)}})}(t),function(t){t.listenTo(Backbone,"nc:change:featuredImage",function(e){t.set({imageId:e.get("attachmentId"),image:e.get("url")})}),NCTinyMce.post=t,u.setPost(t),m.setPost(t),a.ajax({url:ajaxurl,data:{action:"nelio_content_get_post_references",post:a("#post_ID").val()},success:function(e){u.reset(e.suggested),m.reset(_.filter(e.included,function(e){return NelioContent.helpers.isExternalReference(e.url)})),a("#nelio-content-links-container").html(v.render().el)},error:function(e){var t=new NelioContent.models.AjaxError;t.parseResponse(e),a("#nelio-content-links-container").html(new NelioContent.views.MetaBoxError({model:t}).render().el)}}),NelioContent.postAnalysis.enabled?a("#submitdiv .nelio-content-post-analysis-container").length?a("#submitdiv .nelio-content-post-analysis-container").html(f.render().el):a(".nelio-content-post-analysis-container").html(f.render().el):a(".nelio-content-post-analysis-container").remove();NelioContent.postAnalysis.enabled&&(f.listenTo(h.collection,"reset",f.onSocialMessageListUpdate),f.listenTo(h.collection,"update",f.onSocialMessageListUpdate),f.onSocialMessageListUpdate(h.collection));NelioContent.postAnalysis.enabled&&NelioContent.helpers.isSubscribed()&&(f.listenTo(d.collection,"reset",f.onTaskListUpdate),f.listenTo(d.collection,"update",f.onTaskListUpdate),f.listenTo(d.collection,"nc:change:model",f.onTaskListUpdate),f.onTaskListUpdate(d.collection));NelioContent.postAnalysis.enabled&&(f.listenTo(t,"change",f.onPostChange),f.onPostChange(t));NelioContent.postAnalysis.enabled&&(a("#tax-input-post_tag").on("change keyup",function(){var e=NelioContent.helpers.trim(a("#tax-input-post_tag").val());e=e.replace(", ","").split(""),f.onTagListUpdate(e)}),a("#tax-input-post_tag").trigger("change"));if(NelioContent.postAnalysis.enabled&&NelioContent.postAnalysis.isYoastSeoIntegrated){var e=function(){var e,t=a("#yoast-seo-analysis-collapsible-metabox > svg");e=t.hasClass("yoast-svg-icon-seo-score-none")?"unknown":t.hasClass("yoast-svg-icon-seo-score-bad")?"improvable":t.hasClass("yoast-svg-icon-seo-score-ok")?"improvable":t.hasClass("yoast-svg-icon-seo-score-good")?"good":"unknown",f.onYoastSeoChange(e)};NelioContent.helpers.addStyle("#misc-publishing-actions .yoast-seo-score.keyword-score { display:none!important; }"),a(window).on("YoastSEO:numericScore",e),e();var i=function(){var e,t=a("#yoast-readability-analysis-collapsible-metabox > svg");e=t.hasClass("yoast-svg-icon-seo-score-none")?"unknown":t.hasClass("yoast-svg-icon-seo-score-bad")?"improvable":t.hasClass("yoast-svg-icon-seo-score-ok")?"improvable":t.hasClass("yoast-svg-icon-seo-score-good")?"good":"unknown",f.onYoastContentChange(e)};NelioContent.helpers.addStyle("#misc-publishing-actions .yoast-seo-score.content-score { display:none!important; }"),a(window).on("YoastSEO:numericScore",i),i()}function n(e){if(NelioContent.postAnalysis.enabled&&!NelioContent.helpers.isGutenbergActive()){var t=parseInt(a("#wp-word-count .word-count").text(),10);if(isNaN(t)&&(t=0),0===t&&wp.utils&&wp.utils.WordCounter)t=(new wp.utils.WordCounter).count(e);f.onLinksChange(NelioContent.helpers.extractReferences(e)),f.onImageCountChange(NelioContent.helpers.countImages(e)),f.onTextLengthChange(t)}}function s(t){v.getSuggestedReferences().each(function(e){e.testIfIsInPostContent(t)});var e=NelioContent.helpers.extractReferences(t);e=_.filter(e,NelioContent.helpers.isExternalReference),v.setExternalReferences(e)}NelioContent.postAnalysis.enabled&&f.onTextLengthChange(a("#wp-word-count .word-count").text());var o=!1;a(document).on("nc:tinymce-editor",function(e,t){o||(o=!0,t.on("nodechange keyup",NelioContent.helpers.callAndDebounce(function(){var e=t.getContent();n(e),s(e)},4e3,1500)),v.suggestedReferences.bind("add reset",NelioContent.helpers.callAndDebounce(function(){s(t.getContent())},4e3,1500)))}),g&&a(document).trigger("nc:tinymce-editor",g);(function(){var t=a("#content");t.on("nodechange keyup",NelioContent.helpers.callAndDebounce(function(){var e=t.val();n(e),s(e)},4e3,1500)),v.suggestedReferences.bind("add reset",NelioContent.helpers.callAndDebounce(function(){s(t.val())},4e3,1500));try{QTags.addButton("nc-share-selection",NelioContent.i18n.actions.shareSelection,function(e,t){var i=NelioContent.helpers.getSelection(t);0===(i=NelioContent.helpers.trim(i)).length&&(i="{title}");var n=new NelioContent.models.SocialMessage;n.setPost(NCTinyMce.timelineView.collection.post),n.set("text",i+" {permalink}"),n.set("profileId",NelioContent.profiles.at(0).get("id"));var s=new NelioContent.views.SocialMessageEditor({model:n});Backbone.listenToOnce(s,"nc:add:messages",function(e){NCTinyMce.timelineView.collection.add(e)}),s.render()})}catch(e){}})(),l.on("change",_.debounce(function(){t.set("title",NelioContent.helpers.decodeHTMLEntities(l.val()))},2e3)),r.on("change",_.debounce(function(){t.set("excerpt",NelioContent.helpers.decodeHTMLEntities(r.val()))},2e3)),c.on("change",_.debounce(function(){t.set("author",parseInt(c.val(),10))},500))}(t)}}),h=new NelioContent.views.SocialTimeline,window.NCTinyMce=window.NCTinyMce||{},NCTinyMce.timelineView=h,d=new NelioContent.views.EditorialTasks,s=new NelioContent.views.EditorialComments;var u=new NelioContent.collections.References;NCTinyMce.suggestedReferences=u;var m=new NelioContent.collections.References;NCTinyMce.externalReferences=m;var v=new NelioContent.views.References({suggestedReferences:u,externalReferences:m});NCTinyMce.referencesView=v;var f=!1;NelioContent.postAnalysis.enabled&&(f=new NelioContent.views.PostAnalysisView,NCTinyMce.postAnalysisView=f)}(jQuery);