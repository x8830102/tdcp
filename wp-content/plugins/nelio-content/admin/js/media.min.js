!function(o){"use strict";var e,s;NelioContent.models.Model=Backbone.Model.extend({clearToDefaults:function(){var e={silent:!0};return this.clear(e),"function"==typeof this.defaults?this.set(this.defaults(),e):this.set(this.defaults,e),this},sync:function(e,t,n){return(n=n||{}).beforeSend=function(e){e.setRequestHeader("Authorization","Bearer "+NelioContent.apiAuthToken)},Backbone.Model.prototype.sync.apply(this,arguments)}}),NelioContent.collections.Collection=Backbone.Collection.extend({sync:function(e,t,n){return(n=n||{}).beforeSend=function(e){e.setRequestHeader("Authorization","Bearer "+NelioContent.apiAuthToken)},Backbone.Collection.prototype.sync.apply(this,arguments)}}),NelioContent.helpers.getTemplate=function(e){var t=document.getElementById(e);return t?NelioContent.helpers.template(t.innerHTML):(console.warn("Template «"+e+"» not found. Using empty template."),NelioContent.helpers.template(""))},NelioContent.helpers.template=function(e){return _.template(NelioContent.helpers.trim(e),{evaluate:/\[\*([\s\S]+?)\*\]/g,interpolate:/\[\*=([\s\S]+?)\*\]/g,escape:/\[\*~([\s\S]+?)\*\]/g})},e=jQuery,s=-1,NelioContent.helpers.chunk=function(e,t){for(var n=[],i=0;i<e.length;i+=t)n.push(e.slice(i,i+t));return n},NelioContent.helpers.isGutenbergActive=function(){return!!(wp&&wp.data&&wp.data.select("core/editor"))},NelioContent.helpers.refreshAuthToken=function(t,n){e.ajax({url:ajaxurl,data:{action:"nelio_content_get_api_auth_token"},success:function(e){NelioContent.apiAuthToken=e,"function"==typeof t&&t()},error:function(e){"function"==typeof n&&n(e)}})},NelioContent.helpers.isSubscribed=function(){return"none"!==NelioContent.subscription},NelioContent.helpers.getWindowWidth=function(){return e(window).width()},NelioContent.helpers.getScrollbarWidth=function(){if(0<=s)return s;var e=document.createElement("div");e.style.visibility="hidden",e.style.width="100px",e.style.msOverflowStyle="scrollbar",document.body.appendChild(e);var t=e.offsetWidth;e.style.overflow="scroll";var n=document.createElement("div");n.style.width="100%",e.appendChild(n);var i=n.offsetWidth;return e.parentNode.removeChild(e),s=t-i},NelioContent.helpers.openPopup=function(e,t,n){var i=void 0!==window.screenLeft?window.screenLeft:screen.left,o=void 0!==window.screenTop?window.screenTop:screen.top,s=(window.innerWidth?window.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width)/2-t/2+i,r=(window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:screen.height)/2-n/2+o,a=window.open(e,"","width="+t+", height="+n+", top="+r+", left="+s);return window.focus&&a.focus(),a},NelioContent.helpers.addStyle=function(e){var t=document.head||document.getElementsByTagName("head")[0],n=document.createElement("style");n.type="text/css",n.styleSheet?n.styleSheet.cssText=e:n.appendChild(document.createTextNode(e)),t.appendChild(n)},NelioContent.helpers.callAndDebounce=function(e,t,n){function i(){e(),o=!0}"number"!=typeof n&&(n=0);var o=!1;0===n?i():setTimeout(i,n);var s=_.debounce(e,t);return function(){o&&s()}},NelioContent.helpers.getParamFromUrl=function(e,t){arguments.length<2&&(t=e,e=window.location.href);var n=e.split("?")[1]||"";n=n.split("&");for(var i=0;i<n.length;++i){var o=n[i];if(o===t)return"";if(0===o.indexOf(t+"="))return o.replace(t+"=","")}},NelioContent.helpers.addParamInUrl=function(e,t,n){var i=!1;arguments.length<3&&(n=t,t=e,e=window.location.href,i=!0);var o=e.split("?");e=o[0];var s,r=o[1]||"";for(r=r.split("&"),s=0;s<r.length;++s){var a=r[s];if(a===t||0===a.indexOf(t+"="))break}return r[s]=void 0===n?t:t+"="+encodeURIComponent(n),0<r.length&&(e+="?"+r.join("&")),i&&"function"==typeof history.replaceState&&history.replaceState(null,null,e),e},NelioContent.helpers.removeParamFromUrl=function(e,t){var n=!1;arguments.length<2&&(t=e,e=window.location.href,n=!0);var i=t;"string"==typeof i&&(i=[t]);var o=e.split("?");e=o[0];var s=o[1]||"";s=s.split("&");for(var r=0;r<s.length;++r)for(var a=s[r],l=0;l<i.length;++l)a!==(t=i[l])&&0!==a.indexOf(t+"=")||(s[r]=void 0);return 0<s.length&&(e+="?"+s.join("&").replace(/&+/g,"&").replace(/^&|&$/g,"")),n&&"function"==typeof history.replaceState&&history.replaceState(null,null,e),e},NelioContent.helpers.getSelection=function(e){if(void 0!==document.selection)return e.focus(),document.selection.createRange().text;if(void 0===e.selectionStart)return"";var t=e.selectionStart,n=e.selectionEnd;return e.value.substring(t,n)},NelioContent.helpers.getAbsoluteUrl=function(e){return/^\/\//.test(e)?"http:"+e:"/"===e[0]?NelioContent.blogUrl.replace(/^((https?:)?\/\/[^\/]+).*$/,"$1")+e:e},function(){NelioContent.helpers.trim=function(e){return null==e?"":"string"!=typeof e?e:e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},NelioContent.helpers.capitalizeFirstLetter=function(e){return"string"!=typeof e?"":e.charAt(0).toUpperCase()+e.slice(1)},NelioContent.helpers.strongify=function(e,t){t=(t=t.replace("\\","")).replace(".","\\.");var n=new RegExp(t,"gi");return e.replace(n,"<strong>$&</strong>")},NelioContent.helpers.getTweetLength=function(e){return e=e.replace(/[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f]/g,"aa"),twttr.txt.getTweetLength(e)};var t=document.createElement("div");NelioContent.helpers.decodeHTMLEntities=function(e){return"string"!=typeof e?"":(e=(e=e.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,"")).replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,""),t.innerHTML=e,e=t.textContent,NelioContent.helpers.trim(e))},NelioContent.helpers.extractFirstLetter=function(e){var t=latinize(e.toLowerCase()).replace(/[^a-z]/g,"");return 0<t.length?t.substring(0,1):"unknown"};var n=/^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;function i(e){if("BR"===e.tagName)return"\n";var t=[].slice.call(e.childNodes);if(t.length)return t.reverse(),_.reduce(t,function(e,t){var n=i(t);switch(t.tagName){case"OL":case"P":case"UL":/^\n/.test(e)||(e="\n\n"+e),/^\n\n/.test(e)||(e="\n"+e);break;case"ARTICLE":case"ASIDE":case"BLOCKQUOTE":case"DIV":case"H1":case"H2":case"H3":case"H4":case"H5":case"LI":case"P":/^\n/.test(e)||(e="\n"+e)}return n+e},"");var n=e.textContent||e.innerText||"";return"PRE"!==e.tagName&&(n=n.replace(/\r?\n/g,"")),n}function o(e){for(var t=0;t<e.length&&e[t];){var n=e[t];n.parentNode?n.parentNode.removeChild(n):++t}}function r(e,t){var n,i;if(!t)return!1;var o,s=function(e,t){var n,i;for(n=e.parentNode;n;n=n.parentNode)for(i=t.parentNode;i;i=i.parentNode)if(n===i)return n;return!1}(e,t);if(!s)return!1;for(n=e;a(n)&&n!==s;n=n.parentNode){for(i=t;a(i)&&i!==s;i=i.parentNode){if(o=i,n.nextSibling===o)return!0;if(i.previousSibling&&i.parentNode!==s)return!1}if(n.nextSibling&&n.parentNode!==s)return!1}return!1}NelioContent.helpers.isEmail=function(e){return n.test(e)},NelioContent.helpers.processHtml=function(e){var t=_.map(function(e){var t=document.createElement("div");t.innerHTML="<div>"+e+"</div>";var n,i=_.map(t.querySelectorAll("ncshare"));if(!i.length)return[];var o=[],s=0;for(;s<i.length;){for(n=[i[s]],++s;r(i[s-1],i[s]);)n.push(i[s]),++s;o.push(n)}return o}(e),function(e){var t=_.map(e,function(e){return e.textContent}).join(""),n=_.map(e,function(e){if(e.querySelector("a"))return e.innerHTML;var t=function(e){for(var t=e.parentNode;t;t=t.parentNode)if("a"===t.nodeName.toLowerCase())return t.getAttribute("href")||!1;return!1}(e);return t?'<a href="'+_.escape(t)+'">'+e.textContent+"</a>":e.textContent}).join("");return{text:NelioContent.helpers.trim(t),html:NelioContent.helpers.trim(n)}}),n=document.createElement("div");return n.innerHTML=e,o(n.getElementsByTagName("script")),o(n.getElementsByTagName("link")),o(n.getElementsByTagName("figcaption")),o(n.getElementsByTagName("caption")),o(n.getElementsByTagName("img")),o(n.getElementsByTagName("pre")),o(n.getElementsByTagName("style")),o(n.querySelectorAll("li li")),o(_.filter(n.getElementsByTagName("code"),function(e){return!!e.parentNode&&NelioContent.helpers.trim(e.textContent||e.innerText)===NelioContent.helpers.trim(e.parentNode.textContent||e.parentNode.innerText)})),_.each(n.getElementsByTagName("a"),function(e){e.textContent,e.textContent='<a href="'+e.getAttribute("href")+'">'+e.textContent+"</a>"}),{clean:i(n),highlights:_.uniq(t),top:_.union(_.map(n.getElementsByTagName("h1"),function(e){return e.textContent||e.innerText}),_.map(n.getElementsByTagName("h2"),function(e){return e.textContent||e.innerText}),_.map(n.getElementsByTagName("h3"),function(e){return e.textContent||e.innerText}),_.map(n.getElementsByTagName("strong"),function(e){return e.textContent||e.innerText}))}},NelioContent.helpers.htmlToText=function(e){var t=document.createElement("div");t.innerHTML=e;try{return i(t).replace(/\n\+$/,"")}catch(e){return t.textContent||t.innerText}};var s=["#comment","#text","ncshare","a","abbr","acronym","address","b","big","code","del","em","i","ins","mark","q","s","samp","small","span","strike","strong","sub","sup","time","u","var","wbr"];function a(e){return!!e&&_.includes(s,e.nodeName.toLowerCase())}}(),NelioContent.models.ExternalImage=Backbone.Model.extend({defaults:{id:"",source:"",description:"",author:"",authorUrl:"",html:"",urls:!1,selected:!1},initialize:function(){this.listenTo(this,"change:description",this._maybeAppendFullStop),this.listenTo(this,"change:thumbnails",this._stringifySize),this._maybeAppendFullStop(),this._stringifySize()},toggleSelection:function(){var e=this.get("selected");this.set("selected",!e)},_maybeAppendFullStop:function(){var e=this.get("description")||"";e.length?/\.$/.test(e)?this.set("descriptionWithDot",e):/…$/.test(e)?this.set("descriptionWithDot",e):this.set("descriptionWithDot",e+"."):this.set("descriptionWithDot",e)},_stringifySize:function(){var e=(this.get("thumbnails").original||{}).size,t="";if(e){var n=parseInt(Math.floor(Math.log(e)/Math.log(1024)));t=Math.round(e/Math.pow(1024,n),2)+" "+["Bytes","KB","MB","GB","TB"][n]}this.set("size",t)}}),NelioContent.collections.ExternalImages=NelioContent.collections.Collection.extend({model:NelioContent.models.ExternalImage,initialize:function(){this.listenTo(this,"add",this._onAdd),this.listenTo(this,"remove",this._onRemove),this.listenTo(this,"reset",this._onReset)},_onAdd:function(e){this.listenTo(e,"change:selected",this._guaranteeUniqueSelection),this.listenTo(e,"change:selected",this._triggerNewSelection),this.listenTo(e,"destroy",this.remove)},_guaranteeUniqueSelection:function(t){t.get("selected")&&this.each(function(e){e!==t&&e.get("selected")&&e.set("selected",!1)})},_triggerNewSelection:function(e){e.get("selected")?this.trigger("nc:change:selection",e):this.trigger("nc:change:selection")},_onRemove:function(e){this.stopListening(e)},_onReset:function(e,t){_.each(t.previousModels,this._onRemove,this),this.each(this._onAdd,this)}}),NelioContent.views.ExternalImage=Backbone.View.extend({_isLocked:!1,template:NelioContent.helpers.getTemplate("_nc-external-image"),tagName:"li",className:"nc-external-image",events:{click:"_toggleSelection"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change:selected",this.render)},render:function(){var e=this.model.toJSON();return this.el.innerHTML=this.template(e),this.model.get("selected")?this.el.className="nc-external-image details selected":this.el.className="nc-external-image",this},_toggleSelection:function(){this._isLocked||this.model.toggleSelection()},lock:function(){this._isLocked||(this._isLocked=!0)},unlock:function(){this._isLocked&&(this._isLocked=!1)},close:function(){this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.ExternalImages=Backbone.View.extend({_imageViews:[],_isLocked:!1,_rendered:!1,_source:!1,_postId:!1,_query:void 0,template:NelioContent.helpers.getTemplate("_nc-external-images"),detailsTemplate:NelioContent.helpers.getTemplate("_nc-external-image-details"),events:{"change #nc-search-field":"_onSearchChange","keyup #nc-search-field":"_onSearchChange","change .link-to":"_onLinkToChange","click .nc-insert-button":"_onImageSelected"},initialize:function(e){this._source=e.source,this._postId=e.postId,this._query={value:!1,ajax:!1},void 0===this.collection&&(this.collection=new NelioContent.collections.ExternalImages),this.collection.each(function(e){var t=new NelioContent.views.ExternalImage({model:e});this._imageViews.push(t)},this),this.render=_.bind(this.render,this),this._onSearchChange=_.bind(this._onSearchChange,this),this._search=_.debounce(this._search,800),this.listenTo(this.collection,"reset",this._resetImageViews),this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"nc:change:selection",this._onSelectionChange)},render:function(){this._rendered||(this.el.innerHTML=this.template(),this._rendered=!0);var t=this.$(".nc-external-images");return t.children().detach(),_.each(this._imageViews,function(e){t.append(e.render().el)},this),this},_onSelectionChange:function(e){if(!this._isLocked)if(e){var t=e.toJSON();this.$(".nc-image-details-panel").html(this.detailsTemplate(t)),this.$(".nc-insert-button").prop("disabled",!1),this._maybeFixSizeSelectors(t)}else this.$(".nc-insert-button").prop("disabled",!0),this.$(".nc-image-details-panel").empty()},_maybeFixSizeSelectors:function(t){this.$(".size option[data-width]").each(function(){var e=o(this);e.data("width")>t.thumbnails.original.width&&e.hide()}),this.$(".size option[data-height]").each(function(){var e=o(this);e.data("height")>t.thumbnails.original.height&&e.hide()})},_onLinkToChange:function(){if(!this._isLocked){var e=this.$(".link-to").val(),t=this.$(".link-to-custom"),n=this.collection.findWhere({selected:!0}),i="";switch(n&&(i=n.get("url")),e){case"file":t.prop("readonly",!0),t.val(i),i?t.removeClass("hidden"):t.addClass("hidden");break;case"custom":t.prop("readonly",!1),t.val("http://"),t.removeClass("hidden");break;default:t.addClass("hidden")}}},_onImageSelected:function(){if(!this._isLocked){var e=this.collection.findWhere({selected:!0}),t=this._getImageData(e);this._maybeUploadImageToMediaLibrary(t,_.bind(function(e){this.trigger("nc:select:image",e)},this))}},_maybeUploadImageToMediaLibrary:function(t,n){if("unsplash"===this._source&&o.ajax({url:NelioContent.apiUri+"image/unsplash/"+t.id+"/download",method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken},complete:function(){return n(t)}}),"pixabay"!==this._source)return n(t);var e=this,i=this.$(".nc-insert-button").html();this._lock(),this.$(".nc-insert-button").html(NelioContent.i18n.feedback.uploading),o.ajax({url:ajaxurl,data:{action:"nelio_content_upload_attachment",file:t.src,postId:this._postId,desc:t.caption,thumbnail:t.size},success:function(e){t.src=e.url,t.id=e.id,n(t)},error:function(e,t,n){console.log(n)},complete:function(){e.$(".nc-insert-button").html(i),e._unlock()}})},_getImageData:function(e){var t={id:e.id,caption:this.$('[data-setting="caption"] textarea').val()||"",alt:this.$('[data-setting="alt"] input').val()||"",align:this.$(".alignment option:selected").val()||"none",size:this.$(".size option:selected").val()||"large"};if("pixabay"===this._source){if("full"===t.size)t.width=e.get("thumbnails").original.width,t.height=e.get("thumbnails").original.height;else{var n=this.$(".size option:selected");t.width=n.data("width"),t.height=n.data("height")}t.src=e.get("thumbnails").original.image}else t.size=this.$(".size option:selected").val()||"medium",t.width=e.get("thumbnails")[t.size].width,t.height=e.get("thumbnails")[t.size].height,t.src=e.get("thumbnails")[t.size].image;return(t.link="none")!==(this.$(".link-to option:selected").val()||"none")&&(t.link=this.$('[data-setting="linkUrl"]').val()||"none"),t},_onSearchChange:function(){this._isLocked||this._search()},_search:function(){var t,e,n=this.$("#nc-search-field").val(),i=this._source;if(n!==this._query.value){if(this._query.value=n,this._query.ajax&&this._query.ajax.abort(),t="nc-"+i+"-image-search["+NelioContent.wpBlogId+"]["+n+"]",(e=ncstore.get(t))&&e.length)return this.collection.reset(e);this.$(".spinner").css("visibility","visible"),this.$(".nc-no-images-found").hide(),this.$(".nc-insert-button").prop("disabled",!0),this.$(".nc-image-details-panel").empty(),this._query.ajax=o.ajax({url:NelioContent.searchApiUri,method:"GET",data:{q:n,src:i},headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},success:_.bind(function(e){0===e.length&&n.length&&this.$(".nc-no-images-found").show(),this.collection.reset(e),ncstore.set(t,e,(new Date).getTime()+828e5)},this),error:_.bind(function(e){this.collection.trigger("nc:error",e.responseJSON)},this),complete:_.bind(function(){this._query.ajax=!1,this.$(".spinner").css("visibility","hidden")},this)})}},_resetImageViews:function(){_.each(this._imageViews,function(e){e.close()},this),this._imageViews=[],this.collection.each(this._addExternalImage,this)},_addExternalImage:function(e){var t=new NelioContent.views.ExternalImage({model:e});this._imageViews.push(t)},_lock:function(){this._isLocked||(this._isLocked=!0,this.$("*").attr("disabled","disabled"),this.$el.addClass("nc-locked"),_.each(this._imageViews,function(e){e.lock()}))},_unlock:function(){this._isLocked&&(this._isLocked=!1,this.$("*").removeAttr("disabled"),this.$el.removeClass("nc-locked"),_.each(this._imageViews,function(e){e.unlock()}))},close:function(){_.each(this._imageViews,function(e){e.close()},this),this._imageViews=[],this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}});var t=new NelioContent.views.ExternalImages({el:document.getElementById("nc_media_container"),source:document.getElementById("nc_current_media_tab").getAttribute("value"),postId:window.parent.jQuery("#post_ID").val()});t.render(),Backbone.listenTo(t,"nc:select:image",function(e){var t,n,i,o=e.id||"";e.width&&(n='width="'+e.width+'"'),e.height&&(i='height="'+e.height+'"'),t='<img class="size-'+e.size+" wp-image-"+o+'" alt="'+e.alt+'" src="'+e.src+'" '+n+" "+i+" />","none"!==e.link&&(t='<a href="'+e.link+'">'+t+"</a>"),e.caption&&e.caption.length&&(t='[caption id="attachment_'+o+'" align="align'+e.align+'" '+n+"]"+t+" "+e.caption+"[/caption]"),parent.tinyMCE&&parent.tinyMCE.activeEditor&&!parent.tinyMCE.activeEditor.isHidden()?parent.tinyMCE.activeEditor.selection.setContent(t):parent.QTags&&parent.QTags.insertContent(t),parent.wp.media.frame.close()})}(jQuery);