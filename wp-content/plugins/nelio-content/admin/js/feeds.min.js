!function(s){"use strict";NelioContent.views.PostEditor=Backbone.View.extend({_views:{author:void 0},_suggestedReference:"",_firstEditorialComment:"",_isDatePickerReady:!1,_buttons:void 0,_labels:void 0,_regex:{url:/^(https?:\/\/)?([\da-z\.-]+)\.([a-z]{2,6})(\/[^\/\s]+)*\/?$/i,date:/[12][0-9][0-9][0-9]-[01][0-9]-[0-3][0-9]/,time:/[012][0-9]:[0-5][0-9]/},_originalValues:void 0,model:NelioContent.models.Post,template:NelioContent.helpers.getTemplate("_nc-post-editor"),events:{"change .nc-title":"_onTitleChange","keyup .nc-title":"_onTitleChange","click  .nc-date .nc-value":"_maybeInitDatePicker","change .nc-date":"_onDateChange","change .nc-time":"_onTimeChange","change .nc-post-type":"_onPostTypeChange","keyup .nc-post-type":"_onPostTypeChange","click .nc-toggle-editor-visibility":"_toggleEditorInformationVisibility","change .nc-suggested-reference input":"_onSuggestedReferenceChange","keyup .nc-suggested-reference input":"_onSuggestedReferenceChange","change .nc-initial-comment textarea":"_onFirstEditorialCommentChange","keyup .nc-initial-comment textarea":"_onFirstEditorialCommentChange"},initialize:function(e){if("object"!=typeof e&&(e={}),"string"!=typeof e.date&&(e.date=ncNewLocalMoment().format("YYYY-MM-DD")),"string"==typeof e.suggestedReference&&e.suggestedReference.length&&(this._suggestedReference=e.suggestedReference),this.render=_.bind(this.render,this),this._onDialogSave=_.bind(this._onDialogSave,this),this._onDialogCancel=_.bind(this._onDialogCancel,this),this._onDialogDelete=_.bind(this._onDialogDelete,this),this._onDialogViewPost=_.bind(this._onDialogViewPost,this),this._onDialogEditPost=_.bind(this._onDialogEditPost,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change:type",this._updateLabels),this._updateLabels(),0===this.model.get("id"))this.model.set("author",NelioContent.users.current().get("id")),this.model.set("localDate",e.date),this.model.set("localTime",ncstore.get("nc-default-post-time["+NelioContent.wpBlogId+"]","10:00")),this.listenTo(this.model,"change",this._maybeEnableSaveButton),this.listenTo(this,"nc:change:suggestedReference",this._maybeEnableSaveButton),this.listenTo(this,"nc:change:firstEditorialComment",this._maybeEnableSaveButton);else{var t=this.model.get("date");t?(this.model.set("localDate",t.format("YYYY-MM-DD")),this.model.set("localTime",t.format("HH:mm"))):(this.model.set("localDate",""),this.model.set("localTime","")),this._originalValues={title:this.model.get("title"),author:this.model.get("author"),date:this.model.get("localDate"),time:this.model.get("localTime")},this.listenTo(this.model,"change",this._showProperButtonSet),this.listenTo(this.model,"change",this._maybeEnableSaveButton)}this._views.author=new NelioContent.views.UserSelector({defaultValue:this.model.get("author")}),this.listenTo(this._views.author,"nc:change",this._onAuthorChange),this.listenTo(this,"nc:close:dialog",this.close),this._convertToDialog()},render:function(){var e=this.$(".nc-date .nc-value");"date"!==e.prop("type")&&(e.datepicker("destroy"),this._isDatePickerReady=!1);var t=this.model.toJSON();t.isEditorInformationVisible=ncstore.get("nc-is-calendar-editor-info-visible["+NelioContent.wpBlogId+"]",!1),t.suggestedReference=this._suggestedReference,t.editorialComment=this._firstEditorialComment,t.today=ncNewLocalMoment().format("YYYY-MM-DD"),this._views.author.$el.detach(),this.el.innerHTML=this.template(t),"post"===t.type?this.$(".nc-post-type").val("post:"+t.categories[0]):this.$(".nc-post-type").val(t.type),this.$el.dialogS2("open"),this.$(".nc-author .nc-field").html(this._views.author.render().$el),this._views.author.$el.trigger("change");var i=NelioContent.users.current().get("role");return"administrator"===i||"editor"===i?this._views.author.unlock():this._views.author.lock(),this._maybeEnableSaveButton(),this},_lock:function(){this.$("*").attr("disabled","disabled"),this.$el.addClass("nc-locked")},_unlock:function(){this.$("*").removeAttr("disabled"),this.$el.removeClass("nc-locked")},_convertToDialog:function(){var e=[];0===this.model.get("id")?(e.push(NelioContent.helpers.makeDialogCancelButton(this,NelioContent.i18n.actions.cancel)),e.push(NelioContent.helpers.makeDialogSaveButton(this,this._labels.addAction))):(e.push(NelioContent.helpers.makeDialogDeleteButton(this,NelioContent.i18n.actions.trash)),e.push(NelioContent.helpers.makeDialogButton(this,"close",NelioContent.i18n.actions.close)),e.push(NelioContent.helpers.makeDialogButton(this,"view",this._labels.viewAction)),e.push(NelioContent.helpers.makeDialogButton(this,"edit",this._labels.editAction,!0)),e.push(NelioContent.helpers.makeDialogCancelButton(this,NelioContent.i18n.actions.cancel)),e.push(NelioContent.helpers.makeDialogSaveButton(this,NelioContent.i18n.actions.saveChanges)));var i=this;this.$el.dialogS2({title:0<this.model.get("id")?this._labels.editTitle:this._labels.addTitle,autoOpen:!1,buttons:e,dialogClass:"nc-dialog nc-post-editor-dialog",draggable:!1,modal:!0,resizable:!1,width:"95%",position:{my:"center top",at:"center top+60"},open:function(){i.listenTo(i,"nc:click:dialog:save",i._onDialogSave),i.listenTo(i,"nc:click:dialog:cancel",i._onDialogCancel),i.listenTo(i,"nc:click:dialog:delete",i._onDialogDelete),i.listenTo(i,"nc:click:dialog:close",i._onDialogCancel),i.listenTo(i,"nc:click:dialog:view",i._onDialogViewPost),i.listenTo(i,"nc:click:dialog:edit",i._onDialogEditPost),i._buttons=i._buttons||{},i._buttons.edit=i.$el.parent().find("button.nc-edit-button"),i._buttons.view=i.$el.parent().find("button.nc-view-button"),i._buttons.close=i.$el.parent().find("button.nc-close-button"),i._buttons.cancel=i.$el.parent().find("button.nc-cancel-button"),i._buttons.save=i.$el.parent().find("button.nc-save-button"),NelioContent.helpers.makeWarningTooltip(i._buttons.save),0<i.model.get("id")&&(i._buttons.cancel.hide(),i._buttons.save.hide());var e=i.$el.parent().find("button.nc-delete-button");0<e.length&&e.blur()},close:function(e,t){i.stopListening(i,"nc:click:dialog:save",i._onDialogSave),i.stopListening(i,"nc:click:dialog:cancel",i._onDialogCancel),i.stopListening(i,"nc:click:dialog:delete",i._onDialogDelete),i._buttons.save.tooltip("destroy"),i.$el.dialogS2("destroy"),i.trigger("nc:close:dialog")}}),this.listenTo(this,"nc:change:labels",this._renderLabels)},_showProperButtonSet:function(){var e=!1;(e=(e=(e=(e=(e=e||this.model.get("author")!==this._originalValues.author)||this.model.get("title")!==this._originalValues.title)||this.model.get("author")!==this._originalValues.author)||this.model.get("localDate")!==this._originalValues.date)||this.model.get("localTime")!==this._originalValues.time)?(this._buttons.edit.hide(),this._buttons.view.hide(),this._buttons.close.hide(),this._buttons.cancel.show(),this._buttons.save.show()):(this._buttons.edit.show(),this._buttons.view.show(),this._buttons.close.show(),this._buttons.cancel.hide(),this._buttons.save.hide())},_maybeEnableSaveButton:function(){if(void 0!==this._buttons.save){if(this._buttons.save.tooltip("close"),0===NelioContent.helpers.trim(this.model.get("title")).length)return this._buttons.save.addClass("button-disabled"),void this._buttons.save.attr("title",NelioContent.i18n.errors.post.noTitle);if(NelioContent.helpers.trim(this.model.get("localDate")).length&&!this._regex.date.test(this.model.get("localDate")))return this._buttons.save.addClass("button-disabled"),void this._buttons.save.attr("title",NelioContent.i18n.errors.datetime.invalidDate);if(NelioContent.helpers.trim(this.model.get("localDate")).length&&0===NelioContent.helpers.trim(this.model.get("localTime")).length)return this._buttons.save.addClass("button-disabled"),void this._buttons.save.attr("title",NelioContent.i18n.errors.datetime.noTime);if(NelioContent.helpers.trim(this.model.get("localDate")).length&&!this._regex.time.test(this.model.get("localTime")))return this._buttons.save.addClass("button-disabled"),void this._buttons.save.attr("title",NelioContent.i18n.errors.datetime.invalidTime);if(0<this._suggestedReference.length&&!this._regex.url.test(this._suggestedReference))return this._buttons.save.addClass("button-disabled"),void this._buttons.save.attr("title",NelioContent.i18n.errors.post.invalidUrl);this._buttons.save.removeClass("button-disabled"),this._buttons.save.attr("title","")}},_updateLabels:function(){var i=this.model.get("type"),e=_.reduce(NelioContent.postTypes,function(e,t){return i===t.name?t:e});this._labels=e.labels,this.trigger("nc:change:labels")},_renderLabels:function(){var e=this.$el.parent();e.find(".ui-dialog-buttonpane button.nc-save-button").html(this._labels.addAction),e.find(".ui-dialog-buttonpane button.nc-view-button").html(this._labels.viewAction),e.find(".ui-dialog-titlebar .ui-dialog-title").html(this._labels.addTitle)},_onTitleChange:function(e){var t=e.target||e.srcElement,i=s(t);this.model.set("title",NelioContent.helpers.trim(i.val()))},_onPostTypeChange:function(e){var t=e.target||e.srcElement,i=s(t).val();0===i.indexOf("post:")?(i=i.split(":"),this.model.set("type",i[0]),this.model.set("categories",[parseInt(i[1])])):(this.model.set("type",i),this.model.set("categories",[]))},_onAuthorChange:function(e){this.model.set("author",parseInt(e))},_onDateChange:function(e){var t=e.target||e.srcElement,i=s(t);this.model.set("localDate",NelioContent.helpers.trim(i.val()))},_onTimeChange:function(e){var t=e.target||e.srcElement,i=s(t);this.model.set("localTime",NelioContent.helpers.trim(i.val()))},_onSuggestedReferenceChange:function(e){var t=e.target||e.srcElement,i=s(t);this._suggestedReference=i.val(),this.trigger("nc:change:suggestedReference",this._suggestedReference)},_onFirstEditorialCommentChange:function(e){var t=e.target||e.srcElement,i=s(t);this._firstEditorialComment=i.val(),this.trigger("nc:change:firstEditorialComment",this._firstEditorialComment)},_toggleEditorInformationVisibility:function(){var e=ncstore.get("nc-is-calendar-editor-info-visible["+NelioContent.wpBlogId+"]",!1);ncstore.set("nc-is-calendar-editor-info-visible["+NelioContent.wpBlogId+"]",!e),this.trigger("nc:render")},_onDialogSave:function(){var e=this.$el.parent(),t=e.find(".ui-dialog-buttonpane button.nc-save-button"),i=e.find(".ui-dialog-titlebar button, .ui-dialog-buttonpane button:not( .nc-save-button )");if(!t.hasClass("button-disabled")){this._lock(),this.$el.dialogS2("option","closeOnEscape",!1),t.prop("disabled",!0),i.prop("disabled",!0),0===this.model.get("id")?t.html(NelioContent.i18n.feedback.creating):t.html(NelioContent.i18n.feedback.saving);var n={title:this.model.get("title"),author:this.model.get("author"),postType:this.model.get("type"),localDatetime:""};NelioContent.helpers.trim(this.model.get("localDate")).length&&(n.localDatetime=this.model.get("localDate")+" "+this.model.get("localTime")),this.model.get("categories").length&&(n.postCategory=this.model.get("categories")[0]),0===this.model.get("id")?(n.action="nelio_content_create_post_in_calendar",n.reference=NelioContent.helpers.trim(this._suggestedReference),n.comment=NelioContent.helpers.trim(this._firstEditorialComment)):(n.action="nelio_content_update_post_in_calendar",n.post=this.model.get("id"));var o=this;s.ajax({url:ajaxurl,method:"POST",data:n,success:function(e){if("object"==typeof e){var t=new NelioContent.models.Post(e);o.model.set(t.toJSON())}ncstore.set("nc-default-post-time["+NelioContent.wpBlogId+"]",o.model.get("localTime")),o.trigger("nc:save:post",o.model),o.$el.dialogS2("close")},error:function(e){NelioContent.helpers.openErrorDialog(e.responseJSON),t.prop("disabled",!1),i.prop("disabled",!1),0===o.model.get("id")?t.html(o._labels.addAction):t.html(NelioContent.i18n.actions.save),o.$el.dialogS2("option","closeOnEscape",!0),o._unlock()}})}},_onDialogCancel:function(){this.$el.dialogS2("close")},_onDialogDelete:function(){var t=this,e=NelioContent.i18n.titles.trashPost,i=NelioContent.i18n.dialogs.trashPost,n=NelioContent.i18n.actions.doTrashPost;"post"!==this.model.get("type")&&(e=NelioContent.i18n.titles.trashElement,i=NelioContent.i18n.dialogs.trashElement,n=NelioContent.i18n.actions.doTrashElement);var o=NelioContent.helpers.openDeletionConfirmationDialog(e,i,n,function(){var e=o.parent();e.find(".nc-super-delete-button").html(NelioContent.i18n.feedback.trashing),e.find("button").prop("disabled",!0),t.listenTo(t.model,"nc:trash",function(){o.dialog("destroy"),t.trigger("nc:trash:post"),t.$el.dialogS2("close")}),t.model.trash()})},_onDialogViewPost:function(e){e.ctrlKey||2===e.which?window.open(this.model.get("permalink")):window.document.location.href=this.model.get("permalink")},_onDialogEditPost:function(e){e.ctrlKey||2===e.which?window.open(this.model.get("editLink")):window.document.location.href=this.model.get("editLink")},_maybeInitDatePicker:function(e){var t=this.$(".nc-date .nc-value");this._isDatePickerReady||"date"===t.prop("type")||(t.datepicker({dateFormat:"yy-mm-dd",minDate:0}),t.datepicker("show")),this._isDatePickerReady=!0},close:function(){_.each(_.values(this._views),function(e){"object"==typeof e&&"function"==typeof e.close&&e.close()}),this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.models.FeedItem=Backbone.Model.extend({defaults:function(){return{title:"",permalink:"",categories:[],author:"",date:!1,feed:{}}},initialize:function(){this.listenTo(this,"change:content",this._extractTextFromContent),this._extractTextFromContent()},_extractTextFromContent:function(){var e=document.createElement("div");document.body.appendChild(e),e.innerHTML=this.get("content");var t=e.innerText;280<t.length&&(t=t.substring(0,280)+"…"),document.body.removeChild(e),this.stopListening(this,"change:content",this._extractTextFromContent),this.set("content",t),this.listenTo(this,"change:content",this._extractTextFromContent)}}),NelioContent.collections.FeedItems=NelioContent.collections.Collection.extend({_isLoading:!1,_totalItems:0,_feedFilter:"all",model:NelioContent.models.FeedItem,initialize:function(){this.listenTo(this,"add",this._onAdd),this.listenTo(this,"remove",this._onRemove),this.listenTo(this,"reset",this._onReset)},load:function(t){this._isLoading=!0,this.trigger("nc:change:isLoading");var e={action:"nelio_content_get_feed_items",start:t||0,feed:this._feedFilter},i=this;s.ajax({url:ajaxurl,data:e,success:function(e){i._isLoading=!1,i._totalItems=e.total,t?i.add(e.items):i.reset(e.items)},error:function(e){i.trigger("nc:error",e.responseJSON),i._isLoading=!1,i.trigger("nc:change:isLoading")}})},loadMore:function(){if(!this._isLoading){var e=this.length+1;e>=this._totalItems||this.load(e)}},isLoading:function(){return this._isLoading},setFeedFilter:function(e){void 0===e&&(e="all"),e!==this._feedFilter&&(this.reset(),this._feedFilter=e,this.load())},_triggerModelChange:function(e){this.trigger("nc:change:model",this,e)},_onAdd:function(e){this.listenTo(e,"change",this._triggerModelChange),this.listenTo(e,"destroy",this.remove)},_onRemove:function(e){this.stopListening(e)},_onReset:function(e,t){_.each(t.previousModels,this._onRemove,this),this.each(this._onAdd,this)}}),NelioContent.views.FeedItems=Backbone.View.extend({_feedItemViews:[],rendered:!1,template:NelioContent.helpers.getTemplate("_nc-feed-items"),feedTemplate:NelioContent.helpers.template('<div class="nc-feed-filter-result"><div class="nc-feed-filter-image"><div class="nc-actual-feed-item-image"[* if ( icon && icon.length ) { *] style="background: white url( [*~ icon *] ) center/cover;"[* } *]></div></div><div class="nc-feed-filter-data"><div class="nc-feed-filter-text">[*~ text *]</div><div class="nc-feed-filter-url">[*~ url *]</div></div></div>'),events:{"change .nc-feed-filter":"_onFeedFilterChange"},initialize:function(){void 0===this.collection&&(this.collection=new NelioContent.collections.FeedItems),this.collection.each(function(e){var t=new NelioContent.views.FeedItem({model:e});this._feedItemViews.push(t)},this),this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.collection,"add",this._addFeedItem),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this._removeFeedItem),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection,"reset",this._resetFeedItemViews),this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"nc:change:isLoading",this.render),this.listenTo(this.collection,"nc:error",this.render),this.listenTo(this.collection,"change:completed",this.render)},render:function(){var t;return this.rendered||(this.rendered=!0,this.el.innerHTML=this.template()),this.collection.isLoading()?(this.$("span.spinner").addClass("is-active"),this.$(".nc-loading-more").show()):(this.$("span.spinner").removeClass("is-active"),this.$(".nc-loading-more").hide()),(t=this.$(".nc-feed-items")).children().detach(),_.each(this._feedItemViews,function(e){t.append(e.render().el)},this),this.collection.isLoading()||this.collection.length?this.$(".nc-feed-items-none").hide():this.$(".nc-feed-items-none").show(),this.$("select.nc-feed-filter").ncselect2({width:"20em",dropdownCssClass:"nc-feed-selector-dropdown",templateResult:_.bind(this._templateFeedResult,this)}),this},_templateFeedResult:function(e){var t=e.text.trim();return e.id&&"all"!==e.id&&(t=s(this.feedTemplate({text:e.text.trim(),url:e.id.trim(),icon:e.element.getAttribute("data-icon")}))),t},_onFeedFilterChange:function(){var e=this.$(".nc-feed-filter").val();this.collection.setFeedFilter(e)},_resetFeedItemViews:function(){_.each(this._feedItemViews,function(e){e.close()},this),this._feedItemViews=[],this.collection.each(this._addFeedItem,this)},_addFeedItem:function(e){var t=new NelioContent.views.FeedItem({model:e});this._feedItemViews.push(t)},_removeFeedItem:function(t){var e,i;0<(i=_.filter(this._feedItemViews,function(e){return e.model===t},this)).length&&(e=i[0],this._feedItemViews=_.without(this._feedItemViews,e),e.close())},close:function(){_.each(this._feedItemViews,function(e){e.close()},this),this._feedItemViews=[],this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.FeedItem=Backbone.View.extend({template:NelioContent.helpers.getTemplate("_nc-feed-item"),events:{"click .nc-share button":"_addSocial","click .nc-write button":"_addPost"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change:completed",this.render)},render:function(){var e=this.model.toJSON();ncstore.removeExpiredKeys();var t=ncstore.get("nc-is-feed-shared["+NelioContent.wpBlogId+"]["+e.id+"]"),i=ncstore.get("nc-has-feed-post["+NelioContent.wpBlogId+"]["+e.id+"]");return e.actionPerformed=i&&t?"nc-shared-and-posted":i?"nc-posted":t?"nc-shared":"",this.el.innerHTML=this.template(e),this},_addSocial:function(){if(0!==NelioContent.profiles.length){var e=new NelioContent.models.SocialMessage;e.set("profileId",NelioContent.profiles.at(0).get("id")),e.set("text",this.model.get("title")+" "+this.model.get("permalink")),e.set("dateType","predefined-offset"),e.set("dateValue","0"),e.set("timeType","predefined-offset"),e.set("timeValue","0");var t=new NelioContent.views.SocialMessageEditor({model:e}),i=this;this.listenTo(t,"nc:add:messages",function(){var e=(new Date).getTime()+2592e6;ncstore.set("nc-is-feed-shared["+NelioContent.wpBlogId+"]["+i.model.get("id")+"]",!0,e),i.render()}),this.listenTo(t,"nc:close:dialog",function(){i.stopListening(t)}),t.render()}else this._openNoProfilesDialog()},_addPost:function(){ncstore.set("nc-is-calendar-editor-info-visible["+NelioContent.wpBlogId+"]",!0);var e=new NelioContent.models.Post;e.set("title",this.model.get("title"));var t=new NelioContent.views.PostEditor({model:e,date:void 0,suggestedReference:this.model.get("permalink")}),i=this;this.listenTo(t,"nc:save:post",function(){var e=(new Date).getTime()+2592e6;ncstore.set("nc-has-feed-post["+NelioContent.wpBlogId+"]["+i.model.get("id")+"]",!0,e),i.render()}),this.listenTo(t,"nc:close:dialog",function(){i.stopListening(t)}),t.render()},close:function(){this.stopListening(),this.unbind(),void 0!==this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}});var e=new NelioContent.views.FeedItems({el:s(".nc-feeds-page-container")});e.collection.load(),s(window).on("scroll",function(){s(window).scrollTop()>=s(document).height()-s(window).height()&&e.collection.loadMore()})}(jQuery);